(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){(function(process){exports=module.exports=require("./debug");exports.log=log;exports.formatArgs=formatArgs;exports.save=save;exports.load=load;exports.useColors=useColors;exports.storage="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:localstorage();exports.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"];function useColors(){if(typeof window!=="undefined"&&window.process&&window.process.type==="renderer"){return true}return typeof document!=="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!=="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!=="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}exports.formatters.j=function(v){try{return JSON.stringify(v)}catch(err){return"[UnexpectedJSONParseError]: "+err.message}};function formatArgs(args){var useColors=this.useColors;args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff);if(!useColors)return;var c="color: "+this.color;args.splice(1,0,c,"color: inherit");var index=0;var lastC=0;args[0].replace(/%[a-zA-Z%]/g,function(match){if("%%"===match)return;index++;if("%c"===match){lastC=index}});args.splice(lastC,0,c)}function log(){return"object"===typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function save(namespaces){try{if(null==namespaces){exports.storage.removeItem("debug")}else{exports.storage.debug=namespaces}}catch(e){}}function load(){var r;try{r=exports.storage.debug}catch(e){}if(!r&&typeof process!=="undefined"&&"env"in process){r=process.env.DEBUG}return r}exports.enable(load());function localstorage(){try{return window.localStorage}catch(e){}}}).call(this,require("_process"))},{"./debug":2,_process:114}],2:[function(require,module,exports){exports=module.exports=createDebug.debug=createDebug["default"]=createDebug;exports.coerce=coerce;exports.disable=disable;exports.enable=enable;exports.enabled=enabled;exports.humanize=require("ms");exports.names=[];exports.skips=[];exports.formatters={};var prevTime;function selectColor(namespace){var hash=0,i;for(i in namespace){hash=(hash<<5)-hash+namespace.charCodeAt(i);hash|=0}return exports.colors[Math.abs(hash)%exports.colors.length]}function createDebug(namespace){function debug(){if(!debug.enabled)return;var self=debug;var curr=+new Date;var ms=curr-(prevTime||curr);self.diff=ms;self.prev=prevTime;self.curr=curr;prevTime=curr;var args=new Array(arguments.length);for(var i=0;i<args.length;i++){args[i]=arguments[i]}args[0]=exports.coerce(args[0]);if("string"!==typeof args[0]){args.unshift("%O")}var index=0;args[0]=args[0].replace(/%([a-zA-Z%])/g,function(match,format){if(match==="%%")return match;index++;var formatter=exports.formatters[format];if("function"===typeof formatter){var val=args[index];match=formatter.call(self,val);args.splice(index,1);index--}return match});exports.formatArgs.call(self,args);var logFn=debug.log||exports.log||console.log.bind(console);logFn.apply(self,args)}debug.namespace=namespace;debug.enabled=exports.enabled(namespace);debug.useColors=exports.useColors();debug.color=selectColor(namespace);if("function"===typeof exports.init){exports.init(debug)}return debug}function enable(namespaces){exports.save(namespaces);exports.names=[];exports.skips=[];var split=(typeof namespaces==="string"?namespaces:"").split(/[\s,]+/);var len=split.length;for(var i=0;i<len;i++){if(!split[i])continue;namespaces=split[i].replace(/\*/g,".*?");if(namespaces[0]==="-"){exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$"))}else{exports.names.push(new RegExp("^"+namespaces+"$"))}}}function disable(){exports.enable("")}function enabled(name){var i,len;for(i=0,len=exports.skips.length;i<len;i++){if(exports.skips[i].test(name)){return false}}for(i=0,len=exports.names.length;i<len;i++){if(exports.names[i].test(name)){return true}}return false}function coerce(val){if(val instanceof Error)return val.stack||val.message;return val}},{ms:21}],3:[function(require,module,exports){"use strict";var normalice=require("normalice");var freeice=module.exports=function(opts){var servers={stun:(opts||{}).stun||require("./stun.json"),turn:(opts||{}).turn||require("./turn.json")};var stunCount=(opts||{}).stunCount||2;var turnCount=(opts||{}).turnCount||0;var selected;function getServers(type,count){var out=[];var input=[].concat(servers[type]);var idx;while(input.length&&out.length<count){idx=Math.random()*input.length|0;out=out.concat(input.splice(idx,1))}return out.map(function(url){if(typeof url!=="string"&&!(url instanceof String)){return url}else{return normalice(type+":"+url)}})}selected=[].concat(getServers("stun",stunCount));if(turnCount){selected=selected.concat(getServers("turn",turnCount))}return selected}},{"./stun.json":4,"./turn.json":5,normalice:22}],4:[function(require,module,exports){module.exports=["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302","stun.ekiga.net","stun.ideasip.com","stun.schlund.de","stun.stunprotocol.org:3478","stun.voiparound.com","stun.voipbuster.com","stun.voipstunt.com","stun.voxgratia.org","stun.services.mozilla.com"]},{}],5:[function(require,module,exports){module.exports=[]},{}],6:[function(require,module,exports){var WildEmitter=require("wildemitter");function getMaxVolume(analyser,fftBins){var maxVolume=-Infinity;analyser.getFloatFrequencyData(fftBins);for(var i=4,ii=fftBins.length;i<ii;i++){if(fftBins[i]>maxVolume&&fftBins[i]<0){maxVolume=fftBins[i]}}return maxVolume}var audioContextType=window.AudioContext||window.webkitAudioContext;var audioContext=null;module.exports=function(stream,options){var harker=new WildEmitter;if(!audioContextType)return harker;var options=options||{},smoothing=options.smoothing||.1,interval=options.interval||50,threshold=options.threshold,play=options.play,history=options.history||10,running=true;if(!audioContext){audioContext=new audioContextType}var sourceNode,fftBins,analyser;analyser=audioContext.createAnalyser();analyser.fftSize=512;analyser.smoothingTimeConstant=smoothing;fftBins=new Float32Array(analyser.fftSize);if(stream.jquery)stream=stream[0];if(stream instanceof HTMLAudioElement||stream instanceof HTMLVideoElement){sourceNode=audioContext.createMediaElementSource(stream);if(typeof play==="undefined")play=true;threshold=threshold||-50}else{sourceNode=audioContext.createMediaStreamSource(stream);threshold=threshold||-50}sourceNode.connect(analyser);if(play)analyser.connect(audioContext.destination);harker.speaking=false;harker.setThreshold=function(t){threshold=t};harker.setInterval=function(i){interval=i};harker.stop=function(){running=false;harker.emit("volume_change",-100,threshold);if(harker.speaking){harker.speaking=false;harker.emit("stopped_speaking")}};harker.speakingHistory=[];for(var i=0;i<history;i++){harker.speakingHistory.push(0)}var looper=function(){setTimeout(function(){if(!running){return}var currentVolume=getMaxVolume(analyser,fftBins);harker.emit("volume_change",currentVolume,threshold);var history=0;if(currentVolume>threshold&&!harker.speaking){for(var i=harker.speakingHistory.length-3;i<harker.speakingHistory.length;i++){history+=harker.speakingHistory[i]}if(history>=2){harker.speaking=true;harker.emit("speaking")}}else if(currentVolume<threshold&&harker.speaking){for(var i=0;i<harker.speakingHistory.length;i++){history+=harker.speakingHistory[i]}if(history==0){harker.speaking=false;harker.emit("stopped_speaking")}}harker.speakingHistory.shift();harker.speakingHistory.push(0+(currentVolume>threshold));looper()},interval)};looper();return harker}},{wildemitter:101}],7:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],8:[function(require,module,exports){(function(global){(function(){var isLoader=typeof define==="function"&&define.amd;var objectTypes={function:true,object:true};var freeExports=objectTypes[typeof exports]&&exports&&!exports.nodeType&&exports;var root=objectTypes[typeof window]&&window||this,freeGlobal=freeExports&&objectTypes[typeof module]&&module&&!module.nodeType&&typeof global=="object"&&global;if(freeGlobal&&(freeGlobal["global"]===freeGlobal||freeGlobal["window"]===freeGlobal||freeGlobal["self"]===freeGlobal)){root=freeGlobal}function runInContext(context,exports){context||(context=root["Object"]());exports||(exports=root["Object"]());var Number=context["Number"]||root["Number"],String=context["String"]||root["String"],Object=context["Object"]||root["Object"],Date=context["Date"]||root["Date"],SyntaxError=context["SyntaxError"]||root["SyntaxError"],TypeError=context["TypeError"]||root["TypeError"],Math=context["Math"]||root["Math"],nativeJSON=context["JSON"]||root["JSON"];if(typeof nativeJSON=="object"&&nativeJSON){exports.stringify=nativeJSON.stringify;exports.parse=nativeJSON.parse}var objectProto=Object.prototype,getClass=objectProto.toString,isProperty,forEach,undef;var isExtended=new Date(-0xc782b5b800cec);try{isExtended=isExtended.getUTCFullYear()==-109252&&isExtended.getUTCMonth()===0&&isExtended.getUTCDate()===1&&isExtended.getUTCHours()==10&&isExtended.getUTCMinutes()==37&&isExtended.getUTCSeconds()==6&&isExtended.getUTCMilliseconds()==708}catch(exception){}function has(name){if(has[name]!==undef){return has[name]}var isSupported;if(name=="bug-string-char-index"){isSupported="a"[0]!="a"}else if(name=="json"){isSupported=has("json-stringify")&&has("json-parse")}else{var value,serialized='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if(name=="json-stringify"){var stringify=exports.stringify,stringifySupported=typeof stringify=="function"&&isExtended;if(stringifySupported){(value=function(){return 1}).toJSON=value;try{stringifySupported=stringify(0)==="0"&&stringify(new Number)==="0"&&stringify(new String)=='""'&&stringify(getClass)===undef&&stringify(undef)===undef&&stringify()===undef&&stringify(value)==="1"&&stringify([value])=="[1]"&&stringify([undef])=="[null]"&&stringify(null)=="null"&&stringify([undef,getClass,null])=="[null,null,null]"&&stringify({a:[value,true,false,null,"\0\b\n\f\r\t"]})==serialized&&stringify(null,value)==="1"&&stringify([1,2],null,1)=="[\n 1,\n 2\n]"&&stringify(new Date(-864e13))=='"-271821-04-20T00:00:00.000Z"'&&stringify(new Date(864e13))=='"+275760-09-13T00:00:00.000Z"'&&stringify(new Date(-621987552e5))=='"-000001-01-01T00:00:00.000Z"'&&stringify(new Date(-1))=='"1969-12-31T23:59:59.999Z"'}catch(exception){stringifySupported=false}}isSupported=stringifySupported}if(name=="json-parse"){var parse=exports.parse;if(typeof parse=="function"){try{if(parse("0")===0&&!parse(false)){value=parse(serialized);var parseSupported=value["a"].length==5&&value["a"][0]===1;if(parseSupported){try{parseSupported=!parse('"\t"')}catch(exception){}if(parseSupported){try{parseSupported=parse("01")!==1}catch(exception){}}if(parseSupported){try{parseSupported=parse("1.")!==1}catch(exception){}}}}}catch(exception){parseSupported=false}}isSupported=parseSupported}}return has[name]=!!isSupported}if(!has("json")){var functionClass="[object Function]",dateClass="[object Date]",numberClass="[object Number]",stringClass="[object String]",arrayClass="[object Array]",booleanClass="[object Boolean]";var charIndexBuggy=has("bug-string-char-index");if(!isExtended){var floor=Math.floor;var Months=[0,31,59,90,120,151,181,212,243,273,304,334];var getDay=function(year,month){return Months[month]+365*(year-1970)+floor((year-1969+(month=+(month>1)))/4)-floor((year-1901+month)/100)+floor((year-1601+month)/400)}}if(!(isProperty=objectProto.hasOwnProperty)){isProperty=function(property){var members={},constructor;if((members.__proto__=null,members.__proto__={toString:1},members).toString!=getClass){isProperty=function(property){var original=this.__proto__,result=property in(this.__proto__=null,this);this.__proto__=original;return result}}else{constructor=members.constructor;isProperty=function(property){var parent=(this.constructor||constructor).prototype;return property in this&&!(property in parent&&this[property]===parent[property])}}members=null;return isProperty.call(this,property)}}forEach=function(object,callback){var size=0,Properties,members,property;(Properties=function(){this.valueOf=0}).prototype.valueOf=0;members=new Properties;for(property in members){if(isProperty.call(members,property)){size++}}Properties=members=null;if(!size){members=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"];forEach=function(object,callback){var isFunction=getClass.call(object)==functionClass,property,length;var hasProperty=!isFunction&&typeof object.constructor!="function"&&objectTypes[typeof object.hasOwnProperty]&&object.hasOwnProperty||isProperty;for(property in object){if(!(isFunction&&property=="prototype")&&hasProperty.call(object,property)){callback(property)}}for(length=members.length;property=members[--length];hasProperty.call(object,property)&&callback(property));}}else if(size==2){forEach=function(object,callback){var members={},isFunction=getClass.call(object)==functionClass,property;for(property in object){if(!(isFunction&&property=="prototype")&&!isProperty.call(members,property)&&(members[property]=1)&&isProperty.call(object,property)){callback(property)}}}}else{forEach=function(object,callback){var isFunction=getClass.call(object)==functionClass,property,isConstructor;for(property in object){if(!(isFunction&&property=="prototype")&&isProperty.call(object,property)&&!(isConstructor=property==="constructor")){callback(property)}}if(isConstructor||isProperty.call(object,property="constructor")){callback(property)}}}return forEach(object,callback)};if(!has("json-stringify")){var Escapes={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"};var leadingZeroes="000000";var toPaddedString=function(width,value){return(leadingZeroes+(value||0)).slice(-width)};var unicodePrefix="\\u00";var quote=function(value){var result='"',index=0,length=value.length,useCharIndex=!charIndexBuggy||length>10;var symbols=useCharIndex&&(charIndexBuggy?value.split(""):value);for(;index<length;index++){var charCode=value.charCodeAt(index);switch(charCode){case 8:case 9:case 10:case 12:case 13:case 34:case 92:result+=Escapes[charCode];break;default:if(charCode<32){result+=unicodePrefix+toPaddedString(2,charCode.toString(16));break}result+=useCharIndex?symbols[index]:value.charAt(index)}}return result+'"'};var serialize=function(property,object,callback,properties,whitespace,indentation,stack){var value,className,year,month,date,time,hours,minutes,seconds,milliseconds,results,element,index,length,prefix,result;try{value=object[property]}catch(exception){}if(typeof value=="object"&&value){className=getClass.call(value);if(className==dateClass&&!isProperty.call(value,"toJSON")){if(value>-1/0&&value<1/0){if(getDay){date=floor(value/864e5);for(year=floor(date/365.2425)+1970-1;getDay(year+1,0)<=date;year++);for(month=floor((date-getDay(year,0))/30.42);getDay(year,month+1)<=date;month++);date=1+date-getDay(year,month);time=(value%864e5+864e5)%864e5;hours=floor(time/36e5)%24;minutes=floor(time/6e4)%60;seconds=floor(time/1e3)%60;milliseconds=time%1e3}else{year=value.getUTCFullYear();month=value.getUTCMonth();date=value.getUTCDate();hours=value.getUTCHours();minutes=value.getUTCMinutes();seconds=value.getUTCSeconds();milliseconds=value.getUTCMilliseconds()}value=(year<=0||year>=1e4?(year<0?"-":"+")+toPaddedString(6,year<0?-year:year):toPaddedString(4,year))+"-"+toPaddedString(2,month+1)+"-"+toPaddedString(2,date)+"T"+toPaddedString(2,hours)+":"+toPaddedString(2,minutes)+":"+toPaddedString(2,seconds)+"."+toPaddedString(3,milliseconds)+"Z"}else{value=null}}else if(typeof value.toJSON=="function"&&(className!=numberClass&&className!=stringClass&&className!=arrayClass||isProperty.call(value,"toJSON"))){value=value.toJSON(property)}}if(callback){value=callback.call(object,property,value)}if(value===null){return"null"}className=getClass.call(value);if(className==booleanClass){return""+value}else if(className==numberClass){return value>-1/0&&value<1/0?""+value:"null"}else if(className==stringClass){return quote(""+value)}if(typeof value=="object"){for(length=stack.length;length--;){if(stack[length]===value){throw TypeError()}}stack.push(value);results=[];prefix=indentation;indentation+=whitespace;if(className==arrayClass){for(index=0,length=value.length;index<length;index++){element=serialize(index,value,callback,properties,whitespace,indentation,stack);results.push(element===undef?"null":element)}result=results.length?whitespace?"[\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"]":"["+results.join(",")+"]":"[]"}else{forEach(properties||value,function(property){var element=serialize(property,value,callback,properties,whitespace,indentation,stack);if(element!==undef){results.push(quote(property)+":"+(whitespace?" ":"")+element)}});result=results.length?whitespace?"{\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"}":"{"+results.join(",")+"}":"{}"}stack.pop();return result}};exports.stringify=function(source,filter,width){var whitespace,callback,properties,className;if(objectTypes[typeof filter]&&filter){if((className=getClass.call(filter))==functionClass){callback=filter}else if(className==arrayClass){properties={};for(var index=0,length=filter.length,value;index<length;value=filter[index++],(className=getClass.call(value),className==stringClass||className==numberClass)&&(properties[value]=1));}}if(width){if((className=getClass.call(width))==numberClass){if((width-=width%1)>0){for(whitespace="",width>10&&(width=10);whitespace.length<width;whitespace+=" ");}}else if(className==stringClass){whitespace=width.length<=10?width:width.slice(0,10)}}return serialize("",(value={},value[""]=source,value),callback,properties,whitespace,"",[])}}if(!has("json-parse")){var fromCharCode=String.fromCharCode;var Unescapes={92:"\\",34:'"',47:"/",98:"\b",116:"\t",110:"\n",102:"\f",114:"\r"};var Index,Source;var abort=function(){Index=Source=null;throw SyntaxError()};var lex=function(){var source=Source,length=source.length,value,begin,position,isSigned,charCode;while(Index<length){charCode=source.charCodeAt(Index);switch(charCode){case 9:case 10:case 13:case 32:Index++;break;case 123:case 125:case 91:case 93:case 58:case 44:value=charIndexBuggy?source.charAt(Index):source[Index];Index++;return value;case 34:for(value="@",Index++;Index<length;){charCode=source.charCodeAt(Index);if(charCode<32){abort()}else if(charCode==92){charCode=source.charCodeAt(++Index);switch(charCode){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:value+=Unescapes[charCode];Index++;break;case 117:begin=++Index;for(position=Index+4;Index<position;Index++){charCode=source.charCodeAt(Index);if(!(charCode>=48&&charCode<=57||charCode>=97&&charCode<=102||charCode>=65&&charCode<=70)){abort()}}value+=fromCharCode("0x"+source.slice(begin,Index));break;default:abort()}}else{if(charCode==34){break}charCode=source.charCodeAt(Index);begin=Index;while(charCode>=32&&charCode!=92&&charCode!=34){charCode=source.charCodeAt(++Index)}value+=source.slice(begin,Index)}}if(source.charCodeAt(Index)==34){Index++;return value}abort();default:begin=Index;if(charCode==45){isSigned=true;charCode=source.charCodeAt(++Index)}if(charCode>=48&&charCode<=57){if(charCode==48&&(charCode=source.charCodeAt(Index+1),charCode>=48&&charCode<=57)){abort()}isSigned=false;for(;Index<length&&(charCode=source.charCodeAt(Index),charCode>=48&&charCode<=57);Index++);if(source.charCodeAt(Index)==46){position=++Index;for(;position<length&&(charCode=source.charCodeAt(position),charCode>=48&&charCode<=57);position++);if(position==Index){abort()}Index=position}charCode=source.charCodeAt(Index);if(charCode==101||charCode==69){charCode=source.charCodeAt(++Index);if(charCode==43||charCode==45){Index++}for(position=Index;position<length&&(charCode=source.charCodeAt(position),charCode>=48&&charCode<=57);position++);if(position==Index){abort()}Index=position}return+source.slice(begin,Index)}if(isSigned){abort()}if(source.slice(Index,Index+4)=="true"){Index+=4;return true}else if(source.slice(Index,Index+5)=="false"){Index+=5;return false}else if(source.slice(Index,Index+4)=="null"){Index+=4;return null}abort()}}return"$"};var get=function(value){var results,hasMembers;if(value=="$"){abort()}if(typeof value=="string"){if((charIndexBuggy?value.charAt(0):value[0])=="@"){return value.slice(1)}if(value=="["){results=[];for(;;hasMembers||(hasMembers=true)){value=lex();if(value=="]"){break}if(hasMembers){if(value==","){value=lex();if(value=="]"){abort()}}else{abort()}}if(value==","){abort()}results.push(get(value))}return results}else if(value=="{"){results={};for(;;hasMembers||(hasMembers=true)){value=lex();if(value=="}"){break}if(hasMembers){if(value==","){value=lex();if(value=="}"){abort()}}else{abort()}}if(value==","||typeof value!="string"||(charIndexBuggy?value.charAt(0):value[0])!="@"||lex()!=":"){abort()}results[value.slice(1)]=get(lex())}return results}abort()}return value};var update=function(source,property,callback){var element=walk(source,property,callback);if(element===undef){delete source[property]}else{source[property]=element}};var walk=function(source,property,callback){var value=source[property],length;if(typeof value=="object"&&value){if(getClass.call(value)==arrayClass){for(length=value.length;length--;){update(value,length,callback)}}else{forEach(value,function(property){update(value,property,callback)})}}return callback.call(source,property,value)};exports.parse=function(source,callback){var result,value;Index=0;Source=""+source;result=get(lex());if(lex()!="$"){abort()}Index=Source=null;return callback&&getClass.call(callback)==functionClass?walk((value={},value[""]=result,value),"",callback):result}}}exports["runInContext"]=runInContext;return exports}if(freeExports&&!isLoader){runInContext(root,freeExports)}else{var nativeJSON=root.JSON,previousJSON=root["JSON3"],isRestored=false;var JSON3=runInContext(root,root["JSON3"]={noConflict:function(){if(!isRestored){isRestored=true;root.JSON=nativeJSON;root["JSON3"]=previousJSON;nativeJSON=previousJSON=null}return JSON3}});root.JSON={parse:JSON3.parse,stringify:JSON3.stringify}}if(isLoader){define(function(){return JSON3})}}).call(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],9:[function(require,module,exports){function Mapper(){var sources={};this.forEach=function(callback){for(var key in sources){var source=sources[key];for(var key2 in source)callback(source[key2])}};this.get=function(id,source){var ids=sources[source];if(ids==undefined)return undefined;return ids[id]};this.remove=function(id,source){var ids=sources[source];if(ids==undefined)return;delete ids[id];for(var i in ids){return false}delete sources[source]};this.set=function(value,id,source){if(value==undefined)return this.remove(id,source);var ids=sources[source];if(ids==undefined)sources[source]=ids={};ids[id]=value}}Mapper.prototype.pop=function(id,source){var value=this.get(id,source);if(value==undefined)return undefined;this.remove(id,source);return value};module.exports=Mapper},{}],10:[function(require,module,exports){var JsonRpcClient=require("./jsonrpcclient");exports.JsonRpcClient=JsonRpcClient},{"./jsonrpcclient":11}],11:[function(require,module,exports){var RpcBuilder=require("../..");var WebSocketWithReconnection=require("./transports/webSocketWithReconnection");Date.now=Date.now||function(){return+new Date};var PING_INTERVAL=5e3;var RECONNECTING="RECONNECTING";var CONNECTED="CONNECTED";var DISCONNECTED="DISCONNECTED";var RECONNECTING="RECONNECTING";var CONNECTED="CONNECTED";var DISCONNECTED="DISCONNECTED";function JsonRpcClient(configuration){var self=this;var wsConfig=configuration.ws;var notReconnectIfNumLessThan=-1;var pingNextNum=0;var enabledPings=true;var pingPongStarted=false;var pingInterval;var status=DISCONNECTED;var onreconnecting=wsConfig.onreconnecting;var onreconnected=wsConfig.onreconnected;var onconnected=wsConfig.onconnected;configuration.rpc.pull=function(params,request){request.reply(null,"push")};wsConfig.onreconnecting=function(){console.log("--------- ONRECONNECTING -----------");if(status===RECONNECTING){console.error("Websocket already in RECONNECTING state when receiving a new ONRECONNECTING message. Ignoring it");return}status=RECONNECTING;if(onreconnecting){onreconnecting()}};wsConfig.onreconnected=function(){console.log("--------- ONRECONNECTED -----------");if(status===CONNECTED){console.error("Websocket already in CONNECTED state when receiving a new ONRECONNECTED message. Ignoring it");return}status=CONNECTED;enabledPings=true;updateNotReconnectIfLessThan();usePing();if(onreconnected){onreconnected()}};wsConfig.onconnected=function(){console.log("--------- ONCONNECTED -----------");if(status===CONNECTED){console.error("Websocket already in CONNECTED state when receiving a new ONCONNECTED message. Ignoring it");return}status=CONNECTED;enabledPings=true;usePing();if(onconnected){onconnected()}};var ws=new WebSocketWithReconnection(wsConfig);console.log("Connecting websocket to URI: "+wsConfig.uri);var rpcBuilderOptions={request_timeout:configuration.rpc.requestTimeout};var rpc=new RpcBuilder(RpcBuilder.packers.JsonRPC,rpcBuilderOptions,ws,function(request){console.log("Received request: "+JSON.stringify(request));try{var func=configuration.rpc[request.method];if(func===undefined){console.error("Method "+request.method+" not registered in client")}else{func(request.params,request)}}catch(err){console.error("Exception processing request: "+JSON.stringify(request));console.error(err)}});this.send=function(method,params,callback){if(method!=="ping"){console.log("Request: method:"+method+" params:"+JSON.stringify(params))}var requestTime=Date.now();rpc.encode(method,params,function(error,result){if(error){try{console.error("ERROR:"+error.message+" in Request: method:"+method+" params:"+JSON.stringify(params));if(error.data){console.error("ERROR DATA:"+JSON.stringify(error.data))}}catch(e){}error.requestTime=requestTime}if(callback){if(result!=undefined&&result.value!=="pong"){console.log("Response: "+JSON.stringify(result))}callback(error,result)}})};function updateNotReconnectIfLessThan(){notReconnectIfNumLessThan=pingNextNum;console.log("notReconnectIfNumLessThan = "+notReconnectIfNumLessThan)}function sendPing(){if(enabledPings){var params=null;if(pingNextNum==0||pingNextNum==notReconnectIfNumLessThan){params={interval:PING_INTERVAL}}pingNextNum++;self.send("ping",params,function(pingNum){return function(error,result){if(error){if(pingNum>notReconnectIfNumLessThan){enabledPings=false;updateNotReconnectIfLessThan();console.log("DSS did not respond to ping message "+pingNum+". Reconnecting... ");ws.reconnectWs()}}}}(pingNextNum))}else{console.log("Trying to send ping, but ping is not enabled")}}function usePing(){if(!pingPongStarted){console.log("Starting ping (if configured)");pingPongStarted=true;if(configuration.heartbeat!=undefined){pingInterval=setInterval(sendPing,configuration.heartbeat);sendPing()}}}this.close=function(){console.log("Closing jsonRpcClient explicitely by client");if(pingInterval!=undefined){clearInterval(pingInterval)}pingPongStarted=false;enabledPings=false;if(configuration.sendCloseMessage){this.send("closeSession",null,function(error,result){if(error){console.error("Error sending close message: "+JSON.stringify(error))}ws.close()})}else{ws.close()}};this.forceClose=function(millis){ws.forceClose(millis)};this.reconnect=function(){ws.reconnectWs()}}module.exports=JsonRpcClient},{"../..":14,"./transports/webSocketWithReconnection":13}],12:[function(require,module,exports){var WebSocketWithReconnection=require("./webSocketWithReconnection");exports.WebSocketWithReconnection=WebSocketWithReconnection},{"./webSocketWithReconnection":13}],13:[function(require,module,exports){"use strict";var WebSocket=require("ws");var SockJS=require("sockjs-client");var MAX_RETRIES=2e3;var RETRY_TIME_MS=3e3;var PING_INTERVAL=5e3;var PING_MSG=JSON.stringify({method:"ping"});var CONNECTING=0;var OPEN=1;var CLOSING=2;var CLOSED=3;function WebSocketWithReconnection(config){var closing=false;var registerMessageHandler;var wsUri=config.uri;var useSockJS=config.useSockJS;var reconnecting=false;var forcingDisconnection=false;var ws;if(useSockJS){ws=new SockJS(wsUri)}else{ws=new WebSocket(wsUri)}ws.onopen=function(){logConnected(ws,wsUri);config.onconnected()};ws.onerror=function(evt){config.onconnected(evt.data)};function logConnected(ws,wsUri){try{console.log("WebSocket connected to "+wsUri)}catch(e){console.error(e)}}var reconnectionOnClose=function(){if(ws.readyState===CLOSED){if(closing){console.log("Connection Closed by user")}else{console.log("Connection closed unexpectecly. Reconnecting...");reconnectInNewUri(MAX_RETRIES,1)}}else{console.log("Close callback from previous websocket. Ignoring it")}};ws.onclose=reconnectionOnClose;function reconnectInNewUri(maxRetries,numRetries){console.log("reconnectInNewUri");if(numRetries===1){if(reconnecting){console.warn("Trying to reconnect when reconnecting... Ignoring this reconnection.");return}else{reconnecting=true}if(config.onreconnecting){config.onreconnecting()}}if(forcingDisconnection){reconnect(maxRetries,numRetries,wsUri)}else{if(config.newWsUriOnReconnection){config.newWsUriOnReconnection(function(error,newWsUri){if(error){console.log(error);setTimeout(function(){reconnectInNewUri(maxRetries,numRetries+1)},RETRY_TIME_MS)}else{reconnect(maxRetries,numRetries,newWsUri)}})}else{reconnect(maxRetries,numRetries,wsUri)}}}function reconnect(maxRetries,numRetries,reconnectWsUri){console.log("Trying to reconnect "+numRetries+" times");var newWs;if(useSockJS){newWs=new SockJS(wsUri)}else{newWs=new WebSocket(wsUri)}newWs.onopen=function(){console.log("Reconnected in "+numRetries+" retries...");logConnected(newWs,reconnectWsUri);reconnecting=false;registerMessageHandler();if(config.onreconnected()){config.onreconnected()}newWs.onclose=reconnectionOnClose};var onErrorOrClose=function(error){console.log("Reconnection error: ",error);if(numRetries===maxRetries){if(config.ondisconnect){config.ondisconnect()}}else{setTimeout(function(){reconnectInNewUri(maxRetries,numRetries+1)},RETRY_TIME_MS)}};newWs.onerror=onErrorOrClose;ws=newWs}this.close=function(){closing=true;ws.close()};this.forceClose=function(millis){console.log("Testing: Force WebSocket close");if(millis){console.log("Testing: Change wsUri for "+millis+" millis to simulate net failure");var goodWsUri=wsUri;wsUri="wss://21.234.12.34.4:443/";forcingDisconnection=true;setTimeout(function(){console.log("Testing: Recover good wsUri "+goodWsUri);wsUri=goodWsUri;forcingDisconnection=false},millis)}ws.close()};this.reconnectWs=function(){console.log("reconnectWs");reconnectInNewUri(MAX_RETRIES,1,wsUri)};this.send=function(message){ws.send(message)};this.addEventListener=function(type,callback){registerMessageHandler=function(){ws.addEventListener(type,callback)};registerMessageHandler()}}module.exports=WebSocketWithReconnection},{"sockjs-client":33,ws:103}],14:[function(require,module,exports){var defineProperty_IE8=false;if(Object.defineProperty){try{Object.defineProperty({},"x",{})}catch(e){defineProperty_IE8=true}}if(!Function.prototype.bind){Function.prototype.bind=function(oThis){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};fNOP.prototype=this.prototype;fBound.prototype=new fNOP;return fBound}}var EventEmitter=require("events").EventEmitter;var inherits=require("inherits");var packers=require("./packers");var Mapper=require("./Mapper");var BASE_TIMEOUT=5e3;function unifyResponseMethods(responseMethods){if(!responseMethods)return{};for(var key in responseMethods){var value=responseMethods[key];if(typeof value=="string")responseMethods[key]={response:value}}return responseMethods}function unifyTransport(transport){if(!transport)return;if(transport instanceof Function)return{send:transport};if(transport.send instanceof Function)return transport;if(transport.postMessage instanceof Function){transport.send=transport.postMessage;return transport}if(transport.write instanceof Function){transport.send=transport.write;return transport}if(transport.onmessage!==undefined)return;if(transport.pause instanceof Function)return;throw new SyntaxError("Transport is not a function nor a valid object")}function RpcNotification(method,params){if(defineProperty_IE8){this.method=method;this.params=params}else{Object.defineProperty(this,"method",{value:method,enumerable:true});Object.defineProperty(this,"params",{value:params,enumerable:true})}}function RpcBuilder(packer,options,transport,onRequest){var self=this;if(!packer)throw new SyntaxError("Packer is not defined");if(!packer.pack||!packer.unpack)throw new SyntaxError("Packer is invalid");var responseMethods=unifyResponseMethods(packer.responseMethods);if(options instanceof Function){if(transport!=undefined)throw new SyntaxError("There can't be parameters after onRequest");onRequest=options;transport=undefined;options=undefined}if(options&&options.send instanceof Function){if(transport&&!(transport instanceof Function))throw new SyntaxError("Only a function can be after transport");onRequest=transport;transport=options;options=undefined}if(transport instanceof Function){if(onRequest!=undefined)throw new SyntaxError("There can't be parameters after onRequest");onRequest=transport;transport=undefined}if(transport&&transport.send instanceof Function)if(onRequest&&!(onRequest instanceof Function))throw new SyntaxError("Only a function can be after transport");options=options||{};EventEmitter.call(this);if(onRequest)this.on("request",onRequest);if(defineProperty_IE8)this.peerID=options.peerID;else Object.defineProperty(this,"peerID",{value:options.peerID});var max_retries=options.max_retries||0;function transportMessage(event){self.decode(event.data||event)}this.getTransport=function(){return transport};this.setTransport=function(value){if(transport){if(transport.removeEventListener)transport.removeEventListener("message",transportMessage);else if(transport.removeListener)transport.removeListener("data",transportMessage)}if(value){if(value.addEventListener)value.addEventListener("message",transportMessage);else if(value.addListener)value.addListener("data",transportMessage)}transport=unifyTransport(value)};if(!defineProperty_IE8)Object.defineProperty(this,"transport",{get:this.getTransport.bind(this),set:this.setTransport.bind(this)});this.setTransport(transport);var request_timeout=options.request_timeout||BASE_TIMEOUT;var response_timeout=options.response_timeout||BASE_TIMEOUT;var duplicates_timeout=options.duplicates_timeout||BASE_TIMEOUT;var requestID=0;var requests=new Mapper;var responses=new Mapper;var processedResponses=new Mapper;var message2Key={};function storeResponse(message,id,dest){var response={message:message,timeout:setTimeout(function(){responses.remove(id,dest)},response_timeout)};responses.set(response,id,dest)}function storeProcessedResponse(ack,from){var timeout=setTimeout(function(){processedResponses.remove(ack,from)},duplicates_timeout);processedResponses.set(timeout,ack,from)}function RpcRequest(method,params,id,from,transport){RpcNotification.call(this,method,params);this.getTransport=function(){return transport};this.setTransport=function(value){transport=unifyTransport(value)};if(!defineProperty_IE8)Object.defineProperty(this,"transport",{get:this.getTransport.bind(this),set:this.setTransport.bind(this)});var response=responses.get(id,from);if(!(transport||self.getTransport())){if(defineProperty_IE8)this.duplicated=Boolean(response);else Object.defineProperty(this,"duplicated",{value:Boolean(response)})}var responseMethod=responseMethods[method];this.pack=packer.pack.bind(packer,this,id);this.reply=function(error,result,transport){if(error instanceof Function||error&&error.send instanceof Function){if(result!=undefined)throw new SyntaxError("There can't be parameters after callback");transport=error;result=null;error=undefined}else if(result instanceof Function||result&&result.send instanceof Function){if(transport!=undefined)throw new SyntaxError("There can't be parameters after callback");transport=result;result=null}transport=unifyTransport(transport);if(response)clearTimeout(response.timeout);if(from!=undefined){if(error)error.dest=from;if(result)result.dest=from}var message;if(error||result!=undefined){if(self.peerID!=undefined){if(error)error.from=self.peerID;else result.from=self.peerID}if(responseMethod){if(responseMethod.error==undefined&&error)message={error:error};else{var method=error?responseMethod.error:responseMethod.response;message={method:method,params:error||result}}}else message={error:error,result:result};message=packer.pack(message,id)}else if(response)message=response.message;else message=packer.pack({result:null},id);storeResponse(message,id,from);transport=transport||this.getTransport()||self.getTransport();if(transport)return transport.send(message);return message}}inherits(RpcRequest,RpcNotification);function cancel(message){var key=message2Key[message];if(!key)return;delete message2Key[message];var request=requests.pop(key.id,key.dest);if(!request)return;clearTimeout(request.timeout);storeProcessedResponse(key.id,key.dest)}this.cancel=function(message){if(message)return cancel(message);for(var message in message2Key)cancel(message)};this.close=function(){var transport=this.getTransport();if(transport&&transport.close)transport.close();this.cancel();processedResponses.forEach(clearTimeout);responses.forEach(function(response){clearTimeout(response.timeout)})};this.encode=function(method,params,dest,transport,callback){if(params instanceof Function){if(dest!=undefined)throw new SyntaxError("There can't be parameters after callback");callback=params;transport=undefined;dest=undefined;params=undefined}else if(dest instanceof Function){if(transport!=undefined)throw new SyntaxError("There can't be parameters after callback");callback=dest;transport=undefined;dest=undefined}else if(transport instanceof Function){if(callback!=undefined)throw new SyntaxError("There can't be parameters after callback");callback=transport;transport=undefined}if(self.peerID!=undefined){params=params||{};params.from=self.peerID}if(dest!=undefined){params=params||{};params.dest=dest}var message={method:method,params:params};if(callback){var id=requestID++;var retried=0;message=packer.pack(message,id);function dispatchCallback(error,result){self.cancel(message);callback(error,result)}var request={message:message,callback:dispatchCallback,responseMethods:responseMethods[method]||{}};var encode_transport=unifyTransport(transport);function sendRequest(transport){request.timeout=setTimeout(timeout,request_timeout*Math.pow(2,retried++));message2Key[message]={id:id,dest:dest};requests.set(request,id,dest);transport=transport||encode_transport||self.getTransport();if(transport)return transport.send(message);return message}function retry(transport){transport=unifyTransport(transport);console.warn(retried+" retry for request message:",message);var timeout=processedResponses.pop(id,dest);clearTimeout(timeout);return sendRequest(transport)}function timeout(){if(retried<max_retries)return retry(transport);var error=new Error("Request has timed out");error.request=message;error.retry=retry;dispatchCallback(error)}return sendRequest(transport)}message=packer.pack(message);transport=transport||this.getTransport();if(transport)return transport.send(message);return message};this.decode=function(message,transport){if(!message)throw new TypeError("Message is not defined");try{message=packer.unpack(message)}catch(e){return console.log(e,message)}var id=message.id;var ack=message.ack;var method=message.method;var params=message.params||{};var from=params.from;var dest=params.dest;if(self.peerID!=undefined&&from==self.peerID)return;if(id==undefined&&ack==undefined){var notification=new RpcNotification(method,params);if(self.emit("request",notification))return;return notification}function processRequest(){transport=unifyTransport(transport)||self.getTransport();if(transport){var response=responses.get(id,from);if(response)return transport.send(response.message)}var idAck=id!=undefined?id:ack;var request=new RpcRequest(method,params,idAck,from,transport);if(self.emit("request",request))return;return request}function processResponse(request,error,result){request.callback(error,result)}function duplicatedResponse(timeout){console.warn("Response already processed",message);clearTimeout(timeout);storeProcessedResponse(ack,from)}if(method){if(dest==undefined||dest==self.peerID){var request=requests.get(ack,from);if(request){var responseMethods=request.responseMethods;if(method==responseMethods.error)return processResponse(request,params);if(method==responseMethods.response)return processResponse(request,null,params);return processRequest()}var processed=processedResponses.get(ack,from);if(processed)return duplicatedResponse(processed)}return processRequest()}var error=message.error;var result=message.result;if(error&&error.dest&&error.dest!=self.peerID)return;if(result&&result.dest&&result.dest!=self.peerID)return;var request=requests.get(ack,from);if(!request){var processed=processedResponses.get(ack,from);if(processed)return duplicatedResponse(processed);return console.warn("No callback was defined for this message",message)}processResponse(request,error,result)}}inherits(RpcBuilder,EventEmitter);RpcBuilder.RpcNotification=RpcNotification;module.exports=RpcBuilder;var clients=require("./clients");var transports=require("./clients/transports");RpcBuilder.clients=clients;RpcBuilder.clients.transports=transports;RpcBuilder.packers=packers},{"./Mapper":9,"./clients":10,"./clients/transports":12,"./packers":17,events:113,inherits:7}],15:[function(require,module,exports){function pack(message,id){var result={jsonrpc:"2.0"};if(message.method){result.method=message.method;if(message.params)result.params=message.params;if(id!=undefined)result.id=id}else if(id!=undefined){if(message.error){if(message.result!==undefined)throw new TypeError("Both result and error are defined");result.error=message.error}else if(message.result!==undefined)result.result=message.result;else throw new TypeError("No result or error is defined");result.id=id}return JSON.stringify(result)}function unpack(message){var result=message;if(typeof message==="string"||message instanceof String)result=JSON.parse(message);var version=result.jsonrpc;if(version!=="2.0")throw new TypeError("Invalid JsonRPC version '"+version+"': "+message);if(result.method==undefined){if(result.id==undefined)throw new TypeError("Invalid message: "+message);var result_defined=result.result!==undefined;var error_defined=result.error!==undefined;if(result_defined&&error_defined)throw new TypeError("Both result and error are defined: "+message);if(!result_defined&&!error_defined)throw new TypeError("No result or error is defined: "+message);result.ack=result.id;delete result.id}return result}exports.pack=pack;exports.unpack=unpack},{}],16:[function(require,module,exports){function pack(message){throw new TypeError("Not yet implemented")}function unpack(message){throw new TypeError("Not yet implemented")}exports.pack=pack;exports.unpack=unpack},{}],17:[function(require,module,exports){var JsonRPC=require("./JsonRPC");var XmlRPC=require("./XmlRPC");exports.JsonRPC=JsonRPC;exports.XmlRPC=XmlRPC},{"./JsonRPC":15,"./XmlRPC":16}],18:[function(require,module,exports){var freeice=require("freeice");var inherits=require("inherits");var UAParser=require("ua-parser-js");var uuid=require("uuid");var hark=require("hark");var EventEmitter=require("events").EventEmitter;var recursive=require("merge").recursive.bind(undefined,true);var sdpTranslator=require("sdp-translator");var logger=window.Logger||console;try{require("kurento-browser-extensions")}catch(error){if(typeof getScreenConstraints==="undefined"){logger.warn("screen sharing is not available");getScreenConstraints=function getScreenConstraints(sendSource,callback){callback(new Error("This library is not enabled for screen sharing"))}}}var MEDIA_CONSTRAINTS={audio:true,video:{width:640,framerate:15}};var ua=window&&window.navigator?window.navigator.userAgent:"";var parser=new UAParser(ua);var browser=parser.getBrowser();var usePlanB=false;if(browser.name==="Chrome"||browser.name==="Chromium"){logger.info(browser.name+": using SDP PlanB");usePlanB=true}function noop(error){if(error)logger.error(error)}function trackStop(track){track.stop&&track.stop()}function streamStop(stream){stream.getTracks().forEach(trackStop)}var dumpSDP=function(description){if(typeof description==="undefined"||description===null){return""}return"type: "+description.type+"\r\n"+description.sdp};function bufferizeCandidates(pc,onerror){var candidatesQueue=[];pc.addEventListener("signalingstatechange",function(){if(this.signalingState==="stable"){while(candidatesQueue.length){var entry=candidatesQueue.shift();this.addIceCandidate(entry.candidate,entry.callback,entry.callback)}}});return function(candidate,callback){callback=callback||onerror;switch(pc.signalingState){case"closed":callback(new Error("PeerConnection object is closed"));break;case"stable":if(pc.remoteDescription){pc.addIceCandidate(candidate,callback,callback);break}default:candidatesQueue.push({candidate:candidate,callback:callback})}}}function removeFIDFromOffer(sdp){var n=sdp.indexOf("a=ssrc-group:FID");if(n>0){return sdp.slice(0,n)}else{return sdp}}function getSimulcastInfo(videoStream){var videoTracks=videoStream.getVideoTracks();if(!videoTracks.length){logger.warn("No video tracks available in the video stream");return""}var lines=["a=x-google-flag:conference","a=ssrc-group:SIM 1 2 3","a=ssrc:1 cname:localVideo","a=ssrc:1 msid:"+videoStream.id+" "+videoTracks[0].id,"a=ssrc:1 mslabel:"+videoStream.id,"a=ssrc:1 label:"+videoTracks[0].id,"a=ssrc:2 cname:localVideo","a=ssrc:2 msid:"+videoStream.id+" "+videoTracks[0].id,"a=ssrc:2 mslabel:"+videoStream.id,"a=ssrc:2 label:"+videoTracks[0].id,"a=ssrc:3 cname:localVideo","a=ssrc:3 msid:"+videoStream.id+" "+videoTracks[0].id,"a=ssrc:3 mslabel:"+videoStream.id,"a=ssrc:3 label:"+videoTracks[0].id];lines.push("");return lines.join("\n")}function WebRtcPeer(mode,options,callback){if(!(this instanceof WebRtcPeer)){return new WebRtcPeer(mode,options,callback)}WebRtcPeer.super_.call(this);if(options instanceof Function){callback=options;options=undefined}options=options||{};callback=(callback||noop).bind(this);var self=this;var localVideo=options.localVideo;var remoteVideo=options.remoteVideo;var videoStream=options.videoStream;var audioStream=options.audioStream;var mediaConstraints=options.mediaConstraints;var connectionConstraints=options.connectionConstraints;var pc=options.peerConnection;var sendSource=options.sendSource||"webcam";var dataChannelConfig=options.dataChannelConfig;var useDataChannels=options.dataChannels||false;var dataChannel;var guid=uuid.v4();var configuration=recursive({iceServers:freeice()},options.configuration);var onicecandidate=options.onicecandidate;if(onicecandidate)this.on("icecandidate",onicecandidate);var oncandidategatheringdone=options.oncandidategatheringdone;if(oncandidategatheringdone){this.on("candidategatheringdone",oncandidategatheringdone)}var simulcast=options.simulcast;var multistream=options.multistream;var interop=new sdpTranslator.Interop;var candidatesQueueOut=[];var candidategatheringdone=false;Object.defineProperties(this,{peerConnection:{get:function(){return pc}},id:{value:options.id||guid,writable:false},remoteVideo:{get:function(){return remoteVideo}},localVideo:{get:function(){return localVideo}},dataChannel:{get:function(){return dataChannel}},currentFrame:{get:function(){if(!remoteVideo)return;if(remoteVideo.readyState<remoteVideo.HAVE_CURRENT_DATA)throw new Error("No video stream data available");var canvas=document.createElement("canvas");canvas.width=remoteVideo.videoWidth;canvas.height=remoteVideo.videoHeight;canvas.getContext("2d").drawImage(remoteVideo,0,0);return canvas}}});if(!pc){pc=new RTCPeerConnection(configuration);if(useDataChannels&&!dataChannel){var dcId="WebRtcPeer-"+self.id;var dcOptions=undefined;if(dataChannelConfig){dcId=dataChannelConfig.id||dcId;dcOptions=dataChannelConfig.options}dataChannel=pc.createDataChannel(dcId,dcOptions);if(dataChannelConfig){dataChannel.onopen=dataChannelConfig.onopen;dataChannel.onclose=dataChannelConfig.onclose;dataChannel.onmessage=dataChannelConfig.onmessage;dataChannel.onbufferedamountlow=dataChannelConfig.onbufferedamountlow;dataChannel.onerror=dataChannelConfig.onerror||noop}}}pc.addEventListener("icecandidate",function(event){var candidate=event.candidate;if(EventEmitter.listenerCount(self,"icecandidate")||EventEmitter.listenerCount(self,"candidategatheringdone")){if(candidate){var cand;if(multistream&&usePlanB){cand=interop.candidateToUnifiedPlan(candidate)}else{cand=candidate}self.emit("icecandidate",cand);candidategatheringdone=false}else if(!candidategatheringdone){self.emit("candidategatheringdone");candidategatheringdone=true}}else if(!candidategatheringdone){candidatesQueueOut.push(candidate);if(!candidate)candidategatheringdone=true}});pc.ontrack=options.onaddstream;pc.onnegotiationneeded=options.onnegotiationneeded;this.on("newListener",function(event,listener){if(event==="icecandidate"||event==="candidategatheringdone"){while(candidatesQueueOut.length){var candidate=candidatesQueueOut.shift();if(!candidate===(event==="candidategatheringdone")){listener(candidate)}}}});var addIceCandidate=bufferizeCandidates(pc);this.addIceCandidate=function(iceCandidate,callback){var candidate;if(multistream&&usePlanB){candidate=interop.candidateToPlanB(iceCandidate)}else{candidate=new RTCIceCandidate(iceCandidate)}logger.debug("Remote ICE candidate received",iceCandidate);callback=(callback||noop).bind(this);addIceCandidate(candidate,callback)};this.generateOffer=function(callback){callback=callback.bind(this);var offerAudio=true;var offerVideo=true;if(mediaConstraints){offerAudio=typeof mediaConstraints.audio==="boolean"?mediaConstraints.audio:true;offerVideo=typeof mediaConstraints.video==="boolean"?mediaConstraints.video:true}var browserDependantConstraints={offerToReceiveAudio:mode!=="sendonly"&&offerAudio,offerToReceiveVideo:mode!=="sendonly"&&offerVideo};var constraints=browserDependantConstraints;logger.info("constraints: "+JSON.stringify(constraints));pc.createOffer(constraints).then(function(offer){logger.info("Created SDP offer");offer=mangleSdpToAddSimulcast(offer);return pc.setLocalDescription(offer)}).then(function(){var localDescription=pc.localDescription;logger.info("Local description set",localDescription.sdp);if(multistream&&usePlanB){localDescription=interop.toUnifiedPlan(localDescription);logger.info("offer::origPlanB->UnifiedPlan",dumpSDP(localDescription))}callback(null,localDescription.sdp,self.processAnswer.bind(self))}).catch(callback)};this.getLocalSessionDescriptor=function(){return pc.localDescription};this.getRemoteSessionDescriptor=function(){return pc.remoteDescription};function setRemoteVideo(){if(remoteVideo){var stream=pc.getRemoteStreams()[0];var url=stream?URL.createObjectURL(stream):"";remoteVideo.pause();remoteVideo.src=url;remoteVideo.load();logger.info("Remote URL:",url)}}this.showLocalVideo=function(){localVideo.src=URL.createObjectURL(videoStream);localVideo.muted=true};this.send=function(data){if(dataChannel&&dataChannel.readyState==="open"){dataChannel.send(data)}else{logger.warn("Trying to send data over a non-existing or closed data channel")}};this.processAnswer=function(sdpAnswer,callback){callback=(callback||noop).bind(this);var answer=new RTCSessionDescription({type:"answer",sdp:sdpAnswer});if(multistream&&usePlanB){var planBAnswer=interop.toPlanB(answer);logger.info("asnwer::planB",dumpSDP(planBAnswer));answer=planBAnswer}logger.info("SDP answer received, setting remote description");if(pc.signalingState==="closed"){return callback("PeerConnection is closed")}pc.setRemoteDescription(answer,function(){setRemoteVideo();callback()},callback)};this.processOffer=function(sdpOffer,callback){callback=callback.bind(this);var offer=new RTCSessionDescription({type:"offer",sdp:sdpOffer});if(multistream&&usePlanB){var planBOffer=interop.toPlanB(offer);logger.info("offer::planB",dumpSDP(planBOffer));offer=planBOffer}logger.info("SDP offer received, setting remote description");if(pc.signalingState==="closed"){return callback("PeerConnection is closed")}pc.setRemoteDescription(offer).then(function(){return setRemoteVideo()}).then(function(){return pc.createAnswer()}).then(function(answer){answer=mangleSdpToAddSimulcast(answer);logger.info("Created SDP answer");return pc.setLocalDescription(answer)}).then(function(){var localDescription=pc.localDescription;if(multistream&&usePlanB){localDescription=interop.toUnifiedPlan(localDescription);logger.info("answer::origPlanB->UnifiedPlan",dumpSDP(localDescription))}logger.info("Local description set",localDescription.sdp);callback(null,localDescription.sdp)}).catch(callback)};function mangleSdpToAddSimulcast(answer){if(simulcast){if(browser.name==="Chrome"||browser.name==="Chromium"){logger.info("Adding multicast info");answer=new RTCSessionDescription({type:answer.type,sdp:removeFIDFromOffer(answer.sdp)+getSimulcastInfo(videoStream)})}else{logger.warn("Simulcast is only available in Chrome browser.")}}return answer}function start(){if(pc.signalingState==="closed"){callback('The peer connection object is in "closed" state. This is most likely due to an invocation of the dispose method before accepting in the dialogue')}if(videoStream&&localVideo){self.showLocalVideo()}if(videoStream){pc.addStream(videoStream)}if(audioStream){pc.addStream(audioStream)}var browser=parser.getBrowser();if(mode==="sendonly"&&(browser.name==="Chrome"||browser.name==="Chromium")&&browser.major===39){mode="sendrecv"}callback()}if(mode!=="recvonly"&&!videoStream&&!audioStream){function getMedia(constraints){if(constraints===undefined){constraints=MEDIA_CONSTRAINTS}navigator.mediaDevices.getUserMedia(constraints).then(function(stream){videoStream=stream;start()}).catch(callback)}if(sendSource==="webcam"){getMedia(mediaConstraints)}else{getScreenConstraints(sendSource,function(error,constraints_){if(error)return callback(error);constraints=[mediaConstraints];constraints.unshift(constraints_);getMedia(recursive.apply(undefined,constraints))},guid)}}else{setTimeout(start,0)}this.on("_dispose",function(){if(localVideo){localVideo.pause();localVideo.src="";localVideo.load();localVideo.muted=false}if(remoteVideo){remoteVideo.pause();remoteVideo.src="";remoteVideo.load()}self.removeAllListeners();if(window.cancelChooseDesktopMedia!==undefined){window.cancelChooseDesktopMedia(guid)}})}inherits(WebRtcPeer,EventEmitter);function createEnableDescriptor(type){var method="get"+type+"Tracks";return{enumerable:true,get:function(){if(!this.peerConnection)return;var streams=this.peerConnection.getLocalStreams();if(!streams.length)return;for(var i=0,stream;stream=streams[i];i++){var tracks=stream[method]();for(var j=0,track;track=tracks[j];j++)if(!track.enabled)return false}return true},set:function(value){function trackSetEnable(track){track.enabled=value}this.peerConnection.getLocalStreams().forEach(function(stream){stream[method]().forEach(trackSetEnable)})}}}Object.defineProperties(WebRtcPeer.prototype,{enabled:{enumerable:true,get:function(){return this.audioEnabled&&this.videoEnabled},set:function(value){this.audioEnabled=this.videoEnabled=value}},audioEnabled:createEnableDescriptor("Audio"),videoEnabled:createEnableDescriptor("Video")});WebRtcPeer.prototype.getLocalStream=function(index){if(this.peerConnection){return this.peerConnection.getLocalStreams()[index||0]}};WebRtcPeer.prototype.getRemoteStream=function(index){if(this.peerConnection){return this.peerConnection.getRemoteStreams()[index||0]}};WebRtcPeer.prototype.dispose=function(){logger.info("Disposing WebRtcPeer");var pc=this.peerConnection;var dc=this.dataChannel;try{if(dc){if(dc.signalingState==="closed")return;dc.close()}if(pc){if(pc.signalingState==="closed")return;pc.getLocalStreams().forEach(streamStop);pc.close()}}catch(err){logger.warn("Exception disposing webrtc peer "+err)}this.emit("_dispose")};function WebRtcPeerRecvonly(options,callback){if(!(this instanceof WebRtcPeerRecvonly)){return new WebRtcPeerRecvonly(options,callback)}WebRtcPeerRecvonly.super_.call(this,"recvonly",options,callback)}inherits(WebRtcPeerRecvonly,WebRtcPeer);function WebRtcPeerSendonly(options,callback){if(!(this instanceof WebRtcPeerSendonly)){return new WebRtcPeerSendonly(options,callback)}WebRtcPeerSendonly.super_.call(this,"sendonly",options,callback)}inherits(WebRtcPeerSendonly,WebRtcPeer);function WebRtcPeerSendrecv(options,callback){if(!(this instanceof WebRtcPeerSendrecv)){return new WebRtcPeerSendrecv(options,callback)}WebRtcPeerSendrecv.super_.call(this,"sendrecv",options,callback)}inherits(WebRtcPeerSendrecv,WebRtcPeer);function harkUtils(stream,options){return hark(stream,options)}exports.bufferizeCandidates=bufferizeCandidates;exports.WebRtcPeerRecvonly=WebRtcPeerRecvonly;exports.WebRtcPeerSendonly=WebRtcPeerSendonly;exports.WebRtcPeerSendrecv=WebRtcPeerSendrecv;exports.hark=harkUtils},{events:113,freeice:3,hark:6,inherits:7,"kurento-browser-extensions":undefined,merge:20,"sdp-translator":29,"ua-parser-js":86,uuid:90}],19:[function(require,module,exports){var WebRtcPeer=require("./WebRtcPeer");exports.WebRtcPeer=WebRtcPeer},{"./WebRtcPeer":18}],20:[function(require,module,exports){(function(isNode){var Public=function(clone){return merge(clone===true,false,arguments)},publicName="merge";Public.recursive=function(clone){return merge(clone===true,true,arguments)};Public.clone=function(input){var output=input,type=typeOf(input),index,size;if(type==="array"){output=[];size=input.length;for(index=0;index<size;++index)output[index]=Public.clone(input[index])}else if(type==="object"){output={};for(index in input)output[index]=Public.clone(input[index])}return output};function merge_recursive(base,extend){if(typeOf(base)!=="object")return extend;for(var key in extend){if(typeOf(base[key])==="object"&&typeOf(extend[key])==="object"){base[key]=merge_recursive(base[key],extend[key])}else{base[key]=extend[key]}}return base}function merge(clone,recursive,argv){var result=argv[0],size=argv.length;if(clone||typeOf(result)!=="object")result={};for(var index=0;index<size;++index){var item=argv[index],type=typeOf(item);if(type!=="object")continue;for(var key in item){var sitem=clone?Public.clone(item[key]):item[key];if(recursive){result[key]=merge_recursive(result[key],sitem)}else{result[key]=sitem}}}return result}function typeOf(input){return{}.toString.call(input).slice(8,-1).toLowerCase()}if(isNode){module.exports=Public}else{window[publicName]=Public}})(typeof module==="object"&&module&&typeof module.exports==="object"&&module.exports)},{}],21:[function(require,module,exports){var s=1e3;var m=s*60;var h=m*60;var d=h*24;var y=d*365.25;module.exports=function(val,options){options=options||{};var type=typeof val;if(type==="string"&&val.length>0){return parse(val)}else if(type==="number"&&isNaN(val)===false){return options.long?fmtLong(val):fmtShort(val)}throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(val))};function parse(str){str=String(str);if(str.length>100){return}var match=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(str);if(!match){return}var n=parseFloat(match[1]);var type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"yrs":case"yr":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"hrs":case"hr":case"h":return n*h;case"minutes":case"minute":case"mins":case"min":case"m":return n*m;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return undefined}}function fmtShort(ms){if(ms>=d){return Math.round(ms/d)+"d"}if(ms>=h){return Math.round(ms/h)+"h"}if(ms>=m){return Math.round(ms/m)+"m"}if(ms>=s){return Math.round(ms/s)+"s"}return ms+"ms"}function fmtLong(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){if(ms<n){return}if(ms<n*1.5){return Math.floor(ms/n)+" "+name}return Math.ceil(ms/n)+" "+name+"s"}},{}],22:[function(require,module,exports){var protocols=["stun:","turn:"];module.exports=function(input){var url=(input||{}).url||input;var protocol;var parts;var output={};if(typeof url!="string"&&!(url instanceof String)){return input}url=url.trim();protocol=protocols[protocols.indexOf(url.slice(0,5))];if(!protocol){return input}url=url.slice(5);parts=url.split("@");output.username=input.username;output.credential=input.credential;if(parts.length>1){url=parts[1];parts=parts[0].split(":");output.username=parts[0];output.credential=(input||{}).credential||parts[1]||""}output.url=protocol+url;output.urls=[output.url];return output}},{}],23:[function(require,module,exports){"use strict";module.exports=function required(port,protocol){protocol=protocol.split(":")[0];port=+port;if(!port)return false;switch(protocol){case"http":case"ws":return port!==80;case"https":case"wss":return port!==443;case"ftp":return port!==21;case"gopher":return port!==70;case"file":return false}return port!==0}},{}],24:[function(require,module,exports){var grammar=module.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w\/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(o){return o.encoding?"rtpmap:%d %s/%s/%s":o.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(o){return o.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(o){return o.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:([\w_\/]*) (\S*)(?: (\S*))?/,names:["value","uri","config"],format:function(o){return o.config!=null?"extmap:%s %s %s":"extmap:%s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(o){return o.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(o){var str="candidate:%s %d %s %d %s %d typ %s";str+=o.raddr!=null?" raddr %s rport %d":"%v%v";str+=o.tcptype!=null?" tcptype %s":"%v";if(o.generation!=null){str+=" generation %d"}return str}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_]*):(.*)/,names:["id","attribute","value"],format:"ssrc:%d %s:%s"},{push:"ssrcGroups",reg:/^ssrc-group:(\w*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{push:"invalid",names:["value"]}]};Object.keys(grammar).forEach(function(key){var objs=grammar[key];objs.forEach(function(obj){if(!obj.reg){obj.reg=/(.*)/}if(!obj.format){obj.format="%s"}})})},{}],25:[function(require,module,exports){var parser=require("./parser");var writer=require("./writer");exports.write=writer;exports.parse=parser.parse;exports.parseFmtpConfig=parser.parseFmtpConfig;exports.parsePayloads=parser.parsePayloads;exports.parseRemoteCandidates=parser.parseRemoteCandidates},{"./parser":26,"./writer":27}],26:[function(require,module,exports){var toIntIfInt=function(v){return String(Number(v))===v?Number(v):v};var attachProperties=function(match,location,names,rawName){if(rawName&&!names){location[rawName]=toIntIfInt(match[1])}else{for(var i=0;i<names.length;i+=1){if(match[i+1]!=null){location[names[i]]=toIntIfInt(match[i+1])}}}};var parseReg=function(obj,location,content){var needsBlank=obj.name&&obj.names;if(obj.push&&!location[obj.push]){location[obj.push]=[]}else if(needsBlank&&!location[obj.name]){location[obj.name]={}}var keyLocation=obj.push?{}:needsBlank?location[obj.name]:location;attachProperties(content.match(obj.reg),keyLocation,obj.names,obj.name);if(obj.push){location[obj.push].push(keyLocation)}};var grammar=require("./grammar");var validLine=RegExp.prototype.test.bind(/^([a-z])=(.*)/);exports.parse=function(sdp){var session={},media=[],location=session;sdp.split(/(\r\n|\r|\n)/).filter(validLine).forEach(function(l){var type=l[0];var content=l.slice(2);if(type==="m"){media.push({rtp:[],fmtp:[]});location=media[media.length-1]}for(var j=0;j<(grammar[type]||[]).length;j+=1){var obj=grammar[type][j];if(obj.reg.test(content)){return parseReg(obj,location,content)}}});session.media=media;return session};var fmtpReducer=function(acc,expr){var s=expr.split("=");if(s.length===2){acc[s[0]]=toIntIfInt(s[1])}return acc};exports.parseFmtpConfig=function(str){return str.split(/\;\s?/).reduce(fmtpReducer,{})};exports.parsePayloads=function(str){return str.split(" ").map(Number)};exports.parseRemoteCandidates=function(str){var candidates=[];var parts=str.split(" ").map(toIntIfInt);for(var i=0;i<parts.length;i+=3){candidates.push({component:parts[i],ip:parts[i+1],port:parts[i+2]})}return candidates}},{"./grammar":24}],27:[function(require,module,exports){var grammar=require("./grammar");var formatRegExp=/%[sdv%]/g;var format=function(formatStr){var i=1;var args=arguments;var len=args.length;return formatStr.replace(formatRegExp,function(x){if(i>=len){return x}var arg=args[i];i+=1;switch(x){case"%%":return"%";case"%s":return String(arg);case"%d":return Number(arg);case"%v":return""}})};var makeLine=function(type,obj,location){var str=obj.format instanceof Function?obj.format(obj.push?location:location[obj.name]):obj.format;var args=[type+"="+str];if(obj.names){for(var i=0;i<obj.names.length;i+=1){var n=obj.names[i];if(obj.name){args.push(location[obj.name][n])}else{args.push(location[obj.names[i]])}}}else{args.push(location[obj.name])}return format.apply(null,args)};var defaultOuterOrder=["v","o","s","i","u","e","p","c","b","t","r","z","a"];var defaultInnerOrder=["i","c","b","a"];module.exports=function(session,opts){opts=opts||{};if(session.version==null){session.version=0}if(session.name==null){session.name=" "}session.media.forEach(function(mLine){if(mLine.payloads==null){mLine.payloads=""}});var outerOrder=opts.outerOrder||defaultOuterOrder;var innerOrder=opts.innerOrder||defaultInnerOrder;var sdp=[];outerOrder.forEach(function(type){grammar[type].forEach(function(obj){if(obj.name in session&&session[obj.name]!=null){sdp.push(makeLine(type,obj,session))}else if(obj.push in session&&session[obj.push]!=null){session[obj.push].forEach(function(el){sdp.push(makeLine(type,obj,el))})}})});session.media.forEach(function(mLine){sdp.push(makeLine("m",grammar.m[0],mLine));innerOrder.forEach(function(type){grammar[type].forEach(function(obj){if(obj.name in mLine&&mLine[obj.name]!=null){sdp.push(makeLine(type,obj,mLine))}else if(obj.push in mLine&&mLine[obj.push]!=null){mLine[obj.push].forEach(function(el){sdp.push(makeLine(type,obj,el))})}})})});return sdp.join("\r\n")+"\r\n"}},{"./grammar":24}],28:[function(require,module,exports){module.exports=function arrayEquals(array){if(!array)return false;if(this.length!=array.length)return false;for(var i=0,l=this.length;i<l;i++){if(this[i]instanceof Array&&array[i]instanceof Array){if(!arrayEquals.apply(this[i],[array[i]]))return false}else if(this[i]!=array[i]){return false}}return true}},{}],29:[function(require,module,exports){exports.Interop=require("./interop")},{"./interop":30}],30:[function(require,module,exports){"use strict";var transform=require("./transform");var arrayEquals=require("./array-equals");function Interop(){this.cache={mlB2UMap:{},mlU2BMap:{}}}module.exports=Interop;Interop.prototype.candidateToUnifiedPlan=function(candidate){var cand=new RTCIceCandidate(candidate);cand.sdpMLineIndex=this.cache.mlB2UMap[cand.sdpMLineIndex];return cand};Interop.prototype.candidateToPlanB=function(candidate){var cand=new RTCIceCandidate(candidate);if(cand.sdpMid.indexOf("audio")===0){cand.sdpMid="audio"}else if(cand.sdpMid.indexOf("video")===0){cand.sdpMid="video"}else{throw new Error("candidate with "+cand.sdpMid+" not allowed")}cand.sdpMLineIndex=this.cache.mlU2BMap[cand.sdpMLineIndex];return cand};Interop.prototype.getFirstSendingIndexFromAnswer=function(type){if(!this.cache.answer){return null}var session=transform.parse(this.cache.answer);if(session&&session.media&&Array.isArray(session.media)){for(var i=0;i<session.media.length;i++){if(session.media[i].type==type&&(!session.media[i].direction||session.media[i].direction==="sendrecv"||session.media[i].direction==="sendonly")){return i}}}return null};Interop.prototype.toPlanB=function(desc){var self=this;if(typeof desc!=="object"||desc===null||typeof desc.sdp!=="string"){console.warn("An empty description was passed as an argument.");return desc}var session=transform.parse(desc.sdp);if(typeof session.media==="undefined"||!Array.isArray(session.media)||session.media.length===0){console.warn("The description has no media.");return desc}if(session.media.length<=3&&session.media.every(function(m){return["video","audio","data"].indexOf(m.mid)!==-1})){console.warn("This description does not look like Unified Plan.");return desc}var sdp=desc.sdp;var rewrite=false;for(var i=0;i<session.media.length;i++){var uLine=session.media[i];uLine.rtp.forEach(function(rtp){if(rtp.codec==="NULL"){rewrite=true;var offer=transform.parse(self.cache.offer);rtp.codec=offer.media[i].rtp[0].codec}})}if(rewrite){sdp=transform.write(session)}this.cache[desc.type]=sdp;var media=session.media;session.media=[];var type2bl={};var types=[];media.forEach(function(uLine){if((typeof uLine.rtcpMux!=="string"||uLine.rtcpMux!=="rtcp-mux")&&uLine.direction!=="inactive"){throw new Error("Cannot convert to Plan B because m-lines "+"without the rtcp-mux attribute were found.")}if(typeof type2bl[uLine.type]==="undefined"||type2bl[uLine.type].direction==="inactive"){type2bl[uLine.type]=uLine}if(uLine.protocol!=type2bl[uLine.type].protocol){throw new Error("Cannot convert to Plan B because m-lines "+"have different protocols and this library does not have "+"support for that")}if(uLine.payloads!=type2bl[uLine.type].payloads){throw new Error("Cannot convert to Plan B because m-lines "+"have different payloads and this library does not have "+"support for that")}});media.forEach(function(uLine){if(uLine.type==="application"){session.media.push(uLine);types.push(uLine.mid);return}if(typeof uLine.sources==="object"){Object.keys(uLine.sources).forEach(function(ssrc){if(typeof type2bl[uLine.type].sources!=="object")type2bl[uLine.type].sources={};type2bl[uLine.type].sources[ssrc]=uLine.sources[ssrc];if(typeof uLine.msid!=="undefined"){type2bl[uLine.type].sources[ssrc].msid=uLine.msid}})}if(typeof uLine.ssrcGroups!=="undefined"&&Array.isArray(uLine.ssrcGroups)){if(typeof type2bl[uLine.type].ssrcGroups==="undefined"||!Array.isArray(type2bl[uLine.type].ssrcGroups)){type2bl[uLine.type].ssrcGroups=[]}type2bl[uLine.type].ssrcGroups=type2bl[uLine.type].ssrcGroups.concat(uLine.ssrcGroups)}if(type2bl[uLine.type]===uLine){uLine.mid=uLine.type;delete uLine.bundleOnly;delete uLine.msid;if(uLine.type==media[0].type){types.unshift(uLine.type);session.media.unshift(uLine)}else{types.push(uLine.type);session.media.push(uLine)}}});if(typeof session.groups!=="undefined"){session.groups.some(function(group){if(group.type==="BUNDLE"){group.mids=types.join(" ");return true}})}session.msidSemantic={semantic:"WMS",token:"*"};var resStr=transform.write(session);return new RTCSessionDescription({type:desc.type,sdp:resStr})};function addSetupAttr(uLine){if(typeof uLine.setup==="undefined"){return}if(uLine.setup==="active"){uLine.setup="passive"}else if(uLine.setup==="passive"){uLine.setup="active"}}Interop.prototype.toUnifiedPlan=function(desc){var self=this;if(typeof desc!=="object"||desc===null||typeof desc.sdp!=="string"){console.warn("An empty description was passed as an argument.");return desc}var session=transform.parse(desc.sdp);if(typeof session.media==="undefined"||!Array.isArray(session.media)||session.media.length===0){console.warn("The description has no media.");return desc}if(session.media.length>3||!session.media.every(function(m){return["video","audio","data"].indexOf(m.mid)!==-1})){console.warn("This description does not look like Plan B.");return desc}var mids=[];session.media.forEach(function(m){mids.push(m.mid)});var hasBundle=false;if(typeof session.groups!=="undefined"&&Array.isArray(session.groups)){hasBundle=session.groups.every(function(g){return g.type!=="BUNDLE"||arrayEquals.apply(g.mids.sort(),[mids.sort()])})}if(!hasBundle){var mustBeBundle=false;session.media.forEach(function(m){if(m.direction!=="inactive"){mustBeBundle=true}});if(mustBeBundle){throw new Error("Cannot convert to Unified Plan because m-lines that"+" are not bundled were found.")}}var type;if(desc.type==="answer"){type="offer"}else if(desc.type==="offer"){type="answer"}else{throw new Error("Type '"+desc.type+"' not supported.")}var cached;if(typeof this.cache[type]!=="undefined"){cached=transform.parse(this.cache[type])}var recvonlySsrcs={audio:{},video:{}};var mid2ul={};var bIdx=0;var uIdx=0;var sources2ul={};var candidates;var iceUfrag;var icePwd;var fingerprint;var payloads={};var rtcpFb={};var rtp={};session.media.forEach(function(bLine){if((typeof bLine.rtcpMux!=="string"||bLine.rtcpMux!=="rtcp-mux")&&bLine.direction!=="inactive"){throw new Error("Cannot convert to Unified Plan because m-lines "+"without the rtcp-mux attribute were found.")}if(bLine.type==="application"){mid2ul[bLine.mid]=bLine;return}var sources=bLine.sources;var ssrcGroups=bLine.ssrcGroups;var port=bLine.port;if(typeof bLine.candidates!="undefined"){if(typeof candidates!="undefined"){candidates=candidates.concat(bLine.candidates)}else{candidates=bLine.candidates}}if(typeof iceUfrag!="undefined"&&typeof bLine.iceUfrag!="undefined"&&iceUfrag!=bLine.iceUfrag){throw new Error("Only BUNDLE supported, iceUfrag must be the same for all m-lines.\n"+"\tLast iceUfrag: "+iceUfrag+"\n"+"\tNew iceUfrag: "+bLine.iceUfrag)}if(typeof bLine.iceUfrag!="undefined"){iceUfrag=bLine.iceUfrag}if(typeof icePwd!="undefined"&&typeof bLine.icePwd!="undefined"&&icePwd!=bLine.icePwd){throw new Error("Only BUNDLE supported, icePwd must be the same for all m-lines.\n"+"\tLast icePwd: "+icePwd+"\n"+"\tNew icePwd: "+bLine.icePwd)}if(typeof bLine.icePwd!="undefined"){icePwd=bLine.icePwd}if(typeof fingerprint!="undefined"&&typeof bLine.fingerprint!="undefined"&&(fingerprint.type!=bLine.fingerprint.type||fingerprint.hash!=bLine.fingerprint.hash)){throw new Error("Only BUNDLE supported, fingerprint must be the same for all m-lines.\n"+"\tLast fingerprint: "+JSON.stringify(fingerprint)+"\n"+"\tNew fingerprint: "+JSON.stringify(bLine.fingerprint))}if(typeof bLine.fingerprint!="undefined"){fingerprint=bLine.fingerprint}payloads[bLine.type]=bLine.payloads;rtcpFb[bLine.type]=bLine.rtcpFb;rtp[bLine.type]=bLine.rtp;var ssrc2group={};if(typeof ssrcGroups!=="undefined"&&Array.isArray(ssrcGroups)){ssrcGroups.forEach(function(ssrcGroup){if(typeof ssrcGroup.ssrcs!=="undefined"&&Array.isArray(ssrcGroup.ssrcs)){ssrcGroup.ssrcs.forEach(function(ssrc){if(typeof ssrc2group[ssrc]==="undefined"){ssrc2group[ssrc]=[]}ssrc2group[ssrc].push(ssrcGroup)})}})}var ssrc2ml={};if(typeof sources==="object"){delete bLine.sources;delete bLine.ssrcGroups;delete bLine.candidates;delete bLine.iceUfrag;delete bLine.icePwd;delete bLine.fingerprint;delete bLine.port;delete bLine.mid;Object.keys(sources).forEach(function(ssrc){var uLine;if(desc.type==="offer"){if(!sources[ssrc].msid){recvonlySsrcs[bLine.type][ssrc]=sources[ssrc];return}}if(typeof ssrc2group[ssrc]!=="undefined"&&Array.isArray(ssrc2group[ssrc])){ssrc2group[ssrc].some(function(ssrcGroup){return ssrcGroup.ssrcs.some(function(related){if(typeof ssrc2ml[related]==="object"){uLine=ssrc2ml[related];return true}})})}if(typeof uLine==="object"){uLine.sources[ssrc]=sources[ssrc];delete sources[ssrc].msid}else{uLine=Object.create(bLine);ssrc2ml[ssrc]=uLine;if(typeof sources[ssrc].msid!=="undefined"){uLine.msid=sources[ssrc].msid;delete sources[ssrc].msid}uLine.sources={};uLine.sources[ssrc]=sources[ssrc];uLine.ssrcGroups=ssrc2group[ssrc];if(typeof cached!=="undefined"&&typeof cached.media!=="undefined"&&Array.isArray(cached.media)){cached.media.forEach(function(m){if(typeof m.sources==="object"){Object.keys(m.sources).forEach(function(s){if(s===ssrc){uLine.mid=m.mid}})}})}if(typeof uLine.mid==="undefined"){uLine.mid=[bLine.type,"-",ssrc].join("")}uLine.candidates=candidates;uLine.iceUfrag=iceUfrag;uLine.icePwd=icePwd;uLine.fingerprint=fingerprint;uLine.port=port;mid2ul[uLine.mid]=uLine;sources2ul[uIdx]=uLine.sources;self.cache.mlU2BMap[uIdx]=bIdx;if(typeof self.cache.mlB2UMap[bIdx]==="undefined"){self.cache.mlB2UMap[bIdx]=uIdx}uIdx++}})}else{var uLine=bLine;uLine.candidates=candidates;uLine.iceUfrag=iceUfrag;uLine.icePwd=icePwd;uLine.fingerprint=fingerprint;uLine.port=port;mid2ul[uLine.mid]=uLine;self.cache.mlU2BMap[uIdx]=bIdx;if(typeof self.cache.mlB2UMap[bIdx]==="undefined"){self.cache.mlB2UMap[bIdx]=uIdx}}bIdx++});session.media=[];mids=[];if(desc.type==="answer"){for(var i=0;i<cached.media.length;i++){var uLine=cached.media[i];delete uLine.msid;delete uLine.sources;delete uLine.ssrcGroups;if(typeof sources2ul[i]==="undefined"){if(!uLine.direction||uLine.direction==="sendrecv")uLine.direction="recvonly";else if(uLine.direction==="sendonly")uLine.direction="inactive"}else{if(!uLine.direction||uLine.direction==="sendrecv")uLine.direction="sendrecv";else if(uLine.direction==="recvonly")uLine.direction="sendonly"}uLine.sources=sources2ul[i];uLine.candidates=candidates;uLine.iceUfrag=iceUfrag;uLine.icePwd=icePwd;uLine.fingerprint=fingerprint;uLine.rtp=rtp[uLine.type];uLine.payloads=payloads[uLine.type];uLine.rtcpFb=rtcpFb[uLine.type];session.media.push(uLine);if(typeof uLine.mid==="string"){mids.push(uLine.mid)}}}else{if(typeof cached!=="undefined"&&typeof cached.media!=="undefined"&&Array.isArray(cached.media)){cached.media.forEach(function(uLine){mids.push(uLine.mid);if(typeof mid2ul[uLine.mid]!=="undefined"){session.media.push(mid2ul[uLine.mid])}else{delete uLine.msid;delete uLine.sources;delete uLine.ssrcGroups;if(!uLine.direction||uLine.direction==="sendrecv"){uLine.direction="sendonly"}if(!uLine.direction||uLine.direction==="recvonly"){uLine.direction="inactive"}addSetupAttr(uLine);session.media.push(uLine)}})}Object.keys(mid2ul).forEach(function(mid){if(mids.indexOf(mid)===-1){mids.push(mid);if(mid2ul[mid].direction==="recvonly"){var done=false;session.media.some(function(uLine){if((uLine.direction==="sendrecv"||uLine.direction==="sendonly")&&uLine.type===mid2ul[mid].type){Object.keys(mid2ul[mid].sources).forEach(function(ssrc){uLine.sources[ssrc]=mid2ul[mid].sources[ssrc]});done=true;return true}});if(!done){session.media.push(mid2ul[mid])}}else{session.media.push(mid2ul[mid])}}})}["audio","video"].forEach(function(type){if(!session||!session.media||!Array.isArray(session.media))return;var idx=null;if(Object.keys(recvonlySsrcs[type]).length>0){idx=self.getFirstSendingIndexFromAnswer(type);if(idx===null){for(var i=0;i<session.media.length;i++){if(session.media[i].type===type){idx=i;break}}}}if(idx&&session.media.length>idx){var mLine=session.media[idx];Object.keys(recvonlySsrcs[type]).forEach(function(ssrc){if(mLine.sources&&mLine.sources[ssrc]){console.warn("Replacing an existing SSRC.")}if(!mLine.sources){mLine.sources={}}mLine.sources[ssrc]=recvonlySsrcs[type][ssrc]})}});if(typeof session.groups!=="undefined"){session.groups.some(function(group){if(group.type==="BUNDLE"){group.mids=mids.join(" ");return true}})}session.msidSemantic={semantic:"WMS",token:"*"};var resStr=transform.write(session);this.cache[desc.type]=resStr;return new RTCSessionDescription({type:desc.type,sdp:resStr})}},{"./array-equals":28,"./transform":31}],31:[function(require,module,exports){var transform=require("sdp-transform");exports.write=function(session,opts){if(typeof session!=="undefined"&&typeof session.media!=="undefined"&&Array.isArray(session.media)){session.media.forEach(function(mLine){if(typeof mLine.sources!=="undefined"&&Object.keys(mLine.sources).length!==0){mLine.ssrcs=[];Object.keys(mLine.sources).forEach(function(ssrc){var source=mLine.sources[ssrc];Object.keys(source).forEach(function(attribute){mLine.ssrcs.push({id:ssrc,attribute:attribute,value:source[attribute]})})});delete mLine.sources}if(typeof mLine.ssrcGroups!=="undefined"&&Array.isArray(mLine.ssrcGroups)){mLine.ssrcGroups.forEach(function(ssrcGroup){if(typeof ssrcGroup.ssrcs!=="undefined"&&Array.isArray(ssrcGroup.ssrcs)){ssrcGroup.ssrcs=ssrcGroup.ssrcs.join(" ")}})}})}if(typeof session!=="undefined"&&typeof session.groups!=="undefined"&&Array.isArray(session.groups)){session.groups.forEach(function(g){if(typeof g.mids!=="undefined"&&Array.isArray(g.mids)){g.mids=g.mids.join(" ")}})}return transform.write(session,opts)};exports.parse=function(sdp){var session=transform.parse(sdp);if(typeof session!=="undefined"&&typeof session.media!=="undefined"&&Array.isArray(session.media)){session.media.forEach(function(mLine){if(typeof mLine.ssrcs!=="undefined"&&Array.isArray(mLine.ssrcs)){mLine.sources={};mLine.ssrcs.forEach(function(ssrc){if(!mLine.sources[ssrc.id])mLine.sources[ssrc.id]={};mLine.sources[ssrc.id][ssrc.attribute]=ssrc.value});delete mLine.ssrcs}if(typeof mLine.ssrcGroups!=="undefined"&&Array.isArray(mLine.ssrcGroups)){mLine.ssrcGroups.forEach(function(ssrcGroup){if(typeof ssrcGroup.ssrcs==="string"){ssrcGroup.ssrcs=ssrcGroup.ssrcs.split(" ")}})}})}if(typeof session!=="undefined"&&typeof session.groups!=="undefined"&&Array.isArray(session.groups)){session.groups.forEach(function(g){if(typeof g.mids==="string"){g.mids=g.mids.split(" ")}})}return session}},{"sdp-transform":25}],32:[function(require,module,exports){"use strict";var SDPUtils={};SDPUtils.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};SDPUtils.localCName=SDPUtils.generateIdentifier();SDPUtils.splitLines=function(blob){return blob.trim().split("\n").map(function(line){return line.trim()})};SDPUtils.splitSections=function(blob){var parts=blob.split("\nm=");return parts.map(function(part,index){return(index>0?"m="+part:part).trim()+"\r\n"})};SDPUtils.matchPrefix=function(blob,prefix){return SDPUtils.splitLines(blob).filter(function(line){return line.indexOf(prefix)===0})};SDPUtils.parseCandidate=function(line){var parts;if(line.indexOf("a=candidate:")===0){parts=line.substring(12).split(" ")}else{parts=line.substring(10).split(" ")}var candidate={foundation:parts[0],component:parts[1],protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],port:parseInt(parts[5],10),type:parts[7]};for(var i=8;i<parts.length;i+=2){switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1];break;default:candidate[parts[i]]=parts[i+1];break}}return candidate};SDPUtils.writeCandidate=function(candidate){var sdp=[];sdp.push(candidate.foundation);sdp.push(candidate.component);sdp.push(candidate.protocol.toUpperCase());sdp.push(candidate.priority);sdp.push(candidate.ip);sdp.push(candidate.port);var type=candidate.type;sdp.push("typ");sdp.push(type);if(type!=="host"&&candidate.relatedAddress&&candidate.relatedPort){sdp.push("raddr");sdp.push(candidate.relatedAddress);sdp.push("rport");sdp.push(candidate.relatedPort)}if(candidate.tcpType&&candidate.protocol.toLowerCase()==="tcp"){sdp.push("tcptype");sdp.push(candidate.tcpType)}return"candidate:"+sdp.join(" ")};SDPUtils.parseIceOptions=function(line){return line.substr(14).split(" ")};SDPUtils.parseRtpMap=function(line){var parts=line.substr(9).split(" ");var parsed={payloadType:parseInt(parts.shift(),10)};parts=parts[0].split("/");parsed.name=parts[0];parsed.clockRate=parseInt(parts[1],10);parsed.numChannels=parts.length===3?parseInt(parts[2],10):1;return parsed};SDPUtils.writeRtpMap=function(codec){var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}return"a=rtpmap:"+pt+" "+codec.name+"/"+codec.clockRate+(codec.numChannels!==1?"/"+codec.numChannels:"")+"\r\n"};SDPUtils.parseExtmap=function(line){var parts=line.substr(9).split(" ");return{id:parseInt(parts[0],10),direction:parts[0].indexOf("/")>0?parts[0].split("/")[1]:"sendrecv",uri:parts[1]}};SDPUtils.writeExtmap=function(headerExtension){return"a=extmap:"+(headerExtension.id||headerExtension.preferredId)+(headerExtension.direction&&headerExtension.direction!=="sendrecv"?"/"+headerExtension.direction:"")+" "+headerExtension.uri+"\r\n"};SDPUtils.parseFmtp=function(line){var parsed={};var kv;var parts=line.substr(line.indexOf(" ")+1).split(";");for(var j=0;j<parts.length;j++){kv=parts[j].trim().split("=");parsed[kv[0].trim()]=kv[1]}return parsed};SDPUtils.writeFmtp=function(codec){var line="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.parameters&&Object.keys(codec.parameters).length){var params=[];Object.keys(codec.parameters).forEach(function(param){params.push(param+"="+codec.parameters[param])});line+="a=fmtp:"+pt+" "+params.join(";")+"\r\n"}return line};SDPUtils.parseRtcpFb=function(line){var parts=line.substr(line.indexOf(" ")+1).split(" ");return{type:parts.shift(),parameter:parts.join(" ")}};SDPUtils.writeRtcpFb=function(codec){var lines="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.rtcpFeedback&&codec.rtcpFeedback.length){codec.rtcpFeedback.forEach(function(fb){lines+="a=rtcp-fb:"+pt+" "+fb.type+(fb.parameter&&fb.parameter.length?" "+fb.parameter:"")+"\r\n"})}return lines};SDPUtils.parseSsrcMedia=function(line){var sp=line.indexOf(" ");var parts={ssrc:parseInt(line.substr(7,sp-7),10)};var colon=line.indexOf(":",sp);if(colon>-1){parts.attribute=line.substr(sp+1,colon-sp-1);parts.value=line.substr(colon+1)}else{parts.attribute=line.substr(sp+1)}return parts};SDPUtils.getMid=function(mediaSection){var mid=SDPUtils.matchPrefix(mediaSection,"a=mid:")[0];if(mid){return mid.substr(6)}};SDPUtils.parseFingerprint=function(line){var parts=line.substr(14).split(" ");return{algorithm:parts[0].toLowerCase(),value:parts[1]}};SDPUtils.getDtlsParameters=function(mediaSection,sessionpart){var lines=SDPUtils.matchPrefix(mediaSection+sessionpart,"a=fingerprint:");return{role:"auto",fingerprints:lines.map(SDPUtils.parseFingerprint)}};SDPUtils.writeDtlsParameters=function(params,setupType){var sdp="a=setup:"+setupType+"\r\n";params.fingerprints.forEach(function(fp){sdp+="a=fingerprint:"+fp.algorithm+" "+fp.value+"\r\n"});return sdp};SDPUtils.getIceParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);lines=lines.concat(SDPUtils.splitLines(sessionpart));var iceParameters={usernameFragment:lines.filter(function(line){return line.indexOf("a=ice-ufrag:")===0})[0].substr(12),password:lines.filter(function(line){return line.indexOf("a=ice-pwd:")===0})[0].substr(10)};return iceParameters};SDPUtils.writeIceParameters=function(params){return"a=ice-ufrag:"+params.usernameFragment+"\r\n"+"a=ice-pwd:"+params.password+"\r\n"};SDPUtils.parseRtpParameters=function(mediaSection){var description={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].split(" ");for(var i=3;i<mline.length;i++){var pt=mline[i];var rtpmapline=SDPUtils.matchPrefix(mediaSection,"a=rtpmap:"+pt+" ")[0];if(rtpmapline){var codec=SDPUtils.parseRtpMap(rtpmapline);var fmtps=SDPUtils.matchPrefix(mediaSection,"a=fmtp:"+pt+" ");codec.parameters=fmtps.length?SDPUtils.parseFmtp(fmtps[0]):{};codec.rtcpFeedback=SDPUtils.matchPrefix(mediaSection,"a=rtcp-fb:"+pt+" ").map(SDPUtils.parseRtcpFb);description.codecs.push(codec);switch(codec.name.toUpperCase()){case"RED":case"ULPFEC":description.fecMechanisms.push(codec.name.toUpperCase());break;default:break}}}SDPUtils.matchPrefix(mediaSection,"a=extmap:").forEach(function(line){description.headerExtensions.push(SDPUtils.parseExtmap(line))});return description};SDPUtils.writeRtpDescription=function(kind,caps){var sdp="";sdp+="m="+kind+" ";sdp+=caps.codecs.length>0?"9":"0";sdp+=" UDP/TLS/RTP/SAVPF ";sdp+=caps.codecs.map(function(codec){if(codec.preferredPayloadType!==undefined){return codec.preferredPayloadType}return codec.payloadType}).join(" ")+"\r\n";sdp+="c=IN IP4 0.0.0.0\r\n";sdp+="a=rtcp:9 IN IP4 0.0.0.0\r\n";caps.codecs.forEach(function(codec){sdp+=SDPUtils.writeRtpMap(codec);sdp+=SDPUtils.writeFmtp(codec);sdp+=SDPUtils.writeRtcpFb(codec)});var maxptime=0;caps.codecs.forEach(function(codec){if(codec.maxptime>maxptime){maxptime=codec.maxptime}});if(maxptime>0){sdp+="a=maxptime:"+maxptime+"\r\n"}sdp+="a=rtcp-mux\r\n";caps.headerExtensions.forEach(function(extension){sdp+=SDPUtils.writeExtmap(extension)});return sdp};SDPUtils.parseRtpEncodingParameters=function(mediaSection){var encodingParameters=[];var description=SDPUtils.parseRtpParameters(mediaSection);var hasRed=description.fecMechanisms.indexOf("RED")!==-1;var hasUlpfec=description.fecMechanisms.indexOf("ULPFEC")!==-1;var ssrcs=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(parts){return parts.attribute==="cname"});var primarySsrc=ssrcs.length>0&&ssrcs[0].ssrc;var secondarySsrc;var flows=SDPUtils.matchPrefix(mediaSection,"a=ssrc-group:FID").map(function(line){var parts=line.split(" ");parts.shift();return parts.map(function(part){return parseInt(part,10)})});if(flows.length>0&&flows[0].length>1&&flows[0][0]===primarySsrc){secondarySsrc=flows[0][1]}description.codecs.forEach(function(codec){if(codec.name.toUpperCase()==="RTX"&&codec.parameters.apt){var encParam={ssrc:primarySsrc,codecPayloadType:parseInt(codec.parameters.apt,10),rtx:{ssrc:secondarySsrc}};encodingParameters.push(encParam);if(hasRed){encParam=JSON.parse(JSON.stringify(encParam));encParam.fec={ssrc:secondarySsrc,mechanism:hasUlpfec?"red+ulpfec":"red"};encodingParameters.push(encParam)}}});if(encodingParameters.length===0&&primarySsrc){encodingParameters.push({ssrc:primarySsrc})}var bandwidth=SDPUtils.matchPrefix(mediaSection,"b=");if(bandwidth.length){if(bandwidth[0].indexOf("b=TIAS:")===0){bandwidth=parseInt(bandwidth[0].substr(7),10)}else if(bandwidth[0].indexOf("b=AS:")===0){bandwidth=parseInt(bandwidth[0].substr(5),10)}encodingParameters.forEach(function(params){params.maxBitrate=bandwidth})}return encodingParameters};SDPUtils.parseRtcpParameters=function(mediaSection){var rtcpParameters={};var cname;var remoteSsrc=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(obj){return obj.attribute==="cname"})[0];if(remoteSsrc){rtcpParameters.cname=remoteSsrc.value;rtcpParameters.ssrc=remoteSsrc.ssrc}var rsize=SDPUtils.matchPrefix(mediaSection,"a=rtcp-rsize");rtcpParameters.reducedSize=rsize.length>0;rtcpParameters.compound=rsize.length===0;var mux=SDPUtils.matchPrefix(mediaSection,"a=rtcp-mux");rtcpParameters.mux=mux.length>0;return rtcpParameters};SDPUtils.parseMsid=function(mediaSection){var parts;var spec=SDPUtils.matchPrefix(mediaSection,"a=msid:");if(spec.length===1){parts=spec[0].substr(7).split(" ");return{stream:parts[0],track:parts[1]}}var planB=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(parts){return parts.attribute==="msid"});if(planB.length>0){parts=planB[0].value.split(" ");return{stream:parts[0],track:parts[1]}}};SDPUtils.writeSessionBoilerplate=function(){return"v=0\r\n"+"o=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\n"+"s=-\r\n"+"t=0 0\r\n"};SDPUtils.writeMediaSection=function(transceiver,caps,type,stream){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters());sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),type==="offer"?"actpass":"active");sdp+="a=mid:"+transceiver.mid+"\r\n";if(transceiver.direction){sdp+="a="+transceiver.direction+"\r\n"}else if(transceiver.rtpSender&&transceiver.rtpReceiver){sdp+="a=sendrecv\r\n"}else if(transceiver.rtpSender){sdp+="a=sendonly\r\n"}else if(transceiver.rtpReceiver){sdp+="a=recvonly\r\n"}else{sdp+="a=inactive\r\n"}if(transceiver.rtpSender){var msid="msid:"+stream.id+" "+transceiver.rtpSender.track.id+"\r\n";sdp+="a="+msid;sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid;if(transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid;sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n";if(transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"}return sdp};SDPUtils.getDirection=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);for(var i=0;i<lines.length;i++){switch(lines[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return lines[i].substr(2);default:}}if(sessionpart){return SDPUtils.getDirection(sessionpart)}return"sendrecv"};SDPUtils.getKind=function(mediaSection){var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].split(" ");return mline[0].substr(2)};SDPUtils.isRejected=function(mediaSection){return mediaSection.split(" ",2)[1]==="0"};module.exports=SDPUtils},{}],33:[function(require,module,exports){(function(global){"use strict";var transportList=require("./transport-list");module.exports=require("./main")(transportList);if("_sockjs_onload"in global){setTimeout(global._sockjs_onload,1)}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./main":46,"./transport-list":48}],34:[function(require,module,exports){"use strict";var inherits=require("inherits"),Event=require("./event");function CloseEvent(){Event.call(this);this.initEvent("close",false,false);this.wasClean=false;this.code=0;this.reason=""}inherits(CloseEvent,Event);module.exports=CloseEvent},{"./event":36,inherits:7}],35:[function(require,module,exports){"use strict";var inherits=require("inherits"),EventTarget=require("./eventtarget");function EventEmitter(){EventTarget.call(this)}inherits(EventEmitter,EventTarget);EventEmitter.prototype.removeAllListeners=function(type){if(type){delete this._listeners[type]}else{this._listeners={}}};EventEmitter.prototype.once=function(type,listener){var self=this,fired=false;function g(){self.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}this.on(type,g)};EventEmitter.prototype.emit=function(){var type=arguments[0];var listeners=this._listeners[type];if(!listeners){return}var l=arguments.length;var args=new Array(l-1);for(var ai=1;ai<l;ai++){args[ai-1]=arguments[ai]}for(var i=0;i<listeners.length;i++){listeners[i].apply(this,args)}};EventEmitter.prototype.on=EventEmitter.prototype.addListener=EventTarget.prototype.addEventListener;EventEmitter.prototype.removeListener=EventTarget.prototype.removeEventListener;module.exports.EventEmitter=EventEmitter},{"./eventtarget":37,inherits:7}],36:[function(require,module,exports){"use strict";function Event(eventType){this.type=eventType}Event.prototype.initEvent=function(eventType,canBubble,cancelable){this.type=eventType;this.bubbles=canBubble;this.cancelable=cancelable;this.timeStamp=+new Date;return this};Event.prototype.stopPropagation=function(){};Event.prototype.preventDefault=function(){};Event.CAPTURING_PHASE=1;Event.AT_TARGET=2;Event.BUBBLING_PHASE=3;module.exports=Event},{}],37:[function(require,module,exports){"use strict";function EventTarget(){this._listeners={}}EventTarget.prototype.addEventListener=function(eventType,listener){if(!(eventType in this._listeners)){this._listeners[eventType]=[]}var arr=this._listeners[eventType];if(arr.indexOf(listener)===-1){arr=arr.concat([listener])}this._listeners[eventType]=arr};EventTarget.prototype.removeEventListener=function(eventType,listener){var arr=this._listeners[eventType];if(!arr){return}var idx=arr.indexOf(listener);if(idx!==-1){if(arr.length>1){this._listeners[eventType]=arr.slice(0,idx).concat(arr.slice(idx+1))}else{delete this._listeners[eventType]}return}};EventTarget.prototype.dispatchEvent=function(){var event=arguments[0];var t=event.type;var args=arguments.length===1?[event]:Array.apply(null,arguments);if(this["on"+t]){this["on"+t].apply(this,args)}if(t in this._listeners){var listeners=this._listeners[t];for(var i=0;i<listeners.length;i++){listeners[i].apply(this,args)}}};module.exports=EventTarget},{}],38:[function(require,module,exports){"use strict";var inherits=require("inherits"),Event=require("./event");function TransportMessageEvent(data){Event.call(this);this.initEvent("message",false,false);this.data=data}inherits(TransportMessageEvent,Event);module.exports=TransportMessageEvent},{"./event":36,inherits:7}],39:[function(require,module,exports){"use strict";var JSON3=require("json3"),iframeUtils=require("./utils/iframe");function FacadeJS(transport){this._transport=transport;transport.on("message",this._transportMessage.bind(this));transport.on("close",this._transportClose.bind(this))}FacadeJS.prototype._transportClose=function(code,reason){iframeUtils.postMessage("c",JSON3.stringify([code,reason]))};FacadeJS.prototype._transportMessage=function(frame){iframeUtils.postMessage("t",frame)};FacadeJS.prototype._send=function(data){this._transport.send(data)};FacadeJS.prototype._close=function(){this._transport.close();this._transport.removeAllListeners()};module.exports=FacadeJS},{"./utils/iframe":79,json3:8}],40:[function(require,module,exports){(function(process){"use strict";var urlUtils=require("./utils/url"),eventUtils=require("./utils/event"),JSON3=require("json3"),FacadeJS=require("./facade"),InfoIframeReceiver=require("./info-iframe-receiver"),iframeUtils=require("./utils/iframe"),loc=require("./location");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:iframe-bootstrap")}module.exports=function(SockJS,availableTransports){var transportMap={};availableTransports.forEach(function(at){if(at.facadeTransport){transportMap[at.facadeTransport.transportName]=at.facadeTransport}});transportMap[InfoIframeReceiver.transportName]=InfoIframeReceiver;var parentOrigin;SockJS.bootstrap_iframe=function(){var facade;iframeUtils.currentWindowId=loc.hash.slice(1);var onMessage=function(e){if(e.source!==parent){return}if(typeof parentOrigin==="undefined"){parentOrigin=e.origin}if(e.origin!==parentOrigin){return}var iframeMessage;try{iframeMessage=JSON3.parse(e.data)}catch(ignored){debug("bad json",e.data);return}if(iframeMessage.windowId!==iframeUtils.currentWindowId){return}switch(iframeMessage.type){case"s":var p;try{p=JSON3.parse(iframeMessage.data)}catch(ignored){debug("bad json",iframeMessage.data);break}var version=p[0];var transport=p[1];var transUrl=p[2];var baseUrl=p[3];debug(version,transport,transUrl,baseUrl);if(version!==SockJS.version){throw new Error("Incompatible SockJS! Main site uses:"+' "'+version+'", the iframe:'+' "'+SockJS.version+'".')}if(!urlUtils.isOriginEqual(transUrl,loc.href)||!urlUtils.isOriginEqual(baseUrl,loc.href)){throw new Error("Can't connect to different domain from within an "+"iframe. ("+loc.href+", "+transUrl+", "+baseUrl+")")}facade=new FacadeJS(new transportMap[transport](transUrl,baseUrl));break;case"m":facade._send(iframeMessage.data);break;case"c":if(facade){facade._close()}facade=null;break}};eventUtils.attachEvent("message",onMessage);iframeUtils.postMessage("s")}}}).call(this,require("_process"))},{"./facade":39,"./info-iframe-receiver":42,"./location":45,"./utils/event":78,"./utils/iframe":79,"./utils/url":84,_process:114,debug:1,json3:8}],41:[function(require,module,exports){(function(process){"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("inherits"),JSON3=require("json3"),objectUtils=require("./utils/object");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:info-ajax")}function InfoAjax(url,AjaxObject){EventEmitter.call(this);var self=this;var t0=+new Date;this.xo=new AjaxObject("GET",url);this.xo.once("finish",function(status,text){var info,rtt;if(status===200){rtt=+new Date-t0;if(text){try{info=JSON3.parse(text)}catch(e){debug("bad json",text)}}if(!objectUtils.isObject(info)){info={}}}self.emit("finish",info,rtt);self.removeAllListeners()})}inherits(InfoAjax,EventEmitter);InfoAjax.prototype.close=function(){this.removeAllListeners();this.xo.close()};module.exports=InfoAjax}).call(this,require("_process"))},{"./utils/object":81,_process:114,debug:1,events:35,inherits:7,json3:8}],42:[function(require,module,exports){"use strict";var inherits=require("inherits"),EventEmitter=require("events").EventEmitter,JSON3=require("json3"),XHRLocalObject=require("./transport/sender/xhr-local"),InfoAjax=require("./info-ajax");function InfoReceiverIframe(transUrl){var self=this;EventEmitter.call(this);this.ir=new InfoAjax(transUrl,XHRLocalObject);this.ir.once("finish",function(info,rtt){self.ir=null;self.emit("message",JSON3.stringify([info,rtt]))})}inherits(InfoReceiverIframe,EventEmitter);InfoReceiverIframe.transportName="iframe-info-receiver";InfoReceiverIframe.prototype.close=function(){if(this.ir){this.ir.close();this.ir=null}this.removeAllListeners()};module.exports=InfoReceiverIframe},{"./info-ajax":41,"./transport/sender/xhr-local":69,events:35,inherits:7,json3:8}],43:[function(require,module,exports){(function(process,global){"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("inherits"),JSON3=require("json3"),utils=require("./utils/event"),IframeTransport=require("./transport/iframe"),InfoReceiverIframe=require("./info-iframe-receiver");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:info-iframe")}function InfoIframe(baseUrl,url){var self=this;EventEmitter.call(this);var go=function(){var ifr=self.ifr=new IframeTransport(InfoReceiverIframe.transportName,url,baseUrl);ifr.once("message",function(msg){if(msg){var d;try{d=JSON3.parse(msg)}catch(e){debug("bad json",msg);self.emit("finish");self.close();return}var info=d[0],rtt=d[1];self.emit("finish",info,rtt)}self.close()});ifr.once("close",function(){self.emit("finish");self.close()})};if(!global.document.body){utils.attachEvent("load",go)}else{go()}}inherits(InfoIframe,EventEmitter);InfoIframe.enabled=function(){return IframeTransport.enabled()};InfoIframe.prototype.close=function(){if(this.ifr){this.ifr.close()}this.removeAllListeners();this.ifr=null};module.exports=InfoIframe}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./info-iframe-receiver":42,"./transport/iframe":54,"./utils/event":78,_process:114,debug:1,events:35,inherits:7,json3:8}],44:[function(require,module,exports){(function(process){"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("inherits"),urlUtils=require("./utils/url"),XDR=require("./transport/sender/xdr"),XHRCors=require("./transport/sender/xhr-cors"),XHRLocal=require("./transport/sender/xhr-local"),XHRFake=require("./transport/sender/xhr-fake"),InfoIframe=require("./info-iframe"),InfoAjax=require("./info-ajax");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:info-receiver")}function InfoReceiver(baseUrl,urlInfo){debug(baseUrl);var self=this;EventEmitter.call(this);setTimeout(function(){self.doXhr(baseUrl,urlInfo)},0)}inherits(InfoReceiver,EventEmitter);InfoReceiver._getReceiver=function(baseUrl,url,urlInfo){if(urlInfo.sameOrigin){return new InfoAjax(url,XHRLocal)}if(XHRCors.enabled){return new InfoAjax(url,XHRCors)}if(XDR.enabled&&urlInfo.sameScheme){return new InfoAjax(url,XDR)}if(InfoIframe.enabled()){return new InfoIframe(baseUrl,url)}return new InfoAjax(url,XHRFake)};InfoReceiver.prototype.doXhr=function(baseUrl,urlInfo){var self=this,url=urlUtils.addPath(baseUrl,"/info");debug("doXhr",url);this.xo=InfoReceiver._getReceiver(baseUrl,url,urlInfo);this.timeoutRef=setTimeout(function(){debug("timeout");self._cleanup(false);self.emit("finish")},InfoReceiver.timeout);this.xo.once("finish",function(info,rtt){debug("finish",info,rtt);self._cleanup(true);self.emit("finish",info,rtt)})};InfoReceiver.prototype._cleanup=function(wasClean){debug("_cleanup");clearTimeout(this.timeoutRef);this.timeoutRef=null;if(!wasClean&&this.xo){this.xo.close()}this.xo=null};InfoReceiver.prototype.close=function(){debug("close");this.removeAllListeners();this._cleanup(false)};InfoReceiver.timeout=8e3;module.exports=InfoReceiver}).call(this,require("_process"))},{"./info-ajax":41,"./info-iframe":43,"./transport/sender/xdr":66,"./transport/sender/xhr-cors":67,"./transport/sender/xhr-fake":68,"./transport/sender/xhr-local":69,"./utils/url":84,_process:114,debug:1,events:35,inherits:7}],45:[function(require,module,exports){(function(global){"use strict";module.exports=global.location||{origin:"http://localhost:80",protocol:"http",host:"localhost",port:80,href:"http://localhost/",hash:""}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],46:[function(require,module,exports){(function(process,global){"use strict";require("./shims");var URL=require("url-parse"),inherits=require("inherits"),JSON3=require("json3"),random=require("./utils/random"),escape=require("./utils/escape"),urlUtils=require("./utils/url"),eventUtils=require("./utils/event"),transport=require("./utils/transport"),objectUtils=require("./utils/object"),browser=require("./utils/browser"),log=require("./utils/log"),Event=require("./event/event"),EventTarget=require("./event/eventtarget"),loc=require("./location"),CloseEvent=require("./event/close"),TransportMessageEvent=require("./event/trans-message"),InfoReceiver=require("./info-receiver");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:main")}var transports;function SockJS(url,protocols,options){if(!(this instanceof SockJS)){return new SockJS(url,protocols,options)}if(arguments.length<1){throw new TypeError("Failed to construct 'SockJS: 1 argument required, but only 0 present")}EventTarget.call(this);this.readyState=SockJS.CONNECTING;this.extensions="";this.protocol="";options=options||{};if(options.protocols_whitelist){log.warn("'protocols_whitelist' is DEPRECATED. Use 'transports' instead.")}this._transportsWhitelist=options.transports;this._transportOptions=options.transportOptions||{};var sessionId=options.sessionId||8;if(typeof sessionId==="function"){this._generateSessionId=sessionId}else if(typeof sessionId==="number"){this._generateSessionId=function(){return random.string(sessionId)}}else{throw new TypeError("If sessionId is used in the options, it needs to be a number or a function.")}this._server=options.server||random.numberString(1e3);var parsedUrl=new URL(url);if(!parsedUrl.host||!parsedUrl.protocol){throw new SyntaxError("The URL '"+url+"' is invalid")}else if(parsedUrl.hash){throw new SyntaxError("The URL must not contain a fragment")}else if(parsedUrl.protocol!=="http:"&&parsedUrl.protocol!=="https:"){throw new SyntaxError("The URL's scheme must be either 'http:' or 'https:'. '"+parsedUrl.protocol+"' is not allowed.")}var secure=parsedUrl.protocol==="https:";if(loc.protocol==="https"&&!secure){throw new Error("SecurityError: An insecure SockJS connection may not be initiated from a page loaded over HTTPS")}if(!protocols){protocols=[]}else if(!Array.isArray(protocols)){protocols=[protocols]}var sortedProtocols=protocols.sort();sortedProtocols.forEach(function(proto,i){if(!proto){throw new SyntaxError("The protocols entry '"+proto+"' is invalid.")}if(i<sortedProtocols.length-1&&proto===sortedProtocols[i+1]){throw new SyntaxError("The protocols entry '"+proto+"' is duplicated.")}});var o=urlUtils.getOrigin(loc.href);this._origin=o?o.toLowerCase():null;parsedUrl.set("pathname",parsedUrl.pathname.replace(/\/+$/,""));this.url=parsedUrl.href;debug("using url",this.url);this._urlInfo={nullOrigin:!browser.hasDomain(),sameOrigin:urlUtils.isOriginEqual(this.url,loc.href),sameScheme:urlUtils.isSchemeEqual(this.url,loc.href)};this._ir=new InfoReceiver(this.url,this._urlInfo);this._ir.once("finish",this._receiveInfo.bind(this))}inherits(SockJS,EventTarget);function userSetCode(code){return code===1e3||code>=3e3&&code<=4999}SockJS.prototype.close=function(code,reason){if(code&&!userSetCode(code)){throw new Error("InvalidAccessError: Invalid code")}if(reason&&reason.length>123){throw new SyntaxError("reason argument has an invalid length")}if(this.readyState===SockJS.CLOSING||this.readyState===SockJS.CLOSED){return}var wasClean=true;this._close(code||1e3,reason||"Normal closure",wasClean)};SockJS.prototype.send=function(data){if(typeof data!=="string"){data=""+data}if(this.readyState===SockJS.CONNECTING){throw new Error("InvalidStateError: The connection has not been established yet")}if(this.readyState!==SockJS.OPEN){return}this._transport.send(escape.quote(data))};SockJS.version=require("./version");SockJS.CONNECTING=0;SockJS.OPEN=1;SockJS.CLOSING=2;SockJS.CLOSED=3;SockJS.prototype._receiveInfo=function(info,rtt){debug("_receiveInfo",rtt);this._ir=null;if(!info){this._close(1002,"Cannot connect to server");return}this._rto=this.countRTO(rtt);this._transUrl=info.base_url?info.base_url:this.url;info=objectUtils.extend(info,this._urlInfo);debug("info",info);var enabledTransports=transports.filterToEnabled(this._transportsWhitelist,info);this._transports=enabledTransports.main;debug(this._transports.length+" enabled transports");this._connect()};SockJS.prototype._connect=function(){for(var Transport=this._transports.shift();Transport;Transport=this._transports.shift()){debug("attempt",Transport.transportName);if(Transport.needBody){if(!global.document.body||typeof global.document.readyState!=="undefined"&&global.document.readyState!=="complete"&&global.document.readyState!=="interactive"){debug("waiting for body");this._transports.unshift(Transport);eventUtils.attachEvent("load",this._connect.bind(this));return}}var timeoutMs=this._rto*Transport.roundTrips||5e3;this._transportTimeoutId=setTimeout(this._transportTimeout.bind(this),timeoutMs);debug("using timeout",timeoutMs);var transportUrl=urlUtils.addPath(this._transUrl,"/"+this._server+"/"+this._generateSessionId());var options=this._transportOptions[Transport.transportName];debug("transport url",transportUrl);var transportObj=new Transport(transportUrl,this._transUrl,options);transportObj.on("message",this._transportMessage.bind(this));transportObj.once("close",this._transportClose.bind(this));transportObj.transportName=Transport.transportName;this._transport=transportObj;return}this._close(2e3,"All transports failed",false)};SockJS.prototype._transportTimeout=function(){debug("_transportTimeout");if(this.readyState===SockJS.CONNECTING){this._transportClose(2007,"Transport timed out")}};SockJS.prototype._transportMessage=function(msg){debug("_transportMessage",msg);var self=this,type=msg.slice(0,1),content=msg.slice(1),payload;switch(type){case"o":this._open();return;case"h":this.dispatchEvent(new Event("heartbeat"));debug("heartbeat",this.transport);return}if(content){try{payload=JSON3.parse(content)}catch(e){debug("bad json",content)}}if(typeof payload==="undefined"){debug("empty payload",content);return}switch(type){case"a":if(Array.isArray(payload)){payload.forEach(function(p){debug("message",self.transport,p);self.dispatchEvent(new TransportMessageEvent(p))})}break;case"m":debug("message",this.transport,payload);this.dispatchEvent(new TransportMessageEvent(payload));break;case"c":if(Array.isArray(payload)&&payload.length===2){this._close(payload[0],payload[1],true)}break}};SockJS.prototype._transportClose=function(code,reason){debug("_transportClose",this.transport,code,reason);if(this._transport){this._transport.removeAllListeners();this._transport=null;this.transport=null}if(!userSetCode(code)&&code!==2e3&&this.readyState===SockJS.CONNECTING){this._connect();return}this._close(code,reason)};SockJS.prototype._open=function(){debug("_open",this._transport.transportName,this.readyState);if(this.readyState===SockJS.CONNECTING){if(this._transportTimeoutId){clearTimeout(this._transportTimeoutId);this._transportTimeoutId=null}this.readyState=SockJS.OPEN;this.transport=this._transport.transportName;this.dispatchEvent(new Event("open"));debug("connected",this.transport)}else{this._close(1006,"Server lost session")}};SockJS.prototype._close=function(code,reason,wasClean){debug("_close",this.transport,code,reason,wasClean,this.readyState);var forceFail=false;if(this._ir){forceFail=true;this._ir.close();this._ir=null}if(this._transport){this._transport.close();this._transport=null;this.transport=null}if(this.readyState===SockJS.CLOSED){throw new Error("InvalidStateError: SockJS has already been closed")}this.readyState=SockJS.CLOSING;setTimeout(function(){this.readyState=SockJS.CLOSED;if(forceFail){this.dispatchEvent(new Event("error"))}var e=new CloseEvent("close");e.wasClean=wasClean||false;e.code=code||1e3;e.reason=reason;this.dispatchEvent(e);this.onmessage=this.onclose=this.onerror=null;debug("disconnected")}.bind(this),0)};SockJS.prototype.countRTO=function(rtt){if(rtt>100){return 4*rtt}return 300+rtt};module.exports=function(availableTransports){transports=transport(availableTransports);require("./iframe-bootstrap")(SockJS,availableTransports);return SockJS}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./event/close":34,"./event/event":36,"./event/eventtarget":37,"./event/trans-message":38,"./iframe-bootstrap":40,"./info-receiver":44,"./location":45,"./shims":47,"./utils/browser":76,"./utils/escape":77,"./utils/event":78,"./utils/log":80,"./utils/object":81,"./utils/random":82,"./utils/transport":83,"./utils/url":84,"./version":85,_process:114,debug:1,inherits:7,json3:8,"url-parse":87}],47:[function(require,module,exports){"use strict";var ArrayPrototype=Array.prototype;var ObjectPrototype=Object.prototype;var FunctionPrototype=Function.prototype;var StringPrototype=String.prototype;var array_slice=ArrayPrototype.slice;var _toString=ObjectPrototype.toString;var isFunction=function(val){return ObjectPrototype.toString.call(val)==="[object Function]"};var isArray=function isArray(obj){return _toString.call(obj)==="[object Array]"};var isString=function isString(obj){return _toString.call(obj)==="[object String]"};var supportsDescriptors=Object.defineProperty&&function(){try{Object.defineProperty({},"x",{});return true}catch(e){return false}}();var defineProperty;if(supportsDescriptors){defineProperty=function(object,name,method,forceAssign){if(!forceAssign&&name in object){return}Object.defineProperty(object,name,{configurable:true,enumerable:false,writable:true,value:method})}}else{defineProperty=function(object,name,method,forceAssign){if(!forceAssign&&name in object){return}object[name]=method}}var defineProperties=function(object,map,forceAssign){for(var name in map){if(ObjectPrototype.hasOwnProperty.call(map,name)){defineProperty(object,name,map[name],forceAssign)}}};var toObject=function(o){if(o==null){throw new TypeError("can't convert "+o+" to object")}return Object(o)};function toInteger(num){var n=+num;if(n!==n){n=0}else if(n!==0&&n!==1/0&&n!==-(1/0)){n=(n>0||-1)*Math.floor(Math.abs(n))}return n}function ToUint32(x){return x>>>0}function Empty(){}defineProperties(FunctionPrototype,{bind:function bind(that){var target=this;if(!isFunction(target)){throw new TypeError("Function.prototype.bind called on incompatible "+target)}var args=array_slice.call(arguments,1);var binder=function(){if(this instanceof bound){var result=target.apply(this,args.concat(array_slice.call(arguments)));if(Object(result)===result){return result}return this}else{return target.apply(that,args.concat(array_slice.call(arguments)))}};var boundLength=Math.max(0,target.length-args.length);var boundArgs=[];for(var i=0;i<boundLength;i++){boundArgs.push("$"+i)}var bound=Function("binder","return function ("+boundArgs.join(",")+"){ return binder.apply(this, arguments); }")(binder);if(target.prototype){Empty.prototype=target.prototype;bound.prototype=new Empty;Empty.prototype=null}return bound}});defineProperties(Array,{isArray:isArray});var boxedString=Object("a");var splitString=boxedString[0]!=="a"||!(0 in boxedString);var properlyBoxesContext=function properlyBoxed(method){var properlyBoxesNonStrict=true;var properlyBoxesStrict=true;if(method){method.call("foo",function(_,__,context){if(typeof context!=="object"){properlyBoxesNonStrict=false}});method.call([1],function(){"use strict";properlyBoxesStrict=typeof this==="string"},"x")}return!!method&&properlyBoxesNonStrict&&properlyBoxesStrict};defineProperties(ArrayPrototype,{forEach:function forEach(fun){var object=toObject(this),self=splitString&&isString(this)?this.split(""):object,thisp=arguments[1],i=-1,length=self.length>>>0;if(!isFunction(fun)){throw new TypeError}while(++i<length){if(i in self){fun.call(thisp,self[i],i,object)}}}},!properlyBoxesContext(ArrayPrototype.forEach));var hasFirefox2IndexOfBug=Array.prototype.indexOf&&[0,1].indexOf(1,2)!==-1;defineProperties(ArrayPrototype,{indexOf:function indexOf(sought){var self=splitString&&isString(this)?this.split(""):toObject(this),length=self.length>>>0;if(!length){return-1}var i=0;if(arguments.length>1){i=toInteger(arguments[1])}i=i>=0?i:Math.max(0,length+i);for(;i<length;i++){if(i in self&&self[i]===sought){return i}}return-1}},hasFirefox2IndexOfBug);var string_split=StringPrototype.split;if("ab".split(/(?:ab)*/).length!==2||".".split(/(.?)(.?)/).length!==4||"tesst".split(/(s)*/)[1]==="t"||"test".split(/(?:)/,-1).length!==4||"".split(/.?/).length||".".split(/()()/).length>1){(function(){var compliantExecNpcg=/()??/.exec("")[1]===void 0;StringPrototype.split=function(separator,limit){var string=this;if(separator===void 0&&limit===0){return[]}if(_toString.call(separator)!=="[object RegExp]"){return string_split.call(this,separator,limit)}var output=[],flags=(separator.ignoreCase?"i":"")+(separator.multiline?"m":"")+(separator.extended?"x":"")+(separator.sticky?"y":""),lastLastIndex=0,separator2,match,lastIndex,lastLength;separator=new RegExp(separator.source,flags+"g");string+="";if(!compliantExecNpcg){separator2=new RegExp("^"+separator.source+"$(?!\\s)",flags)}limit=limit===void 0?-1>>>0:ToUint32(limit);while(match=separator.exec(string)){lastIndex=match.index+match[0].length;if(lastIndex>lastLastIndex){output.push(string.slice(lastLastIndex,match.index));if(!compliantExecNpcg&&match.length>1){match[0].replace(separator2,function(){for(var i=1;i<arguments.length-2;i++){if(arguments[i]===void 0){match[i]=void 0}}})}if(match.length>1&&match.index<string.length){ArrayPrototype.push.apply(output,match.slice(1))}lastLength=match[0].length;lastLastIndex=lastIndex;if(output.length>=limit){break}}if(separator.lastIndex===match.index){separator.lastIndex++}}if(lastLastIndex===string.length){if(lastLength||!separator.test("")){output.push("")}}else{output.push(string.slice(lastLastIndex))}return output.length>limit?output.slice(0,limit):output}})()}else if("0".split(void 0,0).length){StringPrototype.split=function split(separator,limit){if(separator===void 0&&limit===0){return[]}return string_split.call(this,separator,limit)}}var ws="\t\n\v\f\r "+"\u2028"+"\u2029\ufeff";var zeroWidth="";var wsRegexChars="["+ws+"]";var trimBeginRegexp=new RegExp("^"+wsRegexChars+wsRegexChars+"*");var trimEndRegexp=new RegExp(wsRegexChars+wsRegexChars+"*$");var hasTrimWhitespaceBug=StringPrototype.trim&&(ws.trim()||!zeroWidth.trim());defineProperties(StringPrototype,{trim:function trim(){if(this===void 0||this===null){throw new TypeError("can't convert "+this+" to object")}return String(this).replace(trimBeginRegexp,"").replace(trimEndRegexp,"")}},hasTrimWhitespaceBug);var string_substr=StringPrototype.substr;var hasNegativeSubstrBug="".substr&&"0b".substr(-1)!=="b";defineProperties(StringPrototype,{substr:function substr(start,length){return string_substr.call(this,start<0?(start=this.length+start)<0?0:start:start,length)}},hasNegativeSubstrBug)},{}],48:[function(require,module,exports){"use strict";module.exports=[require("./transport/websocket"),require("./transport/xhr-streaming"),require("./transport/xdr-streaming"),require("./transport/eventsource"),require("./transport/lib/iframe-wrap")(require("./transport/eventsource")),require("./transport/htmlfile"),require("./transport/lib/iframe-wrap")(require("./transport/htmlfile")),require("./transport/xhr-polling"),require("./transport/xdr-polling"),require("./transport/lib/iframe-wrap")(require("./transport/xhr-polling")),require("./transport/jsonp-polling")]},{"./transport/eventsource":52,"./transport/htmlfile":53,"./transport/jsonp-polling":55,"./transport/lib/iframe-wrap":58,"./transport/websocket":70,"./transport/xdr-polling":71,"./transport/xdr-streaming":72,"./transport/xhr-polling":73,"./transport/xhr-streaming":74}],49:[function(require,module,exports){(function(process,global){"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("inherits"),utils=require("../../utils/event"),urlUtils=require("../../utils/url"),XHR=global.XMLHttpRequest;var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:browser:xhr")}function AbstractXHRObject(method,url,payload,opts){debug(method,url);var self=this;EventEmitter.call(this);setTimeout(function(){self._start(method,url,payload,opts)},0)}inherits(AbstractXHRObject,EventEmitter);AbstractXHRObject.prototype._start=function(method,url,payload,opts){var self=this;try{this.xhr=new XHR}catch(x){}if(!this.xhr){debug("no xhr");this.emit("finish",0,"no xhr support");this._cleanup();return}url=urlUtils.addQuery(url,"t="+ +new Date);this.unloadRef=utils.unloadAdd(function(){debug("unload cleanup");self._cleanup(true)});try{this.xhr.open(method,url,true);if(this.timeout&&"timeout"in this.xhr){this.xhr.timeout=this.timeout;this.xhr.ontimeout=function(){debug("xhr timeout");self.emit("finish",0,"");self._cleanup(false)}}}catch(e){debug("exception",e);this.emit("finish",0,"");this._cleanup(false);return}if((!opts||!opts.noCredentials)&&AbstractXHRObject.supportsCORS){debug("withCredentials");this.xhr.withCredentials="true"}if(opts&&opts.headers){for(var key in opts.headers){this.xhr.setRequestHeader(key,opts.headers[key])}}this.xhr.onreadystatechange=function(){if(self.xhr){var x=self.xhr;var text,status;debug("readyState",x.readyState);switch(x.readyState){case 3:try{status=x.status;text=x.responseText}catch(e){}debug("status",status);if(status===1223){status=204}if(status===200&&text&&text.length>0){debug("chunk");self.emit("chunk",status,text)}break;case 4:status=x.status;debug("status",status);if(status===1223){status=204}if(status===12005||status===12029){status=0}debug("finish",status,x.responseText);self.emit("finish",status,x.responseText);self._cleanup(false);break}}};try{self.xhr.send(payload)}catch(e){self.emit("finish",0,"");self._cleanup(false)}};AbstractXHRObject.prototype._cleanup=function(abort){debug("cleanup");if(!this.xhr){return}this.removeAllListeners();utils.unloadDel(this.unloadRef);this.xhr.onreadystatechange=function(){};if(this.xhr.ontimeout){this.xhr.ontimeout=null}if(abort){try{this.xhr.abort()}catch(x){}}this.unloadRef=this.xhr=null};AbstractXHRObject.prototype.close=function(){debug("close");this._cleanup(true)};AbstractXHRObject.enabled=!!XHR;var axo=["Active"].concat("Object").join("X");if(!AbstractXHRObject.enabled&&axo in global){debug("overriding xmlhttprequest");XHR=function(){try{return new global[axo]("Microsoft.XMLHTTP")}catch(e){return null}};AbstractXHRObject.enabled=!!new XHR}var cors=false;try{cors="withCredentials"in new XHR}catch(ignored){}AbstractXHRObject.supportsCORS=cors;module.exports=AbstractXHRObject}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/event":78,"../../utils/url":84,_process:114,debug:1,events:35,inherits:7}],50:[function(require,module,exports){(function(global){module.exports=global.EventSource}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],51:[function(require,module,exports){(function(global){"use strict";var Driver=global.WebSocket||global.MozWebSocket;if(Driver){module.exports=function WebSocketBrowserDriver(url){return new Driver(url)}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],52:[function(require,module,exports){"use strict";var inherits=require("inherits"),AjaxBasedTransport=require("./lib/ajax-based"),EventSourceReceiver=require("./receiver/eventsource"),XHRCorsObject=require("./sender/xhr-cors"),EventSourceDriver=require("eventsource");function EventSourceTransport(transUrl){if(!EventSourceTransport.enabled()){throw new Error("Transport created when disabled")}AjaxBasedTransport.call(this,transUrl,"/eventsource",EventSourceReceiver,XHRCorsObject)}inherits(EventSourceTransport,AjaxBasedTransport);EventSourceTransport.enabled=function(){return!!EventSourceDriver};EventSourceTransport.transportName="eventsource";EventSourceTransport.roundTrips=2;module.exports=EventSourceTransport},{"./lib/ajax-based":56,"./receiver/eventsource":61,"./sender/xhr-cors":67,eventsource:50,inherits:7}],53:[function(require,module,exports){"use strict";var inherits=require("inherits"),HtmlfileReceiver=require("./receiver/htmlfile"),XHRLocalObject=require("./sender/xhr-local"),AjaxBasedTransport=require("./lib/ajax-based");function HtmlFileTransport(transUrl){if(!HtmlfileReceiver.enabled){throw new Error("Transport created when disabled")}AjaxBasedTransport.call(this,transUrl,"/htmlfile",HtmlfileReceiver,XHRLocalObject)}inherits(HtmlFileTransport,AjaxBasedTransport);HtmlFileTransport.enabled=function(info){return HtmlfileReceiver.enabled&&info.sameOrigin};HtmlFileTransport.transportName="htmlfile";HtmlFileTransport.roundTrips=2;module.exports=HtmlFileTransport},{"./lib/ajax-based":56,"./receiver/htmlfile":62,"./sender/xhr-local":69,inherits:7}],54:[function(require,module,exports){(function(process){"use strict";var inherits=require("inherits"),JSON3=require("json3"),EventEmitter=require("events").EventEmitter,version=require("../version"),urlUtils=require("../utils/url"),iframeUtils=require("../utils/iframe"),eventUtils=require("../utils/event"),random=require("../utils/random");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:transport:iframe")}function IframeTransport(transport,transUrl,baseUrl){if(!IframeTransport.enabled()){throw new Error("Transport created when disabled")}EventEmitter.call(this);var self=this;this.origin=urlUtils.getOrigin(baseUrl);this.baseUrl=baseUrl;this.transUrl=transUrl;this.transport=transport;this.windowId=random.string(8);var iframeUrl=urlUtils.addPath(baseUrl,"/iframe.html")+"#"+this.windowId;debug(transport,transUrl,iframeUrl);this.iframeObj=iframeUtils.createIframe(iframeUrl,function(r){debug("err callback");self.emit("close",1006,"Unable to load an iframe ("+r+")");self.close()});this.onmessageCallback=this._message.bind(this);eventUtils.attachEvent("message",this.onmessageCallback)}inherits(IframeTransport,EventEmitter);IframeTransport.prototype.close=function(){debug("close");this.removeAllListeners();if(this.iframeObj){eventUtils.detachEvent("message",this.onmessageCallback);try{this.postMessage("c")}catch(x){}this.iframeObj.cleanup();this.iframeObj=null;this.onmessageCallback=this.iframeObj=null}};IframeTransport.prototype._message=function(e){debug("message",e.data);if(!urlUtils.isOriginEqual(e.origin,this.origin)){debug("not same origin",e.origin,this.origin);return}var iframeMessage;try{iframeMessage=JSON3.parse(e.data)}catch(ignored){debug("bad json",e.data);return}if(iframeMessage.windowId!==this.windowId){debug("mismatched window id",iframeMessage.windowId,this.windowId);return}switch(iframeMessage.type){case"s":this.iframeObj.loaded();this.postMessage("s",JSON3.stringify([version,this.transport,this.transUrl,this.baseUrl]));break;case"t":this.emit("message",iframeMessage.data);break;case"c":var cdata;try{cdata=JSON3.parse(iframeMessage.data)}catch(ignored){debug("bad json",iframeMessage.data);return}this.emit("close",cdata[0],cdata[1]);this.close();break}};IframeTransport.prototype.postMessage=function(type,data){debug("postMessage",type,data);this.iframeObj.post(JSON3.stringify({windowId:this.windowId,type:type,data:data||""}),this.origin)};IframeTransport.prototype.send=function(message){debug("send",message);this.postMessage("m",message)};IframeTransport.enabled=function(){return iframeUtils.iframeEnabled};IframeTransport.transportName="iframe";IframeTransport.roundTrips=2;module.exports=IframeTransport}).call(this,require("_process"))},{"../utils/event":78,"../utils/iframe":79,"../utils/random":82,"../utils/url":84,"../version":85,_process:114,debug:1,events:35,inherits:7,json3:8}],55:[function(require,module,exports){(function(global){"use strict";var inherits=require("inherits"),SenderReceiver=require("./lib/sender-receiver"),JsonpReceiver=require("./receiver/jsonp"),jsonpSender=require("./sender/jsonp");function JsonPTransport(transUrl){if(!JsonPTransport.enabled()){throw new Error("Transport created when disabled")}SenderReceiver.call(this,transUrl,"/jsonp",jsonpSender,JsonpReceiver)}inherits(JsonPTransport,SenderReceiver);JsonPTransport.enabled=function(){return!!global.document};JsonPTransport.transportName="jsonp-polling";JsonPTransport.roundTrips=1;JsonPTransport.needBody=true;module.exports=JsonPTransport}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./lib/sender-receiver":60,"./receiver/jsonp":63,"./sender/jsonp":65,inherits:7}],56:[function(require,module,exports){(function(process){"use strict";var inherits=require("inherits"),urlUtils=require("../../utils/url"),SenderReceiver=require("./sender-receiver");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:ajax-based")}function createAjaxSender(AjaxObject){return function(url,payload,callback){debug("create ajax sender",url,payload);var opt={};if(typeof payload==="string"){opt.headers={"Content-type":"text/plain"}}var ajaxUrl=urlUtils.addPath(url,"/xhr_send");var xo=new AjaxObject("POST",ajaxUrl,payload,opt);xo.once("finish",function(status){debug("finish",status);xo=null;if(status!==200&&status!==204){return callback(new Error("http status "+status))}callback()});return function(){debug("abort");xo.close();xo=null;var err=new Error("Aborted");err.code=1e3;callback(err)}}}function AjaxBasedTransport(transUrl,urlSuffix,Receiver,AjaxObject){SenderReceiver.call(this,transUrl,urlSuffix,createAjaxSender(AjaxObject),Receiver,AjaxObject)}inherits(AjaxBasedTransport,SenderReceiver);module.exports=AjaxBasedTransport}).call(this,require("_process"))},{"../../utils/url":84,"./sender-receiver":60,_process:114,debug:1,inherits:7}],57:[function(require,module,exports){(function(process){"use strict";var inherits=require("inherits"),EventEmitter=require("events").EventEmitter;var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:buffered-sender")}function BufferedSender(url,sender){debug(url);EventEmitter.call(this);this.sendBuffer=[];this.sender=sender;this.url=url}inherits(BufferedSender,EventEmitter);BufferedSender.prototype.send=function(message){debug("send",message);this.sendBuffer.push(message);if(!this.sendStop){this.sendSchedule()}};BufferedSender.prototype.sendScheduleWait=function(){debug("sendScheduleWait");var self=this;var tref;this.sendStop=function(){debug("sendStop");self.sendStop=null;clearTimeout(tref)};tref=setTimeout(function(){debug("timeout");self.sendStop=null;self.sendSchedule()},25)};BufferedSender.prototype.sendSchedule=function(){debug("sendSchedule",this.sendBuffer.length);var self=this;if(this.sendBuffer.length>0){var payload="["+this.sendBuffer.join(",")+"]";this.sendStop=this.sender(this.url,payload,function(err){self.sendStop=null;if(err){debug("error",err);self.emit("close",err.code||1006,"Sending error: "+err);self._cleanup()}else{self.sendScheduleWait()}});this.sendBuffer=[]}};BufferedSender.prototype._cleanup=function(){debug("_cleanup");this.removeAllListeners()};BufferedSender.prototype.stop=function(){debug("stop");this._cleanup();if(this.sendStop){this.sendStop();this.sendStop=null}};module.exports=BufferedSender}).call(this,require("_process"))},{_process:114,debug:1,events:35,inherits:7}],58:[function(require,module,exports){(function(global){"use strict";var inherits=require("inherits"),IframeTransport=require("../iframe"),objectUtils=require("../../utils/object");module.exports=function(transport){function IframeWrapTransport(transUrl,baseUrl){IframeTransport.call(this,transport.transportName,transUrl,baseUrl)}inherits(IframeWrapTransport,IframeTransport);IframeWrapTransport.enabled=function(url,info){if(!global.document){return false}var iframeInfo=objectUtils.extend({},info);iframeInfo.sameOrigin=true;return transport.enabled(iframeInfo)&&IframeTransport.enabled()};IframeWrapTransport.transportName="iframe-"+transport.transportName;IframeWrapTransport.needBody=true;IframeWrapTransport.roundTrips=IframeTransport.roundTrips+transport.roundTrips-1;IframeWrapTransport.facadeTransport=transport;return IframeWrapTransport}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/object":81,"../iframe":54,inherits:7}],59:[function(require,module,exports){(function(process){"use strict";var inherits=require("inherits"),EventEmitter=require("events").EventEmitter;var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:polling")}function Polling(Receiver,receiveUrl,AjaxObject){debug(receiveUrl);EventEmitter.call(this);this.Receiver=Receiver;this.receiveUrl=receiveUrl;this.AjaxObject=AjaxObject;this._scheduleReceiver()}inherits(Polling,EventEmitter);Polling.prototype._scheduleReceiver=function(){debug("_scheduleReceiver");var self=this;var poll=this.poll=new this.Receiver(this.receiveUrl,this.AjaxObject);poll.on("message",function(msg){debug("message",msg);self.emit("message",msg)});poll.once("close",function(code,reason){debug("close",code,reason,self.pollIsClosing);self.poll=poll=null;if(!self.pollIsClosing){if(reason==="network"){self._scheduleReceiver()}else{self.emit("close",code||1006,reason);self.removeAllListeners()}}})};Polling.prototype.abort=function(){debug("abort");this.removeAllListeners();this.pollIsClosing=true;if(this.poll){this.poll.abort()}};module.exports=Polling}).call(this,require("_process"))},{_process:114,debug:1,events:35,inherits:7}],60:[function(require,module,exports){(function(process){"use strict";var inherits=require("inherits"),urlUtils=require("../../utils/url"),BufferedSender=require("./buffered-sender"),Polling=require("./polling");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:sender-receiver")}function SenderReceiver(transUrl,urlSuffix,senderFunc,Receiver,AjaxObject){var pollUrl=urlUtils.addPath(transUrl,urlSuffix);debug(pollUrl);var self=this;BufferedSender.call(this,transUrl,senderFunc);this.poll=new Polling(Receiver,pollUrl,AjaxObject);this.poll.on("message",function(msg){debug("poll message",msg);self.emit("message",msg)});this.poll.once("close",function(code,reason){debug("poll close",code,reason);self.poll=null;self.emit("close",code,reason);self.close()})}inherits(SenderReceiver,BufferedSender);SenderReceiver.prototype.close=function(){debug("close");this.removeAllListeners();if(this.poll){this.poll.abort();this.poll=null}this.stop()};module.exports=SenderReceiver}).call(this,require("_process"))},{"../../utils/url":84,"./buffered-sender":57,"./polling":59,_process:114,debug:1,inherits:7}],61:[function(require,module,exports){(function(process){"use strict";var inherits=require("inherits"),EventEmitter=require("events").EventEmitter,EventSourceDriver=require("eventsource");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:receiver:eventsource")}function EventSourceReceiver(url){debug(url);EventEmitter.call(this);var self=this;var es=this.es=new EventSourceDriver(url);es.onmessage=function(e){debug("message",e.data);self.emit("message",decodeURI(e.data))};es.onerror=function(e){debug("error",es.readyState,e);var reason=es.readyState!==2?"network":"permanent";self._cleanup();self._close(reason)}}inherits(EventSourceReceiver,EventEmitter);EventSourceReceiver.prototype.abort=function(){debug("abort");this._cleanup();this._close("user")};EventSourceReceiver.prototype._cleanup=function(){debug("cleanup");var es=this.es;if(es){es.onmessage=es.onerror=null;es.close();this.es=null}};EventSourceReceiver.prototype._close=function(reason){debug("close",reason);var self=this;setTimeout(function(){self.emit("close",null,reason);self.removeAllListeners()},200)};module.exports=EventSourceReceiver}).call(this,require("_process"))},{_process:114,debug:1,events:35,eventsource:50,inherits:7}],62:[function(require,module,exports){(function(process,global){"use strict";var inherits=require("inherits"),iframeUtils=require("../../utils/iframe"),urlUtils=require("../../utils/url"),EventEmitter=require("events").EventEmitter,random=require("../../utils/random");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:receiver:htmlfile")}function HtmlfileReceiver(url){debug(url);EventEmitter.call(this);var self=this;iframeUtils.polluteGlobalNamespace();this.id="a"+random.string(6);url=urlUtils.addQuery(url,"c="+decodeURIComponent(iframeUtils.WPrefix+"."+this.id));debug("using htmlfile",HtmlfileReceiver.htmlfileEnabled);var constructFunc=HtmlfileReceiver.htmlfileEnabled?iframeUtils.createHtmlfile:iframeUtils.createIframe;global[iframeUtils.WPrefix][this.id]={start:function(){debug("start");self.iframeObj.loaded()},message:function(data){debug("message",data);self.emit("message",data)},stop:function(){debug("stop");self._cleanup();self._close("network")}};this.iframeObj=constructFunc(url,function(){debug("callback");self._cleanup();self._close("permanent")})}inherits(HtmlfileReceiver,EventEmitter);HtmlfileReceiver.prototype.abort=function(){debug("abort");this._cleanup();this._close("user")};HtmlfileReceiver.prototype._cleanup=function(){debug("_cleanup");if(this.iframeObj){this.iframeObj.cleanup();this.iframeObj=null}delete global[iframeUtils.WPrefix][this.id]};HtmlfileReceiver.prototype._close=function(reason){debug("_close",reason);this.emit("close",null,reason);this.removeAllListeners()};HtmlfileReceiver.htmlfileEnabled=false;var axo=["Active"].concat("Object").join("X");if(axo in global){try{HtmlfileReceiver.htmlfileEnabled=!!new global[axo]("htmlfile")}catch(x){}}HtmlfileReceiver.enabled=HtmlfileReceiver.htmlfileEnabled||iframeUtils.iframeEnabled;module.exports=HtmlfileReceiver}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/iframe":79,"../../utils/random":82,"../../utils/url":84,_process:114,debug:1,events:35,inherits:7}],63:[function(require,module,exports){(function(process,global){"use strict";var utils=require("../../utils/iframe"),random=require("../../utils/random"),browser=require("../../utils/browser"),urlUtils=require("../../utils/url"),inherits=require("inherits"),EventEmitter=require("events").EventEmitter;var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:receiver:jsonp")}function JsonpReceiver(url){debug(url);var self=this;EventEmitter.call(this);utils.polluteGlobalNamespace();this.id="a"+random.string(6);var urlWithId=urlUtils.addQuery(url,"c="+encodeURIComponent(utils.WPrefix+"."+this.id));global[utils.WPrefix][this.id]=this._callback.bind(this);this._createScript(urlWithId);this.timeoutId=setTimeout(function(){debug("timeout");self._abort(new Error("JSONP script loaded abnormally (timeout)"))},JsonpReceiver.timeout)}inherits(JsonpReceiver,EventEmitter);JsonpReceiver.prototype.abort=function(){debug("abort");if(global[utils.WPrefix][this.id]){var err=new Error("JSONP user aborted read");err.code=1e3;this._abort(err)}};JsonpReceiver.timeout=35e3;JsonpReceiver.scriptErrorTimeout=1e3;JsonpReceiver.prototype._callback=function(data){debug("_callback",data);this._cleanup();if(this.aborting){return}if(data){debug("message",data);this.emit("message",data)}this.emit("close",null,"network");this.removeAllListeners()};JsonpReceiver.prototype._abort=function(err){debug("_abort",err);this._cleanup();this.aborting=true;this.emit("close",err.code,err.message);this.removeAllListeners()};JsonpReceiver.prototype._cleanup=function(){debug("_cleanup");clearTimeout(this.timeoutId);if(this.script2){this.script2.parentNode.removeChild(this.script2);this.script2=null}if(this.script){var script=this.script;script.parentNode.removeChild(script);script.onreadystatechange=script.onerror=script.onload=script.onclick=null;this.script=null}delete global[utils.WPrefix][this.id]};JsonpReceiver.prototype._scriptError=function(){debug("_scriptError");var self=this;if(this.errorTimer){return}this.errorTimer=setTimeout(function(){if(!self.loadedOkay){self._abort(new Error("JSONP script loaded abnormally (onerror)"))}},JsonpReceiver.scriptErrorTimeout)};JsonpReceiver.prototype._createScript=function(url){debug("_createScript",url);var self=this;var script=this.script=global.document.createElement("script");var script2;script.id="a"+random.string(8);script.src=url;script.type="text/javascript";script.charset="UTF-8";script.onerror=this._scriptError.bind(this);script.onload=function(){debug("onload");self._abort(new Error("JSONP script loaded abnormally (onload)"))};script.onreadystatechange=function(){debug("onreadystatechange",script.readyState);if(/loaded|closed/.test(script.readyState)){if(script&&script.htmlFor&&script.onclick){self.loadedOkay=true;try{script.onclick()}catch(x){}}if(script){self._abort(new Error("JSONP script loaded abnormally (onreadystatechange)"))}}};if(typeof script.async==="undefined"&&global.document.attachEvent){if(!browser.isOpera()){try{script.htmlFor=script.id;script.event="onclick"}catch(x){}script.async=true}else{script2=this.script2=global.document.createElement("script");script2.text="try{var a = document.getElementById('"+script.id+"'); if(a)a.onerror();}catch(x){};";script.async=script2.async=false}}if(typeof script.async!=="undefined"){script.async=true}var head=global.document.getElementsByTagName("head")[0];head.insertBefore(script,head.firstChild);if(script2){head.insertBefore(script2,head.firstChild)}};module.exports=JsonpReceiver}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/browser":76,"../../utils/iframe":79,"../../utils/random":82,"../../utils/url":84,_process:114,debug:1,events:35,inherits:7}],64:[function(require,module,exports){(function(process){"use strict";var inherits=require("inherits"),EventEmitter=require("events").EventEmitter;var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:receiver:xhr")}function XhrReceiver(url,AjaxObject){debug(url);EventEmitter.call(this);var self=this;this.bufferPosition=0;this.xo=new AjaxObject("POST",url,null);this.xo.on("chunk",this._chunkHandler.bind(this));this.xo.once("finish",function(status,text){debug("finish",status,text);self._chunkHandler(status,text);self.xo=null;var reason=status===200?"network":"permanent";debug("close",reason);self.emit("close",null,reason);self._cleanup()})}inherits(XhrReceiver,EventEmitter);XhrReceiver.prototype._chunkHandler=function(status,text){debug("_chunkHandler",status);if(status!==200||!text){return}for(var idx=-1;;this.bufferPosition+=idx+1){var buf=text.slice(this.bufferPosition);idx=buf.indexOf("\n");if(idx===-1){break}var msg=buf.slice(0,idx);if(msg){debug("message",msg);this.emit("message",msg)}}};XhrReceiver.prototype._cleanup=function(){debug("_cleanup");this.removeAllListeners()};XhrReceiver.prototype.abort=function(){debug("abort");if(this.xo){this.xo.close();debug("close");this.emit("close",null,"user");this.xo=null}this._cleanup()};module.exports=XhrReceiver}).call(this,require("_process"))},{_process:114,debug:1,events:35,inherits:7}],65:[function(require,module,exports){(function(process,global){"use strict";var random=require("../../utils/random"),urlUtils=require("../../utils/url");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:sender:jsonp")}var form,area;function createIframe(id){debug("createIframe",id);try{return global.document.createElement('<iframe name="'+id+'">')}catch(x){var iframe=global.document.createElement("iframe");iframe.name=id;return iframe}}function createForm(){debug("createForm");form=global.document.createElement("form");form.style.display="none";form.style.position="absolute";form.method="POST";form.enctype="application/x-www-form-urlencoded";form.acceptCharset="UTF-8";area=global.document.createElement("textarea");area.name="d";form.appendChild(area);global.document.body.appendChild(form)}module.exports=function(url,payload,callback){debug(url,payload);if(!form){createForm()}var id="a"+random.string(8);form.target=id;form.action=urlUtils.addQuery(urlUtils.addPath(url,"/jsonp_send"),"i="+id);var iframe=createIframe(id);iframe.id=id;iframe.style.display="none";form.appendChild(iframe);try{area.value=payload}catch(e){}form.submit();var completed=function(err){debug("completed",id,err);if(!iframe.onerror){return}iframe.onreadystatechange=iframe.onerror=iframe.onload=null;setTimeout(function(){debug("cleaning up",id);iframe.parentNode.removeChild(iframe);iframe=null},500);area.value="";callback(err)};iframe.onerror=function(){debug("onerror",id);completed()};iframe.onload=function(){debug("onload",id);completed()};iframe.onreadystatechange=function(e){debug("onreadystatechange",id,iframe.readyState,e);if(iframe.readyState==="complete"){completed()}};return function(){debug("aborted",id);completed(new Error("Aborted"))}}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/random":82,"../../utils/url":84,_process:114,debug:1}],66:[function(require,module,exports){(function(process,global){"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("inherits"),eventUtils=require("../../utils/event"),browser=require("../../utils/browser"),urlUtils=require("../../utils/url");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:sender:xdr")}function XDRObject(method,url,payload){debug(method,url);var self=this;EventEmitter.call(this);setTimeout(function(){self._start(method,url,payload)},0)}inherits(XDRObject,EventEmitter);XDRObject.prototype._start=function(method,url,payload){debug("_start");var self=this;var xdr=new global.XDomainRequest;url=urlUtils.addQuery(url,"t="+ +new Date);xdr.onerror=function(){debug("onerror");self._error()};xdr.ontimeout=function(){debug("ontimeout");self._error()};xdr.onprogress=function(){debug("progress",xdr.responseText);self.emit("chunk",200,xdr.responseText)};xdr.onload=function(){debug("load");self.emit("finish",200,xdr.responseText);self._cleanup(false)};this.xdr=xdr;this.unloadRef=eventUtils.unloadAdd(function(){self._cleanup(true)});try{this.xdr.open(method,url);if(this.timeout){this.xdr.timeout=this.timeout}this.xdr.send(payload)}catch(x){this._error()}};XDRObject.prototype._error=function(){this.emit("finish",0,"");this._cleanup(false)};XDRObject.prototype._cleanup=function(abort){debug("cleanup",abort);if(!this.xdr){return}this.removeAllListeners();eventUtils.unloadDel(this.unloadRef);this.xdr.ontimeout=this.xdr.onerror=this.xdr.onprogress=this.xdr.onload=null;if(abort){try{this.xdr.abort()}catch(x){}}this.unloadRef=this.xdr=null};XDRObject.prototype.close=function(){debug("close");this._cleanup(true)};XDRObject.enabled=!!(global.XDomainRequest&&browser.hasDomain());module.exports=XDRObject}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/browser":76,"../../utils/event":78,"../../utils/url":84,_process:114,debug:1,events:35,inherits:7}],67:[function(require,module,exports){"use strict";var inherits=require("inherits"),XhrDriver=require("../driver/xhr");function XHRCorsObject(method,url,payload,opts){XhrDriver.call(this,method,url,payload,opts)}inherits(XHRCorsObject,XhrDriver);XHRCorsObject.enabled=XhrDriver.enabled&&XhrDriver.supportsCORS;module.exports=XHRCorsObject},{"../driver/xhr":49,inherits:7}],68:[function(require,module,exports){"use strict";var EventEmitter=require("events").EventEmitter,inherits=require("inherits");function XHRFake(){var self=this;EventEmitter.call(this);this.to=setTimeout(function(){self.emit("finish",200,"{}")},XHRFake.timeout)}inherits(XHRFake,EventEmitter);XHRFake.prototype.close=function(){clearTimeout(this.to)};XHRFake.timeout=2e3;module.exports=XHRFake},{events:35,inherits:7}],69:[function(require,module,exports){"use strict";var inherits=require("inherits"),XhrDriver=require("../driver/xhr");function XHRLocalObject(method,url,payload){XhrDriver.call(this,method,url,payload,{noCredentials:true})}inherits(XHRLocalObject,XhrDriver);XHRLocalObject.enabled=XhrDriver.enabled;module.exports=XHRLocalObject},{"../driver/xhr":49,inherits:7}],70:[function(require,module,exports){(function(process){"use strict";var utils=require("../utils/event"),urlUtils=require("../utils/url"),inherits=require("inherits"),EventEmitter=require("events").EventEmitter,WebsocketDriver=require("./driver/websocket");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:websocket")}function WebSocketTransport(transUrl,ignore,options){if(!WebSocketTransport.enabled()){throw new Error("Transport created when disabled")}EventEmitter.call(this);debug("constructor",transUrl);var self=this;var url=urlUtils.addPath(transUrl,"/websocket");if(url.slice(0,5)==="https"){url="wss"+url.slice(5)}else{url="ws"+url.slice(4)}this.url=url;this.ws=new WebsocketDriver(this.url,[],options);this.ws.onmessage=function(e){debug("message event",e.data);self.emit("message",e.data)};this.unloadRef=utils.unloadAdd(function(){debug("unload");self.ws.close()});this.ws.onclose=function(e){debug("close event",e.code,e.reason);self.emit("close",e.code,e.reason);self._cleanup()};this.ws.onerror=function(e){debug("error event",e);self.emit("close",1006,"WebSocket connection broken");self._cleanup()}}inherits(WebSocketTransport,EventEmitter);WebSocketTransport.prototype.send=function(data){var msg="["+data+"]";debug("send",msg);this.ws.send(msg)};WebSocketTransport.prototype.close=function(){debug("close");if(this.ws){this.ws.close()}this._cleanup()};WebSocketTransport.prototype._cleanup=function(){debug("_cleanup");var ws=this.ws;if(ws){ws.onmessage=ws.onclose=ws.onerror=null}utils.unloadDel(this.unloadRef);this.unloadRef=this.ws=null;this.removeAllListeners()};WebSocketTransport.enabled=function(){debug("enabled");return!!WebsocketDriver};WebSocketTransport.transportName="websocket";WebSocketTransport.roundTrips=2;module.exports=WebSocketTransport}).call(this,require("_process"))},{"../utils/event":78,"../utils/url":84,"./driver/websocket":51,_process:114,debug:1,events:35,inherits:7}],71:[function(require,module,exports){"use strict";var inherits=require("inherits"),AjaxBasedTransport=require("./lib/ajax-based"),XdrStreamingTransport=require("./xdr-streaming"),XhrReceiver=require("./receiver/xhr"),XDRObject=require("./sender/xdr");function XdrPollingTransport(transUrl){if(!XDRObject.enabled){throw new Error("Transport created when disabled")}AjaxBasedTransport.call(this,transUrl,"/xhr",XhrReceiver,XDRObject)}inherits(XdrPollingTransport,AjaxBasedTransport);XdrPollingTransport.enabled=XdrStreamingTransport.enabled;XdrPollingTransport.transportName="xdr-polling";XdrPollingTransport.roundTrips=2;module.exports=XdrPollingTransport},{"./lib/ajax-based":56,"./receiver/xhr":64,"./sender/xdr":66,"./xdr-streaming":72,inherits:7}],72:[function(require,module,exports){"use strict";var inherits=require("inherits"),AjaxBasedTransport=require("./lib/ajax-based"),XhrReceiver=require("./receiver/xhr"),XDRObject=require("./sender/xdr");function XdrStreamingTransport(transUrl){if(!XDRObject.enabled){throw new Error("Transport created when disabled")}AjaxBasedTransport.call(this,transUrl,"/xhr_streaming",XhrReceiver,XDRObject)}inherits(XdrStreamingTransport,AjaxBasedTransport);XdrStreamingTransport.enabled=function(info){if(info.cookie_needed||info.nullOrigin){return false}return XDRObject.enabled&&info.sameScheme};XdrStreamingTransport.transportName="xdr-streaming";XdrStreamingTransport.roundTrips=2;module.exports=XdrStreamingTransport},{"./lib/ajax-based":56,"./receiver/xhr":64,"./sender/xdr":66,inherits:7}],73:[function(require,module,exports){"use strict";var inherits=require("inherits"),AjaxBasedTransport=require("./lib/ajax-based"),XhrReceiver=require("./receiver/xhr"),XHRCorsObject=require("./sender/xhr-cors"),XHRLocalObject=require("./sender/xhr-local");function XhrPollingTransport(transUrl){if(!XHRLocalObject.enabled&&!XHRCorsObject.enabled){throw new Error("Transport created when disabled")}AjaxBasedTransport.call(this,transUrl,"/xhr",XhrReceiver,XHRCorsObject)}inherits(XhrPollingTransport,AjaxBasedTransport);XhrPollingTransport.enabled=function(info){if(info.nullOrigin){return false}if(XHRLocalObject.enabled&&info.sameOrigin){return true}return XHRCorsObject.enabled};XhrPollingTransport.transportName="xhr-polling";XhrPollingTransport.roundTrips=2;module.exports=XhrPollingTransport},{"./lib/ajax-based":56,"./receiver/xhr":64,"./sender/xhr-cors":67,"./sender/xhr-local":69,inherits:7}],74:[function(require,module,exports){(function(global){"use strict";var inherits=require("inherits"),AjaxBasedTransport=require("./lib/ajax-based"),XhrReceiver=require("./receiver/xhr"),XHRCorsObject=require("./sender/xhr-cors"),XHRLocalObject=require("./sender/xhr-local"),browser=require("../utils/browser");function XhrStreamingTransport(transUrl){if(!XHRLocalObject.enabled&&!XHRCorsObject.enabled){throw new Error("Transport created when disabled")}AjaxBasedTransport.call(this,transUrl,"/xhr_streaming",XhrReceiver,XHRCorsObject)}inherits(XhrStreamingTransport,AjaxBasedTransport);XhrStreamingTransport.enabled=function(info){if(info.nullOrigin){return false}if(browser.isOpera()){return false}return XHRCorsObject.enabled};XhrStreamingTransport.transportName="xhr-streaming";XhrStreamingTransport.roundTrips=2;XhrStreamingTransport.needBody=!!global.document;module.exports=XhrStreamingTransport}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/browser":76,"./lib/ajax-based":56,"./receiver/xhr":64,"./sender/xhr-cors":67,"./sender/xhr-local":69,inherits:7}],75:[function(require,module,exports){(function(global){"use strict";if(global.crypto&&global.crypto.getRandomValues){module.exports.randomBytes=function(length){var bytes=new Uint8Array(length);global.crypto.getRandomValues(bytes);return bytes}}else{module.exports.randomBytes=function(length){var bytes=new Array(length);for(var i=0;i<length;i++){bytes[i]=Math.floor(Math.random()*256)}return bytes}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],76:[function(require,module,exports){(function(global){"use strict";module.exports={isOpera:function(){return global.navigator&&/opera/i.test(global.navigator.userAgent)},isKonqueror:function(){return global.navigator&&/konqueror/i.test(global.navigator.userAgent)},hasDomain:function(){if(!global.document){return true}try{return!!global.document.domain}catch(e){return false}}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],77:[function(require,module,exports){"use strict";var JSON3=require("json3");var extraEscapable=/[\x00-\x1f\ud800-\udfff\ufffe\uffff\u0300-\u0333\u033d-\u0346\u034a-\u034c\u0350-\u0352\u0357-\u0358\u035c-\u0362\u0374\u037e\u0387\u0591-\u05af\u05c4\u0610-\u0617\u0653-\u0654\u0657-\u065b\u065d-\u065e\u06df-\u06e2\u06eb-\u06ec\u0730\u0732-\u0733\u0735-\u0736\u073a\u073d\u073f-\u0741\u0743\u0745\u0747\u07eb-\u07f1\u0951\u0958-\u095f\u09dc-\u09dd\u09df\u0a33\u0a36\u0a59-\u0a5b\u0a5e\u0b5c-\u0b5d\u0e38-\u0e39\u0f43\u0f4d\u0f52\u0f57\u0f5c\u0f69\u0f72-\u0f76\u0f78\u0f80-\u0f83\u0f93\u0f9d\u0fa2\u0fa7\u0fac\u0fb9\u1939-\u193a\u1a17\u1b6b\u1cda-\u1cdb\u1dc0-\u1dcf\u1dfc\u1dfe\u1f71\u1f73\u1f75\u1f77\u1f79\u1f7b\u1f7d\u1fbb\u1fbe\u1fc9\u1fcb\u1fd3\u1fdb\u1fe3\u1feb\u1fee-\u1fef\u1ff9\u1ffb\u1ffd\u2000-\u2001\u20d0-\u20d1\u20d4-\u20d7\u20e7-\u20e9\u2126\u212a-\u212b\u2329-\u232a\u2adc\u302b-\u302c\uaab2-\uaab3\uf900-\ufa0d\ufa10\ufa12\ufa15-\ufa1e\ufa20\ufa22\ufa25-\ufa26\ufa2a-\ufa2d\ufa30-\ufa6d\ufa70-\ufad9\ufb1d\ufb1f\ufb2a-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufb4e\ufff0-\uffff]/g,extraLookup;var unrollLookup=function(escapable){var i;var unrolled={};var c=[];for(i=0;i<65536;i++){c.push(String.fromCharCode(i))}escapable.lastIndex=0;c.join("").replace(escapable,function(a){unrolled[a]="\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4);return""});escapable.lastIndex=0;return unrolled};module.exports={quote:function(string){var quoted=JSON3.stringify(string);extraEscapable.lastIndex=0;if(!extraEscapable.test(quoted)){return quoted}if(!extraLookup){extraLookup=unrollLookup(extraEscapable)}return quoted.replace(extraEscapable,function(a){return extraLookup[a]})}}},{json3:8}],78:[function(require,module,exports){(function(global){"use strict";var random=require("./random");var onUnload={},afterUnload=false,isChromePackagedApp=global.chrome&&global.chrome.app&&global.chrome.app.runtime;module.exports={attachEvent:function(event,listener){if(typeof global.addEventListener!=="undefined"){global.addEventListener(event,listener,false)}else if(global.document&&global.attachEvent){global.document.attachEvent("on"+event,listener);global.attachEvent("on"+event,listener)}},detachEvent:function(event,listener){if(typeof global.addEventListener!=="undefined"){global.removeEventListener(event,listener,false)}else if(global.document&&global.detachEvent){global.document.detachEvent("on"+event,listener);global.detachEvent("on"+event,listener)}},unloadAdd:function(listener){if(isChromePackagedApp){return null}var ref=random.string(8);onUnload[ref]=listener;if(afterUnload){setTimeout(this.triggerUnloadCallbacks,0)}return ref},unloadDel:function(ref){if(ref in onUnload){delete onUnload[ref]}},triggerUnloadCallbacks:function(){for(var ref in onUnload){onUnload[ref]();delete onUnload[ref]}}};var unloadTriggered=function(){if(afterUnload){return}afterUnload=true;module.exports.triggerUnloadCallbacks()};if(!isChromePackagedApp){module.exports.attachEvent("unload",unloadTriggered)}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./random":82}],79:[function(require,module,exports){(function(process,global){"use strict";var eventUtils=require("./event"),JSON3=require("json3"),browser=require("./browser");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:utils:iframe")}module.exports={WPrefix:"_jp",currentWindowId:null,polluteGlobalNamespace:function(){if(!(module.exports.WPrefix in global)){global[module.exports.WPrefix]={}}},postMessage:function(type,data){if(global.parent!==global){global.parent.postMessage(JSON3.stringify({windowId:module.exports.currentWindowId,type:type,data:data||""}),"*")}else{debug("Cannot postMessage, no parent window.",type,data)}},createIframe:function(iframeUrl,errorCallback){var iframe=global.document.createElement("iframe");var tref,unloadRef;var unattach=function(){debug("unattach");clearTimeout(tref);try{iframe.onload=null}catch(x){}iframe.onerror=null};var cleanup=function(){debug("cleanup");if(iframe){unattach();setTimeout(function(){if(iframe){iframe.parentNode.removeChild(iframe)}iframe=null},0);eventUtils.unloadDel(unloadRef)}};var onerror=function(err){debug("onerror",err);if(iframe){cleanup();errorCallback(err)}};var post=function(msg,origin){debug("post",msg,origin);try{setTimeout(function(){if(iframe&&iframe.contentWindow){iframe.contentWindow.postMessage(msg,origin)}},0)}catch(x){}};iframe.src=iframeUrl;iframe.style.display="none";iframe.style.position="absolute";iframe.onerror=function(){onerror("onerror")};iframe.onload=function(){debug("onload");clearTimeout(tref);tref=setTimeout(function(){onerror("onload timeout")},2e3)};global.document.body.appendChild(iframe);tref=setTimeout(function(){onerror("timeout")},15e3);unloadRef=eventUtils.unloadAdd(cleanup);return{post:post,cleanup:cleanup,loaded:unattach}},createHtmlfile:function(iframeUrl,errorCallback){var axo=["Active"].concat("Object").join("X");var doc=new global[axo]("htmlfile");var tref,unloadRef;var iframe;var unattach=function(){clearTimeout(tref);iframe.onerror=null};var cleanup=function(){if(doc){unattach();eventUtils.unloadDel(unloadRef);iframe.parentNode.removeChild(iframe);iframe=doc=null;CollectGarbage()}};var onerror=function(r){debug("onerror",r);if(doc){cleanup();errorCallback(r)}};var post=function(msg,origin){try{setTimeout(function(){if(iframe&&iframe.contentWindow){iframe.contentWindow.postMessage(msg,origin)}},0)}catch(x){}};doc.open();doc.write("<html><s"+"cript>"+'document.domain="'+global.document.domain+'";'+"</s"+"cript></html>");doc.close();doc.parentWindow[module.exports.WPrefix]=global[module.exports.WPrefix];var c=doc.createElement("div");doc.body.appendChild(c);iframe=doc.createElement("iframe");c.appendChild(iframe);iframe.src=iframeUrl;iframe.onerror=function(){onerror("onerror")};tref=setTimeout(function(){onerror("timeout")},15e3);unloadRef=eventUtils.unloadAdd(cleanup);return{post:post,cleanup:cleanup,loaded:unattach}}};module.exports.iframeEnabled=false;if(global.document){module.exports.iframeEnabled=(typeof global.postMessage==="function"||typeof global.postMessage==="object")&&!browser.isKonqueror()}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./browser":76,"./event":78,_process:114,debug:1,json3:8}],80:[function(require,module,exports){(function(global){"use strict";var logObject={};["log","debug","warn"].forEach(function(level){var levelExists;try{levelExists=global.console&&global.console[level]&&global.console[level].apply}catch(e){}logObject[level]=levelExists?function(){return global.console[level].apply(global.console,arguments)}:level==="log"?function(){}:logObject.log});module.exports=logObject}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],81:[function(require,module,exports){"use strict";module.exports={isObject:function(obj){var type=typeof obj;return type==="function"||type==="object"&&!!obj},extend:function(obj){if(!this.isObject(obj)){return obj}var source,prop;for(var i=1,length=arguments.length;i<length;i++){source=arguments[i];for(prop in source){if(Object.prototype.hasOwnProperty.call(source,prop)){obj[prop]=source[prop]}}}return obj}}},{}],82:[function(require,module,exports){"use strict";var crypto=require("crypto");var _randomStringChars="abcdefghijklmnopqrstuvwxyz012345";module.exports={string:function(length){var max=_randomStringChars.length;var bytes=crypto.randomBytes(length);var ret=[];for(var i=0;i<length;i++){ret.push(_randomStringChars.substr(bytes[i]%max,1))}return ret.join("")},number:function(max){return Math.floor(Math.random()*max)},numberString:function(max){var t=(""+(max-1)).length;var p=new Array(t+1).join("0");return(p+this.number(max)).slice(-t)}}},{crypto:75}],83:[function(require,module,exports){(function(process){"use strict";var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:utils:transport")}module.exports=function(availableTransports){return{filterToEnabled:function(transportsWhitelist,info){var transports={main:[],facade:[]};if(!transportsWhitelist){transportsWhitelist=[]}else if(typeof transportsWhitelist==="string"){transportsWhitelist=[transportsWhitelist]}availableTransports.forEach(function(trans){if(!trans){return}if(trans.transportName==="websocket"&&info.websocket===false){debug("disabled from server","websocket");return}if(transportsWhitelist.length&&transportsWhitelist.indexOf(trans.transportName)===-1){debug("not in whitelist",trans.transportName);return}if(trans.enabled(info)){debug("enabled",trans.transportName);transports.main.push(trans);if(trans.facadeTransport){transports.facade.push(trans.facadeTransport)}}else{debug("disabled",trans.transportName)}});return transports}}}}).call(this,require("_process"))},{_process:114,debug:1}],84:[function(require,module,exports){(function(process){"use strict";var URL=require("url-parse");var debug=function(){};if(process.env.NODE_ENV!=="production"){debug=require("debug")("sockjs-client:utils:url")}module.exports={getOrigin:function(url){if(!url){return null}var p=new URL(url);if(p.protocol==="file:"){return null}var port=p.port;if(!port){port=p.protocol==="https:"?"443":"80"}return p.protocol+"//"+p.hostname+":"+port},isOriginEqual:function(a,b){var res=this.getOrigin(a)===this.getOrigin(b);debug("same",a,b,res);return res},isSchemeEqual:function(a,b){return a.split(":")[0]===b.split(":")[0]},addPath:function(url,path){var qs=url.split("?");return qs[0]+path+(qs[1]?"?"+qs[1]:"")},addQuery:function(url,q){return url+(url.indexOf("?")===-1?"?"+q:"&"+q)}}}).call(this,require("_process"))},{_process:114,debug:1,"url-parse":87}],85:[function(require,module,exports){module.exports="1.1.1"},{}],86:[function(require,module,exports){(function(window,undefined){"use strict";var LIBVERSION="0.7.12",EMPTY="",UNKNOWN="?",FUNC_TYPE="function",UNDEF_TYPE="undefined",OBJ_TYPE="object",STR_TYPE="string",MAJOR="major",MODEL="model",NAME="name",TYPE="type",VENDOR="vendor",VERSION="version",ARCHITECTURE="architecture",CONSOLE="console",MOBILE="mobile",TABLET="tablet",SMARTTV="smarttv",WEARABLE="wearable",EMBEDDED="embedded";var util={extend:function(regexes,extensions){var margedRegexes={};for(var i in regexes){if(extensions[i]&&extensions[i].length%2===0){margedRegexes[i]=extensions[i].concat(regexes[i])}else{margedRegexes[i]=regexes[i]}}return margedRegexes},has:function(str1,str2){if(typeof str1==="string"){return str2.toLowerCase().indexOf(str1.toLowerCase())!==-1}else{return false}},lowerize:function(str){return str.toLowerCase()},major:function(version){return typeof version===STR_TYPE?version.replace(/[^\d\.]/g,"").split(".")[0]:undefined},trim:function(str){return str.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}};var mapper={rgx:function(){var result,i=0,j,k,p,q,matches,match,args=arguments;while(i<args.length&&!matches){var regex=args[i],props=args[i+1];if(typeof result===UNDEF_TYPE){result={};for(p in props){if(props.hasOwnProperty(p)){q=props[p];if(typeof q===OBJ_TYPE){result[q[0]]=undefined}else{result[q]=undefined}}}}j=k=0;while(j<regex.length&&!matches){matches=regex[j++].exec(this.getUA());if(!!matches){for(p=0;p<props.length;p++){match=matches[++k];q=props[p];if(typeof q===OBJ_TYPE&&q.length>0){if(q.length==2){if(typeof q[1]==FUNC_TYPE){result[q[0]]=q[1].call(this,match)}else{result[q[0]]=q[1]}}else if(q.length==3){if(typeof q[1]===FUNC_TYPE&&!(q[1].exec&&q[1].test)){result[q[0]]=match?q[1].call(this,match,q[2]):undefined}else{result[q[0]]=match?match.replace(q[1],q[2]):undefined}}else if(q.length==4){result[q[0]]=match?q[3].call(this,match.replace(q[1],q[2])):undefined}}else{result[q]=match?match:undefined}}}}i+=2}return result},str:function(str,map){for(var i in map){if(typeof map[i]===OBJ_TYPE&&map[i].length>0){for(var j=0;j<map[i].length;j++){if(util.has(map[i][j],str)){return i===UNKNOWN?undefined:i}}}else if(util.has(map[i],str)){return i===UNKNOWN?undefined:i}}return str}};var maps={browser:{oldsafari:{version:{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}}},device:{amazon:{model:{"Fire Phone":["SD","KF"]}},sprint:{model:{"Evo Shift 4G":"7373KT"},vendor:{HTC:"APA",Sprint:"Sprint"}}},os:{windows:{version:{ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2000:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"}}}};var regexes={browser:[[/(opera\smini)\/([\w\.-]+)/i,/(opera\s[mobiletab]+).+version\/([\w\.-]+)/i,/(opera).+version\/([\w\.]+)/i,/(opera)[\/\s]+([\w\.]+)/i],[NAME,VERSION],[/(opios)[\/\s]+([\w\.]+)/i],[[NAME,"Opera Mini"],VERSION],[/\s(opr)\/([\w\.]+)/i],[[NAME,"Opera"],VERSION],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?([\w\.]+)*/i,/(avant\s|iemobile|slim|baidu)(?:browser)?[\/\s]?([\w\.]*)/i,/(?:ms|\()(ie)\s([\w\.]+)/i,/(rekonq)\/([\w\.]+)*/i,/(chromium|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs)\/([\w\.-]+)/i],[NAME,VERSION],[/(trident).+rv[:\s]([\w\.]+).+like\sgecko/i],[[NAME,"IE"],VERSION],[/(edge)\/((\d+)?[\w\.]+)/i],[NAME,VERSION],[/(yabrowser)\/([\w\.]+)/i],[[NAME,"Yandex"],VERSION],[/(comodo_dragon)\/([\w\.]+)/i],[[NAME,/_/g," "],VERSION],[/(micromessenger)\/([\w\.]+)/i],[[NAME,"WeChat"],VERSION],[/xiaomi\/miuibrowser\/([\w\.]+)/i],[VERSION,[NAME,"MIUI Browser"]],[/\swv\).+(chrome)\/([\w\.]+)/i],[[NAME,/(.+)/,"$1 WebView"],VERSION],[/android.+samsungbrowser\/([\w\.]+)/i,/android.+version\/([\w\.]+)\s+(?:mobile\s?safari|safari)*/i],[VERSION,[NAME,"Android Browser"]],[/(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?([\w\.]+)/i,/(qqbrowser)[\/\s]?([\w\.]+)/i],[NAME,VERSION],[/(uc\s?browser)[\/\s]?([\w\.]+)/i,/ucweb.+(ucbrowser)[\/\s]?([\w\.]+)/i,/juc.+(ucweb)[\/\s]?([\w\.]+)/i],[[NAME,"UCBrowser"],VERSION],[/(dolfin)\/([\w\.]+)/i],[[NAME,"Dolphin"],VERSION],[/((?:android.+)crmo|crios)\/([\w\.]+)/i],[[NAME,"Chrome"],VERSION],[/;fbav\/([\w\.]+);/i],[VERSION,[NAME,"Facebook"]],[/fxios\/([\w\.-]+)/i],[VERSION,[NAME,"Firefox"]],[/version\/([\w\.]+).+?mobile\/\w+\s(safari)/i],[VERSION,[NAME,"Mobile Safari"]],[/version\/([\w\.]+).+?(mobile\s?safari|safari)/i],[VERSION,NAME],[/webkit.+?(mobile\s?safari|safari)(\/[\w\.]+)/i],[NAME,[VERSION,mapper.str,maps.browser.oldsafari.version]],[/(konqueror)\/([\w\.]+)/i,/(webkit|khtml)\/([\w\.]+)/i],[NAME,VERSION],[/(navigator|netscape)\/([\w\.-]+)/i],[[NAME,"Netscape"],VERSION],[/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?([\w\.\+]+)/i,/(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix)\/([\w\.-]+)/i,/(mozilla)\/([\w\.]+).+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir)[\/\s]?([\w\.]+)/i,/(links)\s\(([\w\.]+)/i,/(gobrowser)\/?([\w\.]+)*/i,/(ice\s?browser)\/v?([\w\._]+)/i,/(mosaic)[\/\s]([\w\.]+)/i],[NAME,VERSION]],cpu:[[/(?:(amd|x(?:(?:86|64)[_-])?|wow|win)64)[;\)]/i],[[ARCHITECTURE,"amd64"]],[/(ia32(?=;))/i],[[ARCHITECTURE,util.lowerize]],[/((?:i[346]|x)86)[;\)]/i],[[ARCHITECTURE,"ia32"]],[/windows\s(ce|mobile);\sppc;/i],[[ARCHITECTURE,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?:\smac|;|\))/i],[[ARCHITECTURE,/ower/,"",util.lowerize]],[/(sun4\w)[;\)]/i],[[ARCHITECTURE,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|arm(?:64|(?=v\d+;))|(?=atmel\s)avr|(?:irix|mips|sparc)(?:64)?(?=;)|pa-risc)/i],[[ARCHITECTURE,util.lowerize]]],device:[[/\((ipad|playbook);[\w\s\);-]+(rim|apple)/i],[MODEL,VENDOR,[TYPE,TABLET]],[/applecoremedia\/[\w\.]+ \((ipad)/],[MODEL,[VENDOR,"Apple"],[TYPE,TABLET]],[/(apple\s{0,1}tv)/i],[[MODEL,"Apple TV"],[VENDOR,"Apple"]],[/(archos)\s(gamepad2?)/i,/(hp).+(touchpad)/i,/(hp).+(tablet)/i,/(kindle)\/([\w\.]+)/i,/\s(nook)[\w\s]+build\/(\w+)/i,/(dell)\s(strea[kpr\s\d]*[\dko])/i],[VENDOR,MODEL,[TYPE,TABLET]],[/(kf[A-z]+)\sbuild\/[\w\.]+.*silk\//i],[MODEL,[VENDOR,"Amazon"],[TYPE,TABLET]],[/(sd|kf)[0349hijorstuw]+\sbuild\/[\w\.]+.*silk\//i],[[MODEL,mapper.str,maps.device.amazon.model],[VENDOR,"Amazon"],[TYPE,MOBILE]],[/\((ip[honed|\s\w*]+);.+(apple)/i],[MODEL,VENDOR,[TYPE,MOBILE]],[/\((ip[honed|\s\w*]+);/i],[MODEL,[VENDOR,"Apple"],[TYPE,MOBILE]],[/(blackberry)[\s-]?(\w+)/i,/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|huawei|meizu|motorola|polytron)[\s_-]?([\w-]+)*/i,/(hp)\s([\w\s]+\w)/i,/(asus)-?(\w+)/i],[VENDOR,MODEL,[TYPE,MOBILE]],[/\(bb10;\s(\w+)/i],[MODEL,[VENDOR,"BlackBerry"],[TYPE,MOBILE]],[/android.+(transfo[prime\s]{4,10}\s\w+|eeepc|slider\s\w+|nexus 7|padfone)/i],[MODEL,[VENDOR,"Asus"],[TYPE,TABLET]],[/(sony)\s(tablet\s[ps])\sbuild\//i,/(sony)?(?:sgp.+)\sbuild\//i],[[VENDOR,"Sony"],[MODEL,"Xperia Tablet"],[TYPE,TABLET]],[/(?:sony)?(?:(?:(?:c|d)\d{4})|(?:so[-l].+))\sbuild\//i],[[VENDOR,"Sony"],[MODEL,"Xperia Phone"],[TYPE,MOBILE]],[/\s(ouya)\s/i,/(nintendo)\s([wids3u]+)/i],[VENDOR,MODEL,[TYPE,CONSOLE]],[/android.+;\s(shield)\sbuild/i],[MODEL,[VENDOR,"Nvidia"],[TYPE,CONSOLE]],[/(playstation\s[34portablevi]+)/i],[MODEL,[VENDOR,"Sony"],[TYPE,CONSOLE]],[/(sprint\s(\w+))/i],[[VENDOR,mapper.str,maps.device.sprint.vendor],[MODEL,mapper.str,maps.device.sprint.model],[TYPE,MOBILE]],[/(lenovo)\s?(S(?:5000|6000)+(?:[-][\w+]))/i],[VENDOR,MODEL,[TYPE,TABLET]],[/(htc)[;_\s-]+([\w\s]+(?=\))|\w+)*/i,/(zte)-(\w+)*/i,/(alcatel|geeksphone|huawei|lenovo|nexian|panasonic|(?=;\s)sony)[_\s-]?([\w-]+)*/i],[VENDOR,[MODEL,/_/g," "],[TYPE,MOBILE]],[/(nexus\s9)/i],[MODEL,[VENDOR,"HTC"],[TYPE,TABLET]],[/(nexus\s6p)/i],[MODEL,[VENDOR,"Huawei"],[TYPE,MOBILE]],[/(microsoft);\s(lumia[\s\w]+)/i],[VENDOR,MODEL,[TYPE,MOBILE]],[/[\s\(;](xbox(?:\sone)?)[\s\);]/i],[MODEL,[VENDOR,"Microsoft"],[TYPE,CONSOLE]],[/(kin\.[onetw]{3})/i],[[MODEL,/\./g," "],[VENDOR,"Microsoft"],[TYPE,MOBILE]],[/\s(milestone|droid(?:[2-4x]|\s(?:bionic|x2|pro|razr))?(:?\s4g)?)[\w\s]+build\//i,/mot[\s-]?(\w+)*/i,/(XT\d{3,4}) build\//i,/(nexus\s6)/i],[MODEL,[VENDOR,"Motorola"],[TYPE,MOBILE]],[/android.+\s(mz60\d|xoom[\s2]{0,2})\sbuild\//i],[MODEL,[VENDOR,"Motorola"],[TYPE,TABLET]],[/hbbtv\/\d+\.\d+\.\d+\s+\([\w\s]*;\s*(\w[^;]*);([^;]*)/i],[[VENDOR,util.trim],[MODEL,util.trim],[TYPE,SMARTTV]],[/hbbtv.+maple;(\d+)/i],[[MODEL,/^/,"SmartTV"],[VENDOR,"Samsung"],[TYPE,SMARTTV]],[/\(dtv[\);].+(aquos)/i],[MODEL,[VENDOR,"Sharp"],[TYPE,SMARTTV]],[/android.+((sch-i[89]0\d|shw-m380s|gt-p\d{4}|gt-n\d+|sgh-t8[56]9|nexus 10))/i,/((SM-T\w+))/i],[[VENDOR,"Samsung"],MODEL,[TYPE,TABLET]],[/smart-tv.+(samsung)/i],[VENDOR,[TYPE,SMARTTV],MODEL],[/((s[cgp]h-\w+|gt-\w+|galaxy\snexus|sm-\w[\w\d]+))/i,/(sam[sung]*)[\s-]*(\w+-?[\w-]*)*/i,/sec-((sgh\w+))/i],[[VENDOR,"Samsung"],MODEL,[TYPE,MOBILE]],[/sie-(\w+)*/i],[MODEL,[VENDOR,"Siemens"],[TYPE,MOBILE]],[/(maemo|nokia).*(n900|lumia\s\d+)/i,/(nokia)[\s_-]?([\w-]+)*/i],[[VENDOR,"Nokia"],MODEL,[TYPE,MOBILE]],[/android\s3\.[\s\w;-]{10}(a\d{3})/i],[MODEL,[VENDOR,"Acer"],[TYPE,TABLET]],[/android\s3\.[\s\w;-]{10}(lg?)-([06cv9]{3,4})/i],[[VENDOR,"LG"],MODEL,[TYPE,TABLET]],[/(lg) netcast\.tv/i],[VENDOR,MODEL,[TYPE,SMARTTV]],[/(nexus\s[45])/i,/lg[e;\s\/-]+(\w+)*/i],[MODEL,[VENDOR,"LG"],[TYPE,MOBILE]],[/android.+(ideatab[a-z0-9\-\s]+)/i],[MODEL,[VENDOR,"Lenovo"],[TYPE,TABLET]],[/linux;.+((jolla));/i],[VENDOR,MODEL,[TYPE,MOBILE]],[/((pebble))app\/[\d\.]+\s/i],[VENDOR,MODEL,[TYPE,WEARABLE]],[/android.+;\s(glass)\s\d/i],[MODEL,[VENDOR,"Google"],[TYPE,WEARABLE]],[/android.+(\w+)\s+build\/hm\1/i,/android.+(hm[\s\-_]*note?[\s_]*(?:\d\w)?)\s+build/i,/android.+(mi[\s\-_]*(?:one|one[\s_]plus|note lte)?[\s_]*(?:\d\w)?)\s+build/i],[[MODEL,/_/g," "],[VENDOR,"Xiaomi"],[TYPE,MOBILE]],[/android.+a000(1)\s+build/i],[MODEL,[VENDOR,"OnePlus"],[TYPE,MOBILE]],[/\s(tablet)[;\/]/i,/\s(mobile)(?:[;\/]|\ssafari)/i],[[TYPE,util.lowerize],VENDOR,MODEL]],engine:[[/windows.+\sedge\/([\w\.]+)/i],[VERSION,[NAME,"EdgeHTML"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m)\/([\w\.]+)/i,/(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i,/(icab)[\/\s]([23]\.[\d\.]+)/i],[NAME,VERSION],[/rv\:([\w\.]+).*(gecko)/i],[VERSION,NAME]],os:[[/microsoft\s(windows)\s(vista|xp)/i],[NAME,VERSION],[/(windows)\snt\s6\.2;\s(arm)/i,/(windows\sphone(?:\sos)*)[\s\/]?([\d\.\s]+\w)*/i,/(windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)/i],[NAME,[VERSION,mapper.str,maps.os.windows.version]],[/(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i],[[NAME,"Windows"],[VERSION,mapper.str,maps.os.windows.version]],[/\((bb)(10);/i],[[NAME,"BlackBerry"],VERSION],[/(blackberry)\w*\/?([\w\.]+)*/i,/(tizen)[\/\s]([\w\.]+)/i,/(android|webos|palm\sos|qnx|bada|rim\stablet\sos|meego|contiki)[\/\s-]?([\w\.]+)*/i,/linux;.+(sailfish);/i],[NAME,VERSION],[/(symbian\s?os|symbos|s60(?=;))[\/\s-]?([\w\.]+)*/i],[[NAME,"Symbian"],VERSION],[/\((series40);/i],[NAME],[/mozilla.+\(mobile;.+gecko.+firefox/i],[[NAME,"Firefox OS"],VERSION],[/(nintendo|playstation)\s([wids34portablevu]+)/i,/(mint)[\/\s\(]?(\w+)*/i,/(mageia|vectorlinux)[;\s]/i,/(joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|(?=\s)arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk|linpus)[\/\s-]?(?!chrom)([\w\.-]+)*/i,/(hurd|linux)\s?([\w\.]+)*/i,/(gnu)\s?([\w\.]+)*/i],[NAME,VERSION],[/(cros)\s[\w]+\s([\w\.]+\w)/i],[[NAME,"Chromium OS"],VERSION],[/(sunos)\s?([\w\.]+\d)*/i],[[NAME,"Solaris"],VERSION],[/\s([frentopc-]{0,4}bsd|dragonfly)\s?([\w\.]+)*/i],[NAME,VERSION],[/(haiku)\s(\w+)/i],[NAME,VERSION],[/(ip[honead]+)(?:.*os\s([\w]+)*\slike\smac|;\sopera)/i],[[NAME,"iOS"],[VERSION,/_/g,"."]],[/(mac\sos\sx)\s?([\w\s\.]+\w)*/i,/(macintosh|mac(?=_powerpc)\s)/i],[[NAME,"Mac OS"],[VERSION,/_/g,"."]],[/((?:open)?solaris)[\/\s-]?([\w\.]+)*/i,/(aix)\s((\d)(?=\.|\)|\s)[\w\.]*)*/i,/(plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos|openvms)/i,/(unix)\s?([\w\.]+)*/i],[NAME,VERSION]]};var UAParser=function(uastring,extensions){if(!(this instanceof UAParser)){return new UAParser(uastring,extensions).getResult()}var ua=uastring||(window&&window.navigator&&window.navigator.userAgent?window.navigator.userAgent:EMPTY);var rgxmap=extensions?util.extend(regexes,extensions):regexes;this.getBrowser=function(){var browser=mapper.rgx.apply(this,rgxmap.browser);browser.major=util.major(browser.version);return browser};this.getCPU=function(){return mapper.rgx.apply(this,rgxmap.cpu)};this.getDevice=function(){return mapper.rgx.apply(this,rgxmap.device)};this.getEngine=function(){return mapper.rgx.apply(this,rgxmap.engine)};this.getOS=function(){return mapper.rgx.apply(this,rgxmap.os)};this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}};this.getUA=function(){return ua};this.setUA=function(uastring){ua=uastring;return this};return this};UAParser.VERSION=LIBVERSION;UAParser.BROWSER={NAME:NAME,MAJOR:MAJOR,VERSION:VERSION};UAParser.CPU={ARCHITECTURE:ARCHITECTURE};UAParser.DEVICE={MODEL:MODEL,VENDOR:VENDOR,TYPE:TYPE,CONSOLE:CONSOLE,MOBILE:MOBILE,SMARTTV:SMARTTV,TABLET:TABLET,WEARABLE:WEARABLE,EMBEDDED:EMBEDDED};UAParser.ENGINE={NAME:NAME,VERSION:VERSION};UAParser.OS={NAME:NAME,VERSION:VERSION};if(typeof exports!==UNDEF_TYPE){if(typeof module!==UNDEF_TYPE&&module.exports){exports=module.exports=UAParser}exports.UAParser=UAParser}else{if(typeof define===FUNC_TYPE&&define.amd){define(function(){return UAParser})}else{window.UAParser=UAParser}}var $=window.jQuery||window.Zepto;if(typeof $!==UNDEF_TYPE){var parser=new UAParser;$.ua=parser.getResult();$.ua.get=function(){return parser.getUA()};$.ua.set=function(uastring){parser.setUA(uastring);var result=parser.getResult();for(var prop in result){$.ua[prop]=result[prop]}}}})(typeof window==="object"?window:this)},{}],87:[function(require,module,exports){(function(global){"use strict";var required=require("requires-port"),qs=require("querystringify"),protocolre=/^([a-z][a-z0-9.+-]*:)?(\/\/)?([\S\s]*)/i,slashes=/^[A-Za-z][A-Za-z0-9+-.]*:\/\//;var rules=[["#","hash"],["?","query"],["/","pathname"],["@","auth",1],[NaN,"host",undefined,1,1],[/:(\d+)$/,"port",undefined,1],[NaN,"hostname",undefined,1,1]];var ignore={hash:1,query:1};function lolcation(loc){loc=loc||global.location||{};var finaldestination={},type=typeof loc,key;if("blob:"===loc.protocol){finaldestination=new URL(unescape(loc.pathname),{})}else if("string"===type){finaldestination=new URL(loc,{});for(key in ignore)delete finaldestination[key]}else if("object"===type){for(key in loc){if(key in ignore)continue;finaldestination[key]=loc[key]}if(finaldestination.slashes===undefined){finaldestination.slashes=slashes.test(loc.href)}}return finaldestination}function extractProtocol(address){var match=protocolre.exec(address);return{protocol:match[1]?match[1].toLowerCase():"",slashes:!!match[2],rest:match[3]}}function resolve(relative,base){var path=(base||"/").split("/").slice(0,-1).concat(relative.split("/")),i=path.length,last=path[i-1],unshift=false,up=0;while(i--){if(path[i]==="."){path.splice(i,1)}else if(path[i]===".."){path.splice(i,1);up++}else if(up){if(i===0)unshift=true;path.splice(i,1);up--}}if(unshift)path.unshift("");if(last==="."||last==="..")path.push("");return path.join("/")}function URL(address,location,parser){if(!(this instanceof URL)){return new URL(address,location,parser)}var relative,extracted,parse,instruction,index,key,instructions=rules.slice(),type=typeof location,url=this,i=0;if("object"!==type&&"string"!==type){parser=location;location=null}if(parser&&"function"!==typeof parser)parser=qs.parse;location=lolcation(location);extracted=extractProtocol(address||"");relative=!extracted.protocol&&!extracted.slashes;url.slashes=extracted.slashes||relative&&location.slashes;url.protocol=extracted.protocol||location.protocol||"";address=extracted.rest;if(!extracted.slashes)instructions[2]=[/(.*)/,"pathname"];for(;i<instructions.length;i++){instruction=instructions[i];parse=instruction[0];key=instruction[1];if(parse!==parse){url[key]=address}else if("string"===typeof parse){if(~(index=address.indexOf(parse))){if("number"===typeof instruction[2]){url[key]=address.slice(0,index);address=address.slice(index+instruction[2])}else{url[key]=address.slice(index);address=address.slice(0,index)}}}else if(index=parse.exec(address)){url[key]=index[1];address=address.slice(0,index.index)}url[key]=url[key]||(relative&&instruction[3]?location[key]||"":"");if(instruction[4])url[key]=url[key].toLowerCase()}if(parser)url.query=parser(url.query);if(relative&&location.slashes&&url.pathname.charAt(0)!=="/"&&(url.pathname!==""||location.pathname!=="")){url.pathname=resolve(url.pathname,location.pathname)}if(!required(url.port,url.protocol)){url.host=url.hostname;url.port=""}url.username=url.password="";if(url.auth){instruction=url.auth.split(":");url.username=instruction[0]||"";url.password=instruction[1]||""}url.origin=url.protocol&&url.host&&url.protocol!=="file:"?url.protocol+"//"+url.host:"null";url.href=url.toString()}function set(part,value,fn){var url=this;switch(part){case"query":if("string"===typeof value&&value.length){value=(fn||qs.parse)(value)}url[part]=value;break;case"port":url[part]=value;if(!required(value,url.protocol)){url.host=url.hostname;url[part]=""}else if(value){url.host=url.hostname+":"+value}break;case"hostname":url[part]=value;if(url.port)value+=":"+url.port;url.host=value;break;case"host":url[part]=value;if(/:\d+$/.test(value)){value=value.split(":");url.port=value.pop();url.hostname=value.join(":")}else{url.hostname=value;url.port=""}break;case"protocol":url.protocol=value.toLowerCase();url.slashes=!fn;break;case"pathname":url.pathname=value.length&&value.charAt(0)!=="/"?"/"+value:value;break;default:url[part]=value}for(var i=0;i<rules.length;i++){var ins=rules[i];if(ins[4])url[ins[1]]=url[ins[1]].toLowerCase()}url.origin=url.protocol&&url.host&&url.protocol!=="file:"?url.protocol+"//"+url.host:"null";url.href=url.toString();return url}function toString(stringify){if(!stringify||"function"!==typeof stringify)stringify=qs.stringify;var query,url=this,protocol=url.protocol;if(protocol&&protocol.charAt(protocol.length-1)!==":")protocol+=":";var result=protocol+(url.slashes?"//":"");if(url.username){result+=url.username;if(url.password)result+=":"+url.password;result+="@"}result+=url.host+url.pathname;query="object"===typeof url.query?stringify(url.query):url.query;if(query)result+="?"!==query.charAt(0)?"?"+query:query;if(url.hash)result+=url.hash;return result}URL.prototype={set:set,toString:toString};URL.extractProtocol=extractProtocol;URL.location=lolcation;URL.qs=qs;module.exports=URL}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{querystringify:88,"requires-port":23}],88:[function(require,module,exports){"use strict";var has=Object.prototype.hasOwnProperty;function decode(input){return decodeURIComponent(input.replace(/\+/g," "))}function querystring(query){var parser=/([^=?&]+)=?([^&]*)/g,result={},part;for(;part=parser.exec(query);result[decode(part[1])]=decode(part[2]));return result}function querystringify(obj,prefix){prefix=prefix||"";var pairs=[];if("string"!==typeof prefix)prefix="?";for(var key in obj){if(has.call(obj,key)){pairs.push(encodeURIComponent(key)+"="+encodeURIComponent(obj[key]))}}return pairs.length?prefix+pairs.join("&"):""}exports.stringify=querystringify;exports.parse=querystring},{}],89:[function(require,module,exports){(function(global){var rng;var crypto=global.crypto||global.msCrypto;if(crypto&&crypto.getRandomValues){var _rnds8=new Uint8Array(16);rng=function whatwgRNG(){crypto.getRandomValues(_rnds8);return _rnds8}}if(!rng){var _rnds=new Array(16);rng=function(){for(var i=0,r;i<16;i++){if((i&3)===0)r=Math.random()*4294967296;_rnds[i]=r>>>((i&3)<<3)&255}return _rnds}}module.exports=rng}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],90:[function(require,module,exports){var _rng=require("./rng");var _byteToHex=[];var _hexToByte={};for(var i=0;i<256;i++){_byteToHex[i]=(i+256).toString(16).substr(1);_hexToByte[_byteToHex[i]]=i}function parse(s,buf,offset){var i=buf&&offset||0,ii=0;buf=buf||[];s.toLowerCase().replace(/[0-9a-f]{2}/g,function(oct){if(ii<16){buf[i+ii++]=_hexToByte[oct]}});while(ii<16){buf[i+ii++]=0}return buf}function unparse(buf,offset){var i=offset||0,bth=_byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}var _seedBytes=_rng();var _nodeId=[_seedBytes[0]|1,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&16383;var _lastMSecs=0,_lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!==undefined?options.clockseq:_clockseq;var msecs=options.msecs!==undefined?options.msecs:(new Date).getTime();var nsecs=options.nsecs!==undefined?options.nsecs:_lastNSecs+1;var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&options.clockseq===undefined){clockseq=clockseq+1&16383}if((dt<0||msecs>_lastMSecs)&&options.nsecs===undefined){nsecs=0}if(nsecs>=1e4){throw new Error("uuid.v1(): Can't create more than 10M uuids/sec")}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=122192928e5;var tl=((msecs&268435455)*1e4+nsecs)%4294967296;b[i++]=tl>>>24&255;b[i++]=tl>>>16&255;b[i++]=tl>>>8&255;b[i++]=tl&255;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255;b[i++]=tmh&255;b[i++]=tmh>>>24&15|16;b[i++]=tmh>>>16&255;b[i++]=clockseq>>>8|128;b[i++]=clockseq&255;var node=options.node||_nodeId;for(var n=0;n<6;n++){b[i+n]=node[n]}return buf?buf:unparse(b)}function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=="string"){buf=options=="binary"?new Array(16):null;options=null}options=options||{};var rnds=options.random||(options.rng||_rng)();rnds[6]=rnds[6]&15|64;rnds[8]=rnds[8]&63|128;if(buf){for(var ii=0;ii<16;ii++){buf[i+ii]=rnds[ii]}}return buf||unparse(rnds)}var uuid=v4;uuid.v1=v1;uuid.v4=v4;uuid.parse=parse;uuid.unparse=unparse;module.exports=uuid},{"./rng":89}],91:[function(require,module,exports){"use strict";(function(){var utils=require("./utils");var logging=utils.log;var browserDetails=utils.browserDetails;module.exports.browserDetails=browserDetails;module.exports.extractVersion=utils.extractVersion;module.exports.disableLog=utils.disableLog;var chromeShim=require("./chrome/chrome_shim")||null;var edgeShim=require("./edge/edge_shim")||null;var firefoxShim=require("./firefox/firefox_shim")||null;var safariShim=require("./safari/safari_shim")||null;switch(browserDetails.browser){case"chrome":if(!chromeShim||!chromeShim.shimPeerConnection){logging("Chrome shim is not included in this adapter release.");return}logging("adapter.js shimming chrome.");module.exports.browserShim=chromeShim;chromeShim.shimGetUserMedia();chromeShim.shimMediaStream();utils.shimCreateObjectURL();chromeShim.shimSourceObject();chromeShim.shimPeerConnection();chromeShim.shimOnTrack();chromeShim.shimGetSendersWithDtmf();break;case"firefox":if(!firefoxShim||!firefoxShim.shimPeerConnection){logging("Firefox shim is not included in this adapter release.");return}logging("adapter.js shimming firefox.");module.exports.browserShim=firefoxShim;firefoxShim.shimGetUserMedia();utils.shimCreateObjectURL();firefoxShim.shimSourceObject();firefoxShim.shimPeerConnection();firefoxShim.shimOnTrack();break;case"edge":if(!edgeShim||!edgeShim.shimPeerConnection){logging("MS edge shim is not included in this adapter release.");return}logging("adapter.js shimming edge.");module.exports.browserShim=edgeShim;edgeShim.shimGetUserMedia();utils.shimCreateObjectURL();edgeShim.shimPeerConnection();edgeShim.shimReplaceTrack();break;case"safari":if(!safariShim){logging("Safari shim is not included in this adapter release.");return}logging("adapter.js shimming safari.");module.exports.browserShim=safariShim;safariShim.shimOnAddStream();safariShim.shimGetUserMedia();break;default:logging("Unsupported browser!")}})()},{"./chrome/chrome_shim":92,"./edge/edge_shim":94,"./firefox/firefox_shim":97,"./safari/safari_shim":99,"./utils":100}],92:[function(require,module,exports){"use strict";var logging=require("../utils.js").log;var browserDetails=require("../utils.js").browserDetails;var chromeShim={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){if(typeof window==="object"&&window.RTCPeerConnection&&!("ontrack"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(f){var self=this;if(this._ontrack){this.removeEventListener("track",this._ontrack);this.removeEventListener("addstream",this._ontrackpoly)}this.addEventListener("track",this._ontrack=f);this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(te){var event=new Event("track");event.track=te.track;event.receiver={track:te.track};event.streams=[e.stream];self.dispatchEvent(event)});e.stream.getTracks().forEach(function(track){var event=new Event("track");event.track=track;event.receiver={track:track};event.streams=[e.stream];this.dispatchEvent(event)}.bind(this))}.bind(this))}})}},shimGetSendersWithDtmf:function(){if(typeof window==="object"&&window.RTCPeerConnection&&!("getSenders"in RTCPeerConnection.prototype)&&"createDTMFSender"in RTCPeerConnection.prototype){RTCPeerConnection.prototype.getSenders=function(){return this._senders};var origAddStream=RTCPeerConnection.prototype.addStream;var origRemoveStream=RTCPeerConnection.prototype.removeStream;RTCPeerConnection.prototype.addStream=function(stream){var pc=this;pc._senders=pc._senders||[];origAddStream.apply(pc,[stream]);stream.getTracks().forEach(function(track){pc._senders.push({track:track,get dtmf(){if(this._dtmf===undefined){if(track.kind==="audio"){this._dtmf=pc.createDTMFSender(track)}else{this._dtmf=null}}return this._dtmf}})})};RTCPeerConnection.prototype.removeStream=function(stream){var pc=this;pc._senders=pc._senders||[];origRemoveStream.apply(pc,[stream]);stream.getTracks().forEach(function(track){var sender=pc._senders.find(function(s){return s.track===track});if(sender){pc._senders.splice(pc._senders.indexOf(sender),1)}})}}},shimSourceObject:function(){if(typeof window==="object"){if(window.HTMLMediaElement&&!("srcObject"in window.HTMLMediaElement.prototype)){Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(stream){var self=this;this._srcObject=stream;if(this.src){URL.revokeObjectURL(this.src)}if(!stream){this.src="";return undefined}this.src=URL.createObjectURL(stream);stream.addEventListener("addtrack",function(){if(self.src){URL.revokeObjectURL(self.src)}self.src=URL.createObjectURL(stream)});stream.addEventListener("removetrack",function(){if(self.src){URL.revokeObjectURL(self.src)}self.src=URL.createObjectURL(stream)})}})}}},shimPeerConnection:function(){if(!window.RTCPeerConnection){window.RTCPeerConnection=function(pcConfig,pcConstraints){logging("PeerConnection");if(pcConfig&&pcConfig.iceTransportPolicy){pcConfig.iceTransports=pcConfig.iceTransportPolicy}return new webkitRTCPeerConnection(pcConfig,pcConstraints)};window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype;if(webkitRTCPeerConnection.generateCertificate){Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}})}}else{var OrigPeerConnection=RTCPeerConnection;window.RTCPeerConnection=function(pcConfig,pcConstraints){if(pcConfig&&pcConfig.iceServers){var newIceServers=[];for(var i=0;i<pcConfig.iceServers.length;i++){var server=pcConfig.iceServers[i];if(!server.hasOwnProperty("urls")&&server.hasOwnProperty("url")){console.warn("RTCIceServer.url is deprecated! Use urls instead.");server=JSON.parse(JSON.stringify(server));server.urls=server.url;newIceServers.push(server)}else{newIceServers.push(pcConfig.iceServers[i])}}pcConfig.iceServers=newIceServers}return new OrigPeerConnection(pcConfig,pcConstraints)};window.RTCPeerConnection.prototype=OrigPeerConnection.prototype;Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return OrigPeerConnection.generateCertificate}})}var origGetStats=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(selector,successCallback,errorCallback){var self=this;var args=arguments;if(arguments.length>0&&typeof selector==="function"){return origGetStats.apply(this,arguments)}if(origGetStats.length===0&&(arguments.length===0||typeof arguments[0]!=="function")){return origGetStats.apply(this,[])}var fixChromeStats_=function(response){var standardReport={};var reports=response.result();reports.forEach(function(report){var standardStats={id:report.id,timestamp:report.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[report.type]||report.type};report.names().forEach(function(name){standardStats[name]=report.stat(name)});standardReport[standardStats.id]=standardStats});return standardReport};var makeMapStats=function(stats){return new Map(Object.keys(stats).map(function(key){return[key,stats[key]]}))};if(arguments.length>=2){var successCallbackWrapper_=function(response){args[1](makeMapStats(fixChromeStats_(response)))};return origGetStats.apply(this,[successCallbackWrapper_,arguments[0]])}return new Promise(function(resolve,reject){origGetStats.apply(self,[function(response){resolve(makeMapStats(fixChromeStats_(response)))},reject])}).then(successCallback,errorCallback)};if(browserDetails.version<51){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;var self=this;var promise=new Promise(function(resolve,reject){nativeMethod.apply(self,[args[0],resolve,reject])});if(args.length<2){return promise}return promise.then(function(){args[1].apply(null,[])},function(err){if(args.length>=3){args[2].apply(null,[err])}})}})}if(browserDetails.version<52){["createOffer","createAnswer"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var self=this;if(arguments.length<1||arguments.length===1&&typeof arguments[0]==="object"){var opts=arguments.length===1?arguments[0]:undefined;return new Promise(function(resolve,reject){nativeMethod.apply(self,[resolve,reject,opts])})}return nativeMethod.apply(this,arguments)}})}["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){arguments[0]=new(method==="addIceCandidate"?RTCIceCandidate:RTCSessionDescription)(arguments[0]);return nativeMethod.apply(this,arguments)}});var nativeAddIceCandidate=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}return nativeAddIceCandidate.apply(this,arguments)}}};module.exports={shimMediaStream:chromeShim.shimMediaStream,shimOnTrack:chromeShim.shimOnTrack,shimGetSendersWithDtmf:chromeShim.shimGetSendersWithDtmf,shimSourceObject:chromeShim.shimSourceObject,shimPeerConnection:chromeShim.shimPeerConnection,shimGetUserMedia:require("./getusermedia")}},{"../utils.js":100,"./getusermedia":93}],93:[function(require,module,exports){"use strict";var logging=require("../utils.js").log;var browserDetails=require("../utils.js").browserDetails;module.exports=function(){var constraintsToChrome_=function(c){if(typeof c!=="object"||c.mandatory||c.optional){return c}var cc={};Object.keys(c).forEach(function(key){if(key==="require"||key==="advanced"||key==="mediaSource"){return}var r=typeof c[key]==="object"?c[key]:{ideal:c[key]};if(r.exact!==undefined&&typeof r.exact==="number"){r.min=r.max=r.exact}var oldname_=function(prefix,name){if(prefix){return prefix+name.charAt(0).toUpperCase()+name.slice(1)}return name==="deviceId"?"sourceId":name};if(r.ideal!==undefined){cc.optional=cc.optional||[];var oc={};if(typeof r.ideal==="number"){oc[oldname_("min",key)]=r.ideal;cc.optional.push(oc);oc={};oc[oldname_("max",key)]=r.ideal;cc.optional.push(oc)}else{oc[oldname_("",key)]=r.ideal;cc.optional.push(oc)}}if(r.exact!==undefined&&typeof r.exact!=="number"){cc.mandatory=cc.mandatory||{};cc.mandatory[oldname_("",key)]=r.exact}else{["min","max"].forEach(function(mix){if(r[mix]!==undefined){cc.mandatory=cc.mandatory||{};cc.mandatory[oldname_(mix,key)]=r[mix]}})}});if(c.advanced){cc.optional=(cc.optional||[]).concat(c.advanced)}return cc};var shimConstraints_=function(constraints,func){constraints=JSON.parse(JSON.stringify(constraints));if(constraints&&constraints.audio){constraints.audio=constraintsToChrome_(constraints.audio)}if(constraints&&typeof constraints.video==="object"){var face=constraints.video.facingMode;face=face&&(typeof face==="object"?face:{ideal:face});var getSupportedFacingModeLies=browserDetails.version<61;if(face&&(face.exact==="user"||face.exact==="environment"||face.ideal==="user"||face.ideal==="environment")&&!(navigator.mediaDevices.getSupportedConstraints&&navigator.mediaDevices.getSupportedConstraints().facingMode&&!getSupportedFacingModeLies)){delete constraints.video.facingMode;var matches;if(face.exact==="environment"||face.ideal==="environment"){matches=["back","rear"]}else if(face.exact==="user"||face.ideal==="user"){matches=["front"]}if(matches){return navigator.mediaDevices.enumerateDevices().then(function(devices){devices=devices.filter(function(d){return d.kind==="videoinput"});var dev=devices.find(function(d){return matches.some(function(match){return d.label.toLowerCase().indexOf(match)!==-1})});if(!dev&&devices.length&&matches.indexOf("back")!==-1){dev=devices[devices.length-1]}if(dev){constraints.video.deviceId=face.exact?{exact:dev.deviceId}:{ideal:dev.deviceId}}constraints.video=constraintsToChrome_(constraints.video);logging("chrome: "+JSON.stringify(constraints));return func(constraints)})}}constraints.video=constraintsToChrome_(constraints.video)}logging("chrome: "+JSON.stringify(constraints));return func(constraints)};var shimError_=function(e){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};var getUserMedia_=function(constraints,onSuccess,onError){shimConstraints_(constraints,function(c){navigator.webkitGetUserMedia(c,onSuccess,function(e){onError(shimError_(e))})})};navigator.getUserMedia=getUserMedia_;var getUserMediaPromise_=function(constraints){return new Promise(function(resolve,reject){navigator.getUserMedia(constraints,resolve,reject)})};if(!navigator.mediaDevices){navigator.mediaDevices={getUserMedia:getUserMediaPromise_,enumerateDevices:function(){return new Promise(function(resolve){var kinds={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(devices){resolve(devices.map(function(device){return{label:device.label,kind:kinds[device.kind],deviceId:device.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:true,echoCancellation:true,facingMode:true,frameRate:true,height:true,width:true}}}}if(!navigator.mediaDevices.getUserMedia){navigator.mediaDevices.getUserMedia=function(constraints){return getUserMediaPromise_(constraints)}}else{var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(cs){return shimConstraints_(cs,function(c){return origGetUserMedia(c).then(function(stream){if(c.audio&&!stream.getAudioTracks().length||c.video&&!stream.getVideoTracks().length){stream.getTracks().forEach(function(track){track.stop()});throw new DOMException("","NotFoundError")}return stream},function(e){return Promise.reject(shimError_(e))})})}}if(typeof navigator.mediaDevices.addEventListener==="undefined"){navigator.mediaDevices.addEventListener=function(){logging("Dummy mediaDevices.addEventListener called.")}}if(typeof navigator.mediaDevices.removeEventListener==="undefined"){navigator.mediaDevices.removeEventListener=function(){logging("Dummy mediaDevices.removeEventListener called.")}}}},{"../utils.js":100}],94:[function(require,module,exports){"use strict";var browserDetails=require("../utils").browserDetails;var shimRTCPeerConnection=require("./rtcpeerconnection_shim");module.exports={shimGetUserMedia:require("./getusermedia"),shimPeerConnection:function(){if(window.RTCIceGatherer){if(!window.RTCIceCandidate){window.RTCIceCandidate=function(args){return args}}if(!window.RTCSessionDescription){window.RTCSessionDescription=function(args){return args}}if(browserDetails.version<15025){var origMSTEnabled=Object.getOwnPropertyDescriptor(MediaStreamTrack.prototype,"enabled");Object.defineProperty(MediaStreamTrack.prototype,"enabled",{set:function(value){origMSTEnabled.set.call(this,value);var ev=new Event("enabled");ev.enabled=value;this.dispatchEvent(ev)}})}}window.RTCPeerConnection=shimRTCPeerConnection(browserDetails.version)},shimReplaceTrack:function(){if(window.RTCRtpSender&&!("replaceTrack"in RTCRtpSender.prototype)){RTCRtpSender.prototype.replaceTrack=RTCRtpSender.prototype.setTrack}}}},{"../utils":100,"./getusermedia":95,"./rtcpeerconnection_shim":96}],95:[function(require,module,exports){"use strict";module.exports=function(){var shimError_=function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}};var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return origGetUserMedia(c).catch(function(e){return Promise.reject(shimError_(e))})}}},{}],96:[function(require,module,exports){"use strict";var SDPUtils=require("sdp");function sortTracks(tracks){var audioTracks=tracks.filter(function(track){return track.kind==="audio"});var videoTracks=tracks.filter(function(track){return track.kind==="video"});tracks=[];while(audioTracks.length||videoTracks.length){if(audioTracks.length){tracks.push(audioTracks.shift())}if(videoTracks.length){tracks.push(videoTracks.shift())}}return tracks}function filterIceServers(iceServers,edgeVersion){var hasTurn=false;iceServers=JSON.parse(JSON.stringify(iceServers));return iceServers.filter(function(server){if(server&&(server.urls||server.url)){var urls=server.urls||server.url;if(server.url&&!server.urls){console.warn("RTCIceServer.url is deprecated! Use urls instead.")}var isString=typeof urls==="string";if(isString){urls=[urls]}urls=urls.filter(function(url){var validTurn=url.indexOf("turn:")===0&&url.indexOf("transport=udp")!==-1&&url.indexOf("turn:[")===-1&&!hasTurn;if(validTurn){hasTurn=true;return true}return url.indexOf("stun:")===0&&edgeVersion>=14393});delete server.url;server.urls=isString?urls[0]:urls;return!!urls.length}return false})}module.exports=function(edgeVersion){var RTCPeerConnection=function(config){var self=this;var _eventTarget=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach(function(method){self[method]=_eventTarget[method].bind(_eventTarget)});this.onicecandidate=null;this.onaddstream=null;this.ontrack=null;this.onremovestream=null;this.onsignalingstatechange=null;this.oniceconnectionstatechange=null;this.onicegatheringstatechange=null;this.onnegotiationneeded=null;this.ondatachannel=null;this.canTrickleIceCandidates=null;this.localStreams=[];this.remoteStreams=[];this.getLocalStreams=function(){return self.localStreams};this.getRemoteStreams=function(){return self.remoteStreams};this.localDescription=new RTCSessionDescription({type:"",sdp:""});this.remoteDescription=new RTCSessionDescription({type:"",sdp:""});this.signalingState="stable";this.iceConnectionState="new";this.iceGatheringState="new";this.iceOptions={gatherPolicy:"all",iceServers:[]};if(config&&config.iceTransportPolicy){switch(config.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=config.iceTransportPolicy;break;default:break}}this.usingBundle=config&&config.bundlePolicy==="max-bundle";if(config&&config.iceServers){this.iceOptions.iceServers=filterIceServers(config.iceServers,edgeVersion)}this._config=config||{};this.transceivers=[];this._localIceCandidatesBuffer=[]};RTCPeerConnection.prototype._emitGatheringStateChange=function(){var event=new Event("icegatheringstatechange");this.dispatchEvent(event);if(this.onicegatheringstatechange!==null){this.onicegatheringstatechange(event)}};RTCPeerConnection.prototype._emitBufferedCandidates=function(){var self=this;var sections=SDPUtils.splitSections(self.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(event){var end=!event.candidate||Object.keys(event.candidate).length===0;if(end){for(var j=1;j<sections.length;j++){if(sections[j].indexOf("\r\na=end-of-candidates\r\n")===-1){sections[j]+="a=end-of-candidates\r\n"}}}else{sections[event.candidate.sdpMLineIndex+1]+="a="+event.candidate.candidate+"\r\n"}self.localDescription.sdp=sections.join("");self.dispatchEvent(event);if(self.onicecandidate!==null){self.onicecandidate(event)}if(!event.candidate&&self.iceGatheringState!=="complete"){var complete=self.transceivers.every(function(transceiver){return transceiver.iceGatherer&&transceiver.iceGatherer.state==="completed"});if(complete&&self.iceGatheringStateChange!=="complete"){self.iceGatheringState="complete";self._emitGatheringStateChange()}}});this._localIceCandidatesBuffer=[]};RTCPeerConnection.prototype.getConfiguration=function(){return this._config};RTCPeerConnection.prototype.addStream=function(stream){if(edgeVersion>=15025){this.localStreams.push(stream)}else{var clonedStream=stream.clone();stream.getTracks().forEach(function(track,idx){var clonedTrack=clonedStream.getTracks()[idx];track.addEventListener("enabled",function(event){clonedTrack.enabled=event.enabled})});this.localStreams.push(clonedStream)}this._maybeFireNegotiationNeeded()};RTCPeerConnection.prototype.removeStream=function(stream){var idx=this.localStreams.indexOf(stream);if(idx>-1){this.localStreams.splice(idx,1);this._maybeFireNegotiationNeeded()}};RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpSender}).map(function(transceiver){return transceiver.rtpSender})};RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpReceiver}).map(function(transceiver){return transceiver.rtpReceiver})};RTCPeerConnection.prototype._getCommonCapabilities=function(localCapabilities,remoteCapabilities){var commonCapabilities={codecs:[],headerExtensions:[],fecMechanisms:[]};var findCodecByPayloadType=function(pt,codecs){pt=parseInt(pt,10);for(var i=0;i<codecs.length;i++){if(codecs[i].payloadType===pt||codecs[i].preferredPayloadType===pt){return codecs[i]}}};var rtxCapabilityMatches=function(lRtx,rRtx,lCodecs,rCodecs){var lCodec=findCodecByPayloadType(lRtx.parameters.apt,lCodecs);var rCodec=findCodecByPayloadType(rRtx.parameters.apt,rCodecs);return lCodec&&rCodec&&lCodec.name.toLowerCase()===rCodec.name.toLowerCase()};localCapabilities.codecs.forEach(function(lCodec){for(var i=0;i<remoteCapabilities.codecs.length;i++){var rCodec=remoteCapabilities.codecs[i];if(lCodec.name.toLowerCase()===rCodec.name.toLowerCase()&&lCodec.clockRate===rCodec.clockRate){if(lCodec.name.toLowerCase()==="rtx"&&lCodec.parameters&&rCodec.parameters.apt){if(!rtxCapabilityMatches(lCodec,rCodec,localCapabilities.codecs,remoteCapabilities.codecs)){continue}}rCodec=JSON.parse(JSON.stringify(rCodec));rCodec.numChannels=Math.min(lCodec.numChannels,rCodec.numChannels);commonCapabilities.codecs.push(rCodec);rCodec.rtcpFeedback=rCodec.rtcpFeedback.filter(function(fb){for(var j=0;j<lCodec.rtcpFeedback.length;j++){if(lCodec.rtcpFeedback[j].type===fb.type&&lCodec.rtcpFeedback[j].parameter===fb.parameter){return true}}return false});break}}});localCapabilities.headerExtensions.forEach(function(lHeaderExtension){for(var i=0;i<remoteCapabilities.headerExtensions.length;i++){var rHeaderExtension=remoteCapabilities.headerExtensions[i];if(lHeaderExtension.uri===rHeaderExtension.uri){commonCapabilities.headerExtensions.push(rHeaderExtension);break}}});return commonCapabilities};RTCPeerConnection.prototype._createIceAndDtlsTransports=function(mid,sdpMLineIndex){var self=this;var iceGatherer=new RTCIceGatherer(self.iceOptions);var iceTransport=new RTCIceTransport(iceGatherer);iceGatherer.onlocalcandidate=function(evt){var event=new Event("icecandidate");event.candidate={sdpMid:mid,sdpMLineIndex:sdpMLineIndex};var cand=evt.candidate;var end=!cand||Object.keys(cand).length===0;if(end){if(iceGatherer.state===undefined){iceGatherer.state="completed"}}else{cand.component=iceTransport.component==="RTCP"?2:1;event.candidate.candidate=SDPUtils.writeCandidate(cand)}var sections=SDPUtils.splitSections(self.localDescription.sdp);if(!end){sections[event.candidate.sdpMLineIndex+1]+="a="+event.candidate.candidate+"\r\n"}else{sections[event.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n"}self.localDescription.sdp=sections.join("");var transceivers=self._pendingOffer?self._pendingOffer:self.transceivers;var complete=transceivers.every(function(transceiver){return transceiver.iceGatherer&&transceiver.iceGatherer.state==="completed"});switch(self.iceGatheringState){case"new":if(!end){self._localIceCandidatesBuffer.push(event)}if(end&&complete){self._localIceCandidatesBuffer.push(new Event("icecandidate"))}break;case"gathering":self._emitBufferedCandidates();if(!end){self.dispatchEvent(event);if(self.onicecandidate!==null){self.onicecandidate(event)}}if(complete){self.dispatchEvent(new Event("icecandidate"));if(self.onicecandidate!==null){self.onicecandidate(new Event("icecandidate"))}self.iceGatheringState="complete";self._emitGatheringStateChange()}break;case"complete":break;default:break}};iceTransport.onicestatechange=function(){self._updateConnectionState()};var dtlsTransport=new RTCDtlsTransport(iceTransport);dtlsTransport.ondtlsstatechange=function(){self._updateConnectionState()};dtlsTransport.onerror=function(){dtlsTransport.state="failed";self._updateConnectionState()};return{iceGatherer:iceGatherer,iceTransport:iceTransport,dtlsTransport:dtlsTransport}};RTCPeerConnection.prototype._disposeIceAndDtlsTransports=function(sdpMLineIndex){var iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;if(iceGatherer){delete iceGatherer.onlocalcandidate;delete this.transceivers[sdpMLineIndex].iceGatherer}var iceTransport=this.transceivers[sdpMLineIndex].iceTransport;if(iceTransport){delete iceTransport.onicestatechange;delete this.transceivers[sdpMLineIndex].iceTransport}var dtlsTransport=this.transceivers[sdpMLineIndex].dtlsTransport;if(dtlsTransport){delete dtlsTransport.ondtlssttatechange;delete dtlsTransport.onerror;delete this.transceivers[sdpMLineIndex].dtlsTransport}};RTCPeerConnection.prototype._transceive=function(transceiver,send,recv){var params=this._getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);if(send&&transceiver.rtpSender){params.encodings=transceiver.sendEncodingParameters;params.rtcp={cname:SDPUtils.localCName,compound:transceiver.rtcpParameters.compound};if(transceiver.recvEncodingParameters.length){params.rtcp.ssrc=transceiver.recvEncodingParameters[0].ssrc}transceiver.rtpSender.send(params)}if(recv&&transceiver.rtpReceiver){if(transceiver.kind==="video"&&transceiver.recvEncodingParameters&&edgeVersion<15019){transceiver.recvEncodingParameters.forEach(function(p){delete p.rtx})}params.encodings=transceiver.recvEncodingParameters;params.rtcp={cname:transceiver.rtcpParameters.cname,compound:transceiver.rtcpParameters.compound};if(transceiver.sendEncodingParameters.length){params.rtcp.ssrc=transceiver.sendEncodingParameters[0].ssrc}transceiver.rtpReceiver.receive(params)}};RTCPeerConnection.prototype.setLocalDescription=function(description){var self=this;var sections;var sessionpart;if(description.type==="offer"){if(this._pendingOffer){sections=SDPUtils.splitSections(description.sdp);sessionpart=sections.shift();sections.forEach(function(mediaSection,sdpMLineIndex){var caps=SDPUtils.parseRtpParameters(mediaSection);self._pendingOffer[sdpMLineIndex].localCapabilities=caps});this.transceivers=this._pendingOffer;delete this._pendingOffer}}else if(description.type==="answer"){sections=SDPUtils.splitSections(self.remoteDescription.sdp);sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver=self.transceivers[sdpMLineIndex];var iceGatherer=transceiver.iceGatherer;var iceTransport=transceiver.iceTransport;var dtlsTransport=transceiver.dtlsTransport;var localCapabilities=transceiver.localCapabilities;var remoteCapabilities=transceiver.remoteCapabilities;var rejected=mediaSection.split("\n",1)[0].split(" ",2)[1]==="0";if(!rejected&&!transceiver.isDatachannel){var remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);var remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);if(isIceLite){remoteDtlsParameters.role="server"}if(!self.usingBundle||sdpMLineIndex===0){iceTransport.start(iceGatherer,remoteIceParameters,isIceLite?"controlling":"controlled");dtlsTransport.start(remoteDtlsParameters)}var params=self._getCommonCapabilities(localCapabilities,remoteCapabilities);self._transceive(transceiver,params.codecs.length>0,false)}})}this.localDescription={type:description.type,sdp:description.sdp};switch(description.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+description.type+'"')}var hasCallback=arguments.length>1&&typeof arguments[1]==="function";if(hasCallback){var cb=arguments[1];window.setTimeout(function(){cb();if(self.iceGatheringState==="new"){self.iceGatheringState="gathering";self._emitGatheringStateChange()}self._emitBufferedCandidates()},0)}var p=Promise.resolve();p.then(function(){if(!hasCallback){if(self.iceGatheringState==="new"){self.iceGatheringState="gathering";self._emitGatheringStateChange()}window.setTimeout(self._emitBufferedCandidates.bind(self),500)}});return p};RTCPeerConnection.prototype.setRemoteDescription=function(description){var self=this;var streams={};var receiverList=[];var sections=SDPUtils.splitSections(description.sdp);var sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;var usingBundle=SDPUtils.matchPrefix(sessionpart,"a=group:BUNDLE ").length>0;var iceOptions=SDPUtils.matchPrefix(sessionpart,"a=ice-options:")[0];if(iceOptions){this.canTrickleIceCandidates=iceOptions.substr(14).split(" ").indexOf("trickle")>=0}else{this.canTrickleIceCandidates=false}sections.forEach(function(mediaSection,sdpMLineIndex){var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].substr(2).split(" ");var kind=mline[0];var rejected=mline[1]==="0";var direction=SDPUtils.getDirection(mediaSection,sessionpart);var remoteMsid=SDPUtils.parseMsid(mediaSection);var mid=SDPUtils.matchPrefix(mediaSection,"a=mid:");if(mid.length){mid=mid[0].substr(6)}else{mid=SDPUtils.generateIdentifier()}if(kind==="application"&&mline[2]==="DTLS/SCTP"){self.transceivers[sdpMLineIndex]={mid:mid,isDatachannel:true};return}var transceiver;var iceGatherer;var iceTransport;var dtlsTransport;var rtpSender;var rtpReceiver;var sendEncodingParameters;var recvEncodingParameters;var localCapabilities;var track;var remoteCapabilities=SDPUtils.parseRtpParameters(mediaSection);var remoteIceParameters;var remoteDtlsParameters;if(!rejected){remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);remoteDtlsParameters.role="client"}recvEncodingParameters=SDPUtils.parseRtpEncodingParameters(mediaSection);var rtcpParameters=SDPUtils.parseRtcpParameters(mediaSection);var isComplete=SDPUtils.matchPrefix(mediaSection,"a=end-of-candidates",sessionpart).length>0;var cands=SDPUtils.matchPrefix(mediaSection,"a=candidate:").map(function(cand){return SDPUtils.parseCandidate(cand)}).filter(function(cand){return cand.component==="1"});if(description.type==="offer"&&!rejected){var transports=usingBundle&&sdpMLineIndex>0?{iceGatherer:self.transceivers[0].iceGatherer,iceTransport:self.transceivers[0].iceTransport,dtlsTransport:self.transceivers[0].dtlsTransport}:self._createIceAndDtlsTransports(mid,sdpMLineIndex);if(isComplete&&(!usingBundle||sdpMLineIndex===0)){transports.iceTransport.setRemoteCandidates(cands)}localCapabilities=RTCRtpReceiver.getCapabilities(kind);if(edgeVersion<15019){localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return codec.name!=="rtx"})}sendEncodingParameters=[{ssrc:(2*sdpMLineIndex+2)*1001}];if(direction==="sendrecv"||direction==="sendonly"){rtpReceiver=new RTCRtpReceiver(transports.dtlsTransport,kind);track=rtpReceiver.track;if(remoteMsid){if(!streams[remoteMsid.stream]){streams[remoteMsid.stream]=new MediaStream;Object.defineProperty(streams[remoteMsid.stream],"id",{get:function(){return remoteMsid.stream}})}Object.defineProperty(track,"id",{get:function(){return remoteMsid.track}});streams[remoteMsid.stream].addTrack(track);receiverList.push([track,rtpReceiver,streams[remoteMsid.stream]])}else{if(!streams.default){streams.default=new MediaStream}streams.default.addTrack(track);receiverList.push([track,rtpReceiver,streams.default])}}if(self.localStreams.length>0&&self.localStreams[0].getTracks().length>=sdpMLineIndex){var localTrack;if(kind==="audio"){localTrack=self.localStreams[0].getAudioTracks()[0]}else if(kind==="video"){localTrack=self.localStreams[0].getVideoTracks()[0]}if(localTrack){if(edgeVersion>=15019&&kind==="video"){sendEncodingParameters[0].rtx={ssrc:(2*sdpMLineIndex+2)*1001+1}}rtpSender=new RTCRtpSender(localTrack,transports.dtlsTransport)}}self.transceivers[sdpMLineIndex]={iceGatherer:transports.iceGatherer,iceTransport:transports.iceTransport,dtlsTransport:transports.dtlsTransport,localCapabilities:localCapabilities,remoteCapabilities:remoteCapabilities,rtpSender:rtpSender,rtpReceiver:rtpReceiver,kind:kind,mid:mid,rtcpParameters:rtcpParameters,sendEncodingParameters:sendEncodingParameters,recvEncodingParameters:recvEncodingParameters};self._transceive(self.transceivers[sdpMLineIndex],false,direction==="sendrecv"||direction==="sendonly")}else if(description.type==="answer"&&!rejected){if(usingBundle&&sdpMLineIndex>0){self._disposeIceAndDtlsTransports(sdpMLineIndex);self.transceivers[sdpMLineIndex].iceGatherer=self.transceivers[0].iceGatherer;self.transceivers[sdpMLineIndex].iceTransport=self.transceivers[0].iceTransport;self.transceivers[sdpMLineIndex].dtlsTransport=self.transceivers[0].dtlsTransport;if(self.transceivers[sdpMLineIndex].rtpSender){self.transceivers[sdpMLineIndex].rtpSender.setTransport(self.transceivers[0].dtlsTransport)}if(self.transceivers[sdpMLineIndex].rtpReceiver){self.transceivers[sdpMLineIndex].rtpReceiver.setTransport(self.transceivers[0].dtlsTransport)}}transceiver=self.transceivers[sdpMLineIndex];iceGatherer=transceiver.iceGatherer;iceTransport=transceiver.iceTransport;dtlsTransport=transceiver.dtlsTransport;rtpSender=transceiver.rtpSender;rtpReceiver=transceiver.rtpReceiver;sendEncodingParameters=transceiver.sendEncodingParameters;localCapabilities=transceiver.localCapabilities;self.transceivers[sdpMLineIndex].recvEncodingParameters=recvEncodingParameters;self.transceivers[sdpMLineIndex].remoteCapabilities=remoteCapabilities;self.transceivers[sdpMLineIndex].rtcpParameters=rtcpParameters;if((isIceLite||isComplete)&&cands.length){iceTransport.setRemoteCandidates(cands)}if(!usingBundle||sdpMLineIndex===0){iceTransport.start(iceGatherer,remoteIceParameters,"controlling");dtlsTransport.start(remoteDtlsParameters)}self._transceive(transceiver,direction==="sendrecv"||direction==="recvonly",direction==="sendrecv"||direction==="sendonly");if(rtpReceiver&&(direction==="sendrecv"||direction==="sendonly")){track=rtpReceiver.track;receiverList.push([track,rtpReceiver]);if(remoteMsid){if(!streams[remoteMsid.stream]){streams[remoteMsid.stream]=new MediaStream}streams[remoteMsid.stream].addTrack(track)}else{if(!streams.default){streams.default=new MediaStream}streams.default.addTrack(track)}}else{delete transceiver.rtpReceiver}}});this.usingBundle=usingBundle;this.remoteDescription={type:description.type,sdp:description.sdp};switch(description.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+description.type+'"')}Object.keys(streams).forEach(function(sid){var stream=streams[sid];if(stream.getTracks().length){self.remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream;self.dispatchEvent(event);if(self.onaddstream!==null){window.setTimeout(function(){self.onaddstream(event)},0)}receiverList.forEach(function(item){var track=item[0];var receiver=item[1];if(stream.id!==item[2].id){return}var trackEvent=new Event("track");trackEvent.track=track;trackEvent.receiver=receiver;trackEvent.streams=[stream];self.dispatchEvent(trackEvent);if(self.ontrack!==null){window.setTimeout(function(){self.ontrack(trackEvent)},0)}})}});if(arguments.length>1&&typeof arguments[1]==="function"){window.setTimeout(arguments[1],0)}return Promise.resolve()};RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(transceiver){if(transceiver.iceTransport){transceiver.iceTransport.stop()}if(transceiver.dtlsTransport){transceiver.dtlsTransport.stop()}if(transceiver.rtpSender){transceiver.rtpSender.stop()}if(transceiver.rtpReceiver){transceiver.rtpReceiver.stop()}});this._updateSignalingState("closed")};RTCPeerConnection.prototype._updateSignalingState=function(newState){this.signalingState=newState;var event=new Event("signalingstatechange");this.dispatchEvent(event);if(this.onsignalingstatechange!==null){this.onsignalingstatechange(event)}};RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var event=new Event("negotiationneeded");this.dispatchEvent(event);if(this.onnegotiationneeded!==null){this.onnegotiationneeded(event)}};RTCPeerConnection.prototype._updateConnectionState=function(){var self=this;var newState;var states={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};this.transceivers.forEach(function(transceiver){states[transceiver.iceTransport.state]++;states[transceiver.dtlsTransport.state]++});states.connected+=states.completed;newState="new";if(states.failed>0){newState="failed"}else if(states.connecting>0||states.checking>0){newState="connecting"}else if(states.disconnected>0){newState="disconnected"}else if(states.new>0){newState="new"}else if(states.connected>0||states.completed>0){newState="connected"}if(newState!==self.iceConnectionState){self.iceConnectionState=newState;var event=new Event("iceconnectionstatechange");this.dispatchEvent(event);if(this.oniceconnectionstatechange!==null){this.oniceconnectionstatechange(event)}}};RTCPeerConnection.prototype.createOffer=function(){var self=this;if(this._pendingOffer){throw new Error("createOffer called while there is a pending offer.")}var offerOptions;if(arguments.length===1&&typeof arguments[0]!=="function"){offerOptions=arguments[0]}else if(arguments.length===3){offerOptions=arguments[2]}var tracks=[];var numAudioTracks=0;var numVideoTracks=0;if(this.localStreams.length){numAudioTracks=this.localStreams.reduce(function(numTracks,stream){return numTracks+stream.getAudioTracks().length},0);numVideoTracks=this.localStreams.reduce(function(numTracks,stream){return numTracks+stream.getVideoTracks().length},0)}if(offerOptions){if(offerOptions.mandatory||offerOptions.optional){throw new TypeError("Legacy mandatory/optional constraints not supported.")}if(offerOptions.offerToReceiveAudio!==undefined){numAudioTracks=offerOptions.offerToReceiveAudio}if(offerOptions.offerToReceiveVideo!==undefined){numVideoTracks=offerOptions.offerToReceiveVideo}}this.localStreams.forEach(function(localStream){localStream.getTracks().forEach(function(track){tracks.push({kind:track.kind,track:track,stream:localStream,wantReceive:track.kind==="audio"?numAudioTracks>0:numVideoTracks>0});if(track.kind==="audio"){numAudioTracks--}else if(track.kind==="video"){numVideoTracks--}})});while(numAudioTracks>0||numVideoTracks>0){if(numAudioTracks>0){tracks.push({kind:"audio",wantReceive:true});numAudioTracks--}if(numVideoTracks>0){tracks.push({kind:"video",wantReceive:true});numVideoTracks--}}tracks=sortTracks(tracks);var sdp=SDPUtils.writeSessionBoilerplate();var transceivers=[];tracks.forEach(function(mline,sdpMLineIndex){var track=mline.track;var kind=mline.kind;var mid=SDPUtils.generateIdentifier();var transports=self.usingBundle&&sdpMLineIndex>0?{iceGatherer:transceivers[0].iceGatherer,iceTransport:transceivers[0].iceTransport,dtlsTransport:transceivers[0].dtlsTransport}:self._createIceAndDtlsTransports(mid,sdpMLineIndex);var localCapabilities=RTCRtpSender.getCapabilities(kind);if(edgeVersion<15019){localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return codec.name!=="rtx"})}localCapabilities.codecs.forEach(function(codec){if(codec.name==="H264"&&codec.parameters["level-asymmetry-allowed"]===undefined){codec.parameters["level-asymmetry-allowed"]="1"}});var rtpSender;var rtpReceiver;var sendEncodingParameters=[{ssrc:(2*sdpMLineIndex+1)*1001}];if(track){if(edgeVersion>=15019&&kind==="video"){sendEncodingParameters[0].rtx={ssrc:(2*sdpMLineIndex+1)*1001+1}}rtpSender=new RTCRtpSender(track,transports.dtlsTransport)}if(mline.wantReceive){rtpReceiver=new RTCRtpReceiver(transports.dtlsTransport,kind)}transceivers[sdpMLineIndex]={iceGatherer:transports.iceGatherer,iceTransport:transports.iceTransport,dtlsTransport:transports.dtlsTransport,localCapabilities:localCapabilities,remoteCapabilities:null,rtpSender:rtpSender,rtpReceiver:rtpReceiver,kind:kind,mid:mid,sendEncodingParameters:sendEncodingParameters,recvEncodingParameters:null}});if(this._config.bundlePolicy!=="max-compat"){sdp+="a=group:BUNDLE "+transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}sdp+="a=ice-options:trickle\r\n";tracks.forEach(function(mline,sdpMLineIndex){var transceiver=transceivers[sdpMLineIndex];sdp+=SDPUtils.writeMediaSection(transceiver,transceiver.localCapabilities,"offer",mline.stream);sdp+="a=rtcp-rsize\r\n"});this._pendingOffer=transceivers;var desc=new RTCSessionDescription({type:"offer",sdp:sdp});if(arguments.length&&typeof arguments[0]==="function"){window.setTimeout(arguments[0],0,desc)}return Promise.resolve(desc)};RTCPeerConnection.prototype.createAnswer=function(){var self=this;var sdp=SDPUtils.writeSessionBoilerplate();if(this.usingBundle){sdp+="a=group:BUNDLE "+this.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}this.transceivers.forEach(function(transceiver){if(transceiver.isDatachannel){sdp+="m=application 0 DTLS/SCTP 5000\r\n"+"c=IN IP4 0.0.0.0\r\n"+"a=mid:"+transceiver.mid+"\r\n";return}var commonCapabilities=self._getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);var hasRtx=commonCapabilities.codecs.filter(function(c){return c.name.toLowerCase()==="rtx"}).length;if(!hasRtx&&transceiver.sendEncodingParameters[0].rtx){delete transceiver.sendEncodingParameters[0].rtx}sdp+=SDPUtils.writeMediaSection(transceiver,commonCapabilities,"answer",self.localStreams[0]);if(transceiver.rtcpParameters&&transceiver.rtcpParameters.reducedSize){sdp+="a=rtcp-rsize\r\n"}});var desc=new RTCSessionDescription({type:"answer",sdp:sdp});if(arguments.length&&typeof arguments[0]==="function"){window.setTimeout(arguments[0],0,desc)}return Promise.resolve(desc)};RTCPeerConnection.prototype.addIceCandidate=function(candidate){if(!candidate){for(var j=0;j<this.transceivers.length;j++){this.transceivers[j].iceTransport.addRemoteCandidate({});if(this.usingBundle){return Promise.resolve()}}}else{var mLineIndex=candidate.sdpMLineIndex;if(candidate.sdpMid){for(var i=0;i<this.transceivers.length;i++){if(this.transceivers[i].mid===candidate.sdpMid){mLineIndex=i;break}}}var transceiver=this.transceivers[mLineIndex];if(transceiver){var cand=Object.keys(candidate.candidate).length>0?SDPUtils.parseCandidate(candidate.candidate):{};if(cand.protocol==="tcp"&&(cand.port===0||cand.port===9)){return Promise.resolve()}if(cand.component!=="1"){return Promise.resolve()}transceiver.iceTransport.addRemoteCandidate(cand);var sections=SDPUtils.splitSections(this.remoteDescription.sdp);sections[mLineIndex+1]+=(cand.type?candidate.candidate.trim():"a=end-of-candidates")+"\r\n";this.remoteDescription.sdp=sections.join("")}}if(arguments.length>1&&typeof arguments[1]==="function"){window.setTimeout(arguments[1],0)}return Promise.resolve()};RTCPeerConnection.prototype.getStats=function(){var promises=[];this.transceivers.forEach(function(transceiver){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(method){if(transceiver[method]){promises.push(transceiver[method].getStats())}})});var cb=arguments.length>1&&typeof arguments[1]==="function"&&arguments[1];var fixStatsType=function(stat){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[stat.type]||stat.type};return new Promise(function(resolve){var results=new Map;Promise.all(promises).then(function(res){res.forEach(function(result){Object.keys(result).forEach(function(id){result[id].type=fixStatsType(result[id]);results.set(id,result[id])})});if(cb){window.setTimeout(cb,0,results)}resolve(results)})})};return RTCPeerConnection}},{sdp:32}],97:[function(require,module,exports){"use strict";var browserDetails=require("../utils").browserDetails;var firefoxShim={shimOnTrack:function(){if(typeof window==="object"&&window.RTCPeerConnection&&!("ontrack"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(f){if(this._ontrack){this.removeEventListener("track",this._ontrack);this.removeEventListener("addstream",this._ontrackpoly)}this.addEventListener("track",this._ontrack=f);this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(track){var event=new Event("track");event.track=track;event.receiver={track:track};event.streams=[e.stream];this.dispatchEvent(event)}.bind(this))}.bind(this))}})}},shimSourceObject:function(){if(typeof window==="object"){if(window.HTMLMediaElement&&!("srcObject"in window.HTMLMediaElement.prototype)){Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(stream){this.mozSrcObject=stream}})}}},shimPeerConnection:function(){if(typeof window!=="object"||!(window.RTCPeerConnection||window.mozRTCPeerConnection)){return}if(!window.RTCPeerConnection){window.RTCPeerConnection=function(pcConfig,pcConstraints){if(browserDetails.version<38){if(pcConfig&&pcConfig.iceServers){var newIceServers=[];for(var i=0;i<pcConfig.iceServers.length;i++){var server=pcConfig.iceServers[i];if(server.hasOwnProperty("urls")){for(var j=0;j<server.urls.length;j++){var newServer={url:server.urls[j]};if(server.urls[j].indexOf("turn")===0){newServer.username=server.username;newServer.credential=server.credential}newIceServers.push(newServer)}}else{newIceServers.push(pcConfig.iceServers[i])}}pcConfig.iceServers=newIceServers}}return new mozRTCPeerConnection(pcConfig,pcConstraints)};window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype;if(mozRTCPeerConnection.generateCertificate){Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}})}window.RTCSessionDescription=mozRTCSessionDescription;window.RTCIceCandidate=mozRTCIceCandidate}["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){arguments[0]=new(method==="addIceCandidate"?RTCIceCandidate:RTCSessionDescription)(arguments[0]);return nativeMethod.apply(this,arguments)}});var nativeAddIceCandidate=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}return nativeAddIceCandidate.apply(this,arguments)};var makeMapStats=function(stats){var map=new Map;Object.keys(stats).forEach(function(key){map.set(key,stats[key]);map[key]=stats[key]});return map};var modernStatsTypes={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"};var nativeGetStats=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(selector,onSucc,onErr){return nativeGetStats.apply(this,[selector||null]).then(function(stats){if(browserDetails.version<48){stats=makeMapStats(stats)}if(browserDetails.version<53&&!onSucc){try{stats.forEach(function(stat){stat.type=modernStatsTypes[stat.type]||stat.type})}catch(e){if(e.name!=="TypeError"){throw e}stats.forEach(function(stat,i){stats.set(i,Object.assign({},stat,{type:modernStatsTypes[stat.type]||stat.type}))})}}return stats}).then(onSucc,onErr)}}};module.exports={shimOnTrack:firefoxShim.shimOnTrack,shimSourceObject:firefoxShim.shimSourceObject,shimPeerConnection:firefoxShim.shimPeerConnection,shimGetUserMedia:require("./getusermedia")}},{"../utils":100,"./getusermedia":98}],98:[function(require,module,exports){"use strict";var logging=require("../utils").log;var browserDetails=require("../utils").browserDetails;module.exports=function(){var shimError_=function(e){return{name:{NotSupportedError:"TypeError",SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the "+"user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}};var getUserMedia_=function(constraints,onSuccess,onError){var constraintsToFF37_=function(c){if(typeof c!=="object"||c.require){return c}var require=[];Object.keys(c).forEach(function(key){if(key==="require"||key==="advanced"||key==="mediaSource"){return}var r=c[key]=typeof c[key]==="object"?c[key]:{ideal:c[key]};if(r.min!==undefined||r.max!==undefined||r.exact!==undefined){require.push(key)}if(r.exact!==undefined){if(typeof r.exact==="number"){r.min=r.max=r.exact}else{c[key]=r.exact}delete r.exact}if(r.ideal!==undefined){c.advanced=c.advanced||[];var oc={};if(typeof r.ideal==="number"){oc[key]={min:r.ideal,max:r.ideal}}else{oc[key]=r.ideal}c.advanced.push(oc);delete r.ideal;if(!Object.keys(r).length){delete c[key]}}});if(require.length){c.require=require}return c};constraints=JSON.parse(JSON.stringify(constraints));if(browserDetails.version<38){logging("spec: "+JSON.stringify(constraints));if(constraints.audio){constraints.audio=constraintsToFF37_(constraints.audio)}if(constraints.video){constraints.video=constraintsToFF37_(constraints.video)}logging("ff37: "+JSON.stringify(constraints))}return navigator.mozGetUserMedia(constraints,onSuccess,function(e){onError(shimError_(e))})};var getUserMediaPromise_=function(constraints){return new Promise(function(resolve,reject){getUserMedia_(constraints,resolve,reject)})};if(!navigator.mediaDevices){navigator.mediaDevices={getUserMedia:getUserMediaPromise_,addEventListener:function(){},removeEventListener:function(){}}}navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(resolve){var infos=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];resolve(infos)})};if(browserDetails.version<41){var orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices().then(undefined,function(e){if(e.name==="NotFoundError"){return[]}throw e})}}if(browserDetails.version<49){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return origGetUserMedia(c).then(function(stream){if(c.audio&&!stream.getAudioTracks().length||c.video&&!stream.getVideoTracks().length){stream.getTracks().forEach(function(track){track.stop()});throw new DOMException("The object can not be found here.","NotFoundError")}return stream},function(e){return Promise.reject(shimError_(e))})}}navigator.getUserMedia=function(constraints,onSuccess,onError){if(browserDetails.version<44){return getUserMedia_(constraints,onSuccess,onError)}console.warn("navigator.getUserMedia has been replaced by "+"navigator.mediaDevices.getUserMedia");navigator.mediaDevices.getUserMedia(constraints).then(onSuccess,onError)}}},{"../utils":100}],99:[function(require,module,exports){"use strict";var safariShim={shimOnAddStream:function(){if(typeof window==="object"&&window.RTCPeerConnection&&!("onaddstream"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(f){if(this._onaddstream){this.removeEventListener("addstream",this._onaddstream);this.removeEventListener("track",this._onaddstreampoly)}this.addEventListener("addstream",this._onaddstream=f);this.addEventListener("track",this._onaddstreampoly=function(e){var stream=e.streams[0];if(!this._streams){this._streams=[]}if(this._streams.indexOf(stream)>=0){return}this._streams.push(stream);var event=new Event("addstream");event.stream=e.streams[0];this.dispatchEvent(event)}.bind(this))}})}},shimGetUserMedia:function(){if(!navigator.getUserMedia){if(navigator.webkitGetUserMedia){navigator.getUserMedia=navigator.webkitGetUserMedia.bind(navigator)}else if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){navigator.getUserMedia=function(constraints,cb,errcb){navigator.mediaDevices.getUserMedia(constraints).then(cb,errcb)}.bind(navigator)}}}};module.exports={shimOnAddStream:safariShim.shimOnAddStream,shimGetUserMedia:safariShim.shimGetUserMedia}},{}],100:[function(require,module,exports){"use strict";var logDisabled_=true;var utils={disableLog:function(bool){if(typeof bool!=="boolean"){return new Error("Argument type: "+typeof bool+". Please use a boolean.")}logDisabled_=bool;return bool?"adapter.js logging disabled":"adapter.js logging enabled"},log:function(){if(typeof window==="object"){if(logDisabled_){return}if(typeof console!=="undefined"&&typeof console.log==="function"){console.log.apply(console,arguments)}}},extractVersion:function(uastring,expr,pos){var match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)},detectBrowser:function(){var result={};result.browser=null;result.version=null;if(typeof window==="undefined"||!window.navigator){result.browser="Not a browser.";return result}if(navigator.mozGetUserMedia){result.browser="firefox";result.version=this.extractVersion(navigator.userAgent,/Firefox\/(\d+)\./,1)}else if(navigator.webkitGetUserMedia){if(window.webkitRTCPeerConnection){result.browser="chrome";result.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2)}else{if(navigator.userAgent.match(/Version\/(\d+).(\d+)/)){result.browser="safari";result.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/(\d+)\./,1)}else{result.browser="Unsupported webkit-based browser "+"with GUM support but no WebRTC support.";return result}}}else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)){result.browser="edge";result.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}else if(navigator.mediaDevices&&navigator.userAgent.match(/AppleWebKit\/(\d+)\./)){result.browser="safari";result.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/(\d+)\./,1)}else{result.browser="Not a supported browser.";return result}return result},shimCreateObjectURL:function(){if(!(typeof window==="object"&&window.HTMLMediaElement&&"srcObject"in window.HTMLMediaElement.prototype)){return undefined}var nativeCreateObjectURL=URL.createObjectURL.bind(URL);var nativeRevokeObjectURL=URL.revokeObjectURL.bind(URL);var streams=new Map,newId=0;URL.createObjectURL=function(stream){if("getTracks"in stream){var url="polyblob:"+ ++newId;streams.set(url,stream);console.log("URL.createObjectURL(stream) is deprecated! "+"Use elem.srcObject = stream instead!");return url}return nativeCreateObjectURL(stream)};URL.revokeObjectURL=function(url){nativeRevokeObjectURL(url);streams.delete(url)};var dsc=Object.getOwnPropertyDescriptor(window.HTMLMediaElement.prototype,"src");Object.defineProperty(window.HTMLMediaElement.prototype,"src",{get:function(){return dsc.get.apply(this)},set:function(url){this.srcObject=streams.get(url)||null;return dsc.set.apply(this,[url])}});var nativeSetAttribute=HTMLMediaElement.prototype.setAttribute;HTMLMediaElement.prototype.setAttribute=function(){if(arguments.length===2&&(""+arguments[0]).toLowerCase()==="src"){this.srcObject=streams.get(arguments[1])||null}return nativeSetAttribute.apply(this,arguments)}}};module.exports={log:utils.log,disableLog:utils.disableLog,browserDetails:utils.detectBrowser(),extractVersion:utils.extractVersion,shimCreateObjectURL:utils.shimCreateObjectURL,detectBrowser:utils.detectBrowser.bind(utils)}},{}],101:[function(require,module,exports){module.exports=WildEmitter;function WildEmitter(){}WildEmitter.mixin=function(constructor){var prototype=constructor.prototype||constructor;prototype.isWildEmitter=true;prototype.on=function(event,groupName,fn){this.callbacks=this.callbacks||{};var hasGroup=arguments.length===3,group=hasGroup?arguments[1]:undefined,func=hasGroup?arguments[2]:arguments[1];func._groupName=group;(this.callbacks[event]=this.callbacks[event]||[]).push(func);return this};prototype.once=function(event,groupName,fn){var self=this,hasGroup=arguments.length===3,group=hasGroup?arguments[1]:undefined,func=hasGroup?arguments[2]:arguments[1];function on(){self.off(event,on);func.apply(this,arguments)}this.on(event,group,on);return this};prototype.releaseGroup=function(groupName){this.callbacks=this.callbacks||{};var item,i,len,handlers;for(item in this.callbacks){handlers=this.callbacks[item];for(i=0,len=handlers.length;i<len;i++){if(handlers[i]._groupName===groupName){handlers.splice(i,1);i--;len--}}}return this};prototype.off=function(event,fn){this.callbacks=this.callbacks||{};var callbacks=this.callbacks[event],i;if(!callbacks)return this;if(arguments.length===1){delete this.callbacks[event];return this}i=callbacks.indexOf(fn);callbacks.splice(i,1);if(callbacks.length===0){delete this.callbacks[event]}return this};prototype.emit=function(event){this.callbacks=this.callbacks||{};var args=[].slice.call(arguments,1),callbacks=this.callbacks[event],specialCallbacks=this.getWildcardCallbacks(event),i,len,item,listeners;if(callbacks){listeners=callbacks.slice();for(i=0,len=listeners.length;i<len;++i){if(!listeners[i]){break}listeners[i].apply(this,args)}}if(specialCallbacks){len=specialCallbacks.length;listeners=specialCallbacks.slice();for(i=0,len=listeners.length;i<len;++i){if(!listeners[i]){break}listeners[i].apply(this,[event].concat(args))}}return this};prototype.getWildcardCallbacks=function(eventName){this.callbacks=this.callbacks||{};var item,split,result=[];for(item in this.callbacks){split=item.split("*");if(item==="*"||split.length===2&&eventName.slice(0,split[0].length)===split[0]){result=result.concat(this.callbacks[item])}}return result}};WildEmitter.mixin(WildEmitter)},{}],102:[function(require,module,exports){(function(){"use strict";function EventEmitter(){}var proto=EventEmitter.prototype;var exports=this;var originalGlobalValue=exports.EventEmitter;function indexOfListener(listeners,listener){var i=listeners.length;while(i--){if(listeners[i].listener===listener){return i}}return-1}function alias(name){return function aliasClosure(){return this[name].apply(this,arguments)}}proto.getListeners=function getListeners(evt){var events=this._getEvents();var response;var key;if(evt instanceof RegExp){response={};for(key in events){if(events.hasOwnProperty(key)&&evt.test(key)){response[key]=events[key]}}}else{response=events[evt]||(events[evt]=[])}return response};proto.flattenListeners=function flattenListeners(listeners){var flatListeners=[];var i;for(i=0;i<listeners.length;i+=1){flatListeners.push(listeners[i].listener)}return flatListeners};proto.getListenersAsObject=function getListenersAsObject(evt){var listeners=this.getListeners(evt);var response;if(listeners instanceof Array){response={};response[evt]=listeners}return response||listeners};proto.addListener=function addListener(evt,listener){var listeners=this.getListenersAsObject(evt);var listenerIsWrapped=typeof listener==="object";var key;for(key in listeners){if(listeners.hasOwnProperty(key)&&indexOfListener(listeners[key],listener)===-1){listeners[key].push(listenerIsWrapped?listener:{listener:listener,once:false})}}return this};proto.on=alias("addListener");proto.addOnceListener=function addOnceListener(evt,listener){return this.addListener(evt,{listener:listener,once:true})};proto.once=alias("addOnceListener");proto.defineEvent=function defineEvent(evt){this.getListeners(evt);return this};proto.defineEvents=function defineEvents(evts){for(var i=0;i<evts.length;i+=1){this.defineEvent(evts[i])}return this};proto.removeListener=function removeListener(evt,listener){var listeners=this.getListenersAsObject(evt);var index;var key;for(key in listeners){if(listeners.hasOwnProperty(key)){index=indexOfListener(listeners[key],listener);if(index!==-1){listeners[key].splice(index,1)}}}return this};proto.off=alias("removeListener");proto.addListeners=function addListeners(evt,listeners){return this.manipulateListeners(false,evt,listeners)};proto.removeListeners=function removeListeners(evt,listeners){return this.manipulateListeners(true,evt,listeners)};proto.manipulateListeners=function manipulateListeners(remove,evt,listeners){var i;var value;var single=remove?this.removeListener:this.addListener;var multiple=remove?this.removeListeners:this.addListeners;if(typeof evt==="object"&&!(evt instanceof RegExp)){for(i in evt){if(evt.hasOwnProperty(i)&&(value=evt[i])){if(typeof value==="function"){single.call(this,i,value)}else{multiple.call(this,i,value)}}}}else{i=listeners.length;while(i--){single.call(this,evt,listeners[i])}}return this};proto.removeEvent=function removeEvent(evt){var type=typeof evt;var events=this._getEvents();var key;if(type==="string"){delete events[evt]}else if(evt instanceof RegExp){for(key in events){if(events.hasOwnProperty(key)&&evt.test(key)){delete events[key]}}}else{delete this._events}return this};proto.removeAllListeners=alias("removeEvent");proto.emitEvent=function emitEvent(evt,args){var listeners=this.getListenersAsObject(evt);var listener;var i;var key;var response;for(key in listeners){if(listeners.hasOwnProperty(key)){i=listeners[key].length;while(i--){listener=listeners[key][i];if(listener.once===true){this.removeListener(evt,listener.listener)}response=listener.listener.apply(this,args||[]);if(response===this._getOnceReturnValue()){this.removeListener(evt,listener.listener)}}}}return this};proto.trigger=alias("emitEvent");proto.emit=function emit(evt){var args=Array.prototype.slice.call(arguments,1);return this.emitEvent(evt,args)};proto.setOnceReturnValue=function setOnceReturnValue(value){this._onceReturnValue=value;return this};proto._getOnceReturnValue=function _getOnceReturnValue(){if(this.hasOwnProperty("_onceReturnValue")){return this._onceReturnValue}else{return true}};proto._getEvents=function _getEvents(){return this._events||(this._events={})};EventEmitter.noConflict=function noConflict(){exports.EventEmitter=originalGlobalValue;return EventEmitter};if(typeof define==="function"&&define.amd){define(function(){return EventEmitter})}else if(typeof module==="object"&&module.exports){module.exports=EventEmitter}else{exports.EventEmitter=EventEmitter}}).call(this)},{}],103:[function(require,module,exports){var global=function(){return this}();var WebSocket=global.WebSocket||global.MozWebSocket;module.exports=WebSocket?ws:null;function ws(uri,protocols,opts){var instance;if(protocols){instance=new WebSocket(uri,protocols)}else{instance=new WebSocket(uri)}return instance}if(WebSocket)ws.prototype=WebSocket.prototype},{}],104:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var OpenVidu_1=require("./OpenVidu");if(window){window["OpenVidu"]=OpenVidu_1.OpenVidu}},{"./OpenVidu":105}],105:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var OpenViduInternal_1=require("../OpenViduInternal/OpenViduInternal");var Session_1=require("./Session");var Publisher_1=require("./Publisher");var adapter=require("webrtc-adapter");if(window){window["adapter"]=adapter}var OpenVidu=function(){function OpenVidu(){this.openVidu=new OpenViduInternal_1.OpenViduInternal}OpenVidu.prototype.initSession=function(param1,param2){if(this.checkSystemRequirements()){if(typeof param2=="string"){return new Session_1.Session(this.openVidu.initSession(param2),this)}else{return new Session_1.Session(this.openVidu.initSession(param1),this)}}else{alert("Browser not supported")}};OpenVidu.prototype.initPublisher=function(parentId,cameraOptions,callback){if(this.checkSystemRequirements()){if(cameraOptions!=null){var cameraOptionsAux={audio:cameraOptions.audio!=null?cameraOptions.audio:true,video:cameraOptions.video!=null?cameraOptions.video:true,data:true,mediaConstraints:this.openVidu.generateMediaConstraints(cameraOptions.quality)};cameraOptions=cameraOptionsAux}else{cameraOptions={audio:true,video:true,data:true,mediaConstraints:{audio:true,video:{width:{ideal:1280}}}}}return new Publisher_1.Publisher(this.openVidu.initPublisherTagged(parentId,cameraOptions,callback),parentId)}else{alert("Browser not supported")}};OpenVidu.prototype.checkSystemRequirements=function(){var browser=adapter.browserDetails.browser;var version=adapter.browserDetails.version;if(browser=="firefox"&&version==null){return 1}if(browser=="chrome"&&version>=28||browser=="edge"&&version>=12||browser=="firefox"&&version>=22){return 1}else{return 0}};OpenVidu.prototype.getDevices=function(callback){navigator.mediaDevices.enumerateDevices().then(function(deviceInfos){callback(null,deviceInfos)}).catch(function(error){console.log("Error getting devices: "+error);callback(error,null)})};return OpenVidu}();exports.OpenVidu=OpenVidu},{"../OpenViduInternal/OpenViduInternal":110,"./Publisher":106,"./Session":107,"webrtc-adapter":91}],106:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var EventEmitter=require("wolfy87-eventemitter");var Publisher=function(){function Publisher(stream,parentId){var _this=this;this.ee=new EventEmitter;this.accessAllowed=false;this.stream=stream;this.stream.addEventListener("camera-access-changed",function(event){_this.accessAllowed=event.accessAllowed;if(_this.accessAllowed){_this.ee.emitEvent("accessAllowed")}else{_this.ee.emitEvent("accessDenied")}});if(document.getElementById(parentId)!=null){this.element=document.getElementById(parentId)}}Publisher.prototype.publishAudio=function(value){this.stream.getWebRtcPeer().audioEnabled=value};Publisher.prototype.publishVideo=function(value){this.stream.getWebRtcPeer().videoEnabled=value};Publisher.prototype.destroy=function(){this.session.unpublish(this);this.stream.dispose();this.stream.removeVideo(this.element);return this};Publisher.prototype.on=function(eventName,callback){var _this=this;this.ee.addListener(eventName,function(event){callback(event)});if(eventName=="videoElementCreated"){if(this.stream.isVideoELementCreated){this.ee.emitEvent("videoElementCreated",[{element:this.stream.getVideoElement()}])}else{this.stream.addEventListener("video-element-created-by-stream",function(element){console.warn("Publisher emitting videoElementCreated");_this.id=element.id;_this.ee.emitEvent("videoElementCreated",[{element:element.element}])})}}if(eventName=="streamCreated"){if(this.stream.isReady){this.ee.emitEvent("streamCreated",[{stream:this.stream}])}else{this.stream.addEventListener("stream-created-by-publisher",function(){console.warn("Publisher emitting streamCreated");_this.ee.emitEvent("streamCreated",[{stream:_this.stream}])})}}if(eventName=="accessAllowed"){if(this.stream.accessIsAllowed){this.ee.emitEvent("accessAllowed")}else{this.stream.addEventListener("access-allowed-by-publisher",function(){_this.ee.emitEvent("accessAllowed")})}}if(eventName=="accessDenied"){if(this.stream.accessIsDenied){this.ee.emitEvent("accessDenied")}else{this.stream.addEventListener("access-denied-by-publisher",function(){_this.ee.emitEvent("accessDenied")})}}};return Publisher}();exports.Publisher=Publisher},{"wolfy87-eventemitter":102}],107:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Subscriber_1=require("./Subscriber");var EventEmitter=require("wolfy87-eventemitter");var Session=function(){function Session(session,openVidu){var _this=this;this.session=session;this.openVidu=openVidu;this.ee=new EventEmitter;this.sessionId=session.getSessionId();this.session.addEventListener("stream-destroyed-default",function(event){event.stream.removeVideo()});this.session.addEventListener("session-disconnected-default",function(){var s;for(var _i=0,_a=_this.openVidu.openVidu.getRemoteStreams();_i<_a.length;_i++){s=_a[_i];s.removeVideo()}if(_this.connection){for(var streamId in _this.connection.getStreams()){_this.connection.getStreams()[streamId].removeVideo()}}});this.session.addEventListener("update-connection-object",function(event){_this.connection=event.connection})}Session.prototype.connect=function(param1,param2,param3){if(param3){this.session.configure({sessionId:this.session.getSessionId(),participantId:param1,metadata:this.session.stringClientMetadata(param2),subscribeToStreams:false});this.session.connect(param1,param3)}else{this.session.configure({sessionId:this.session.getSessionId(),participantId:param1,metadata:"",subscribeToStreams:false});this.session.connect(param1,param2)}};Session.prototype.disconnect=function(){var _this=this;this.openVidu.openVidu.close(false);this.session.emitEvent("sessionDisconnected",[{preventDefault:function(){_this.session.removeEvent("session-disconnected-default")}}]);this.session.emitEvent("session-disconnected-default",[{}])};Session.prototype.publish=function(publisher){publisher.session=this;publisher.stream.publish()};Session.prototype.unpublish=function(publisher){this.session.unpublish(publisher.stream)};Session.prototype.on=function(eventName,callback){this.session.addEventListener(eventName,function(event){callback(event)})};Session.prototype.once=function(eventName,callback){this.session.addOnceEventListener(eventName,function(event){callback(event)})};Session.prototype.off=function(eventName,eventHandler){this.session.removeListener(eventName,eventHandler)};Session.prototype.subscribe=function(param1,param2,param3){this.session.subscribe(param1);var subscriber=new Subscriber_1.Subscriber(param1,param2);param1.playOnlyVideo(param2,null);return subscriber};Session.prototype.unsubscribe=function(subscriber){this.session.unsuscribe(subscriber.stream);subscriber.stream.removeVideo()};Session.prototype.onStreamCreated=function(callback){this.session.addEventListener("streamCreated",function(streamEvent){callback(streamEvent.stream)})};Session.prototype.onStreamDestroyed=function(callback){this.session.addEventListener("streamDestroyed",function(streamEvent){callback(streamEvent.stream)})};Session.prototype.onParticipantJoined=function(callback){this.session.addEventListener("participant-joined",function(participantEvent){callback(participantEvent.connection)})};Session.prototype.onParticipantLeft=function(callback){this.session.addEventListener("participant-left",function(participantEvent){callback(participantEvent.connection)})};Session.prototype.onParticipantPublished=function(callback){this.session.addEventListener("participant-published",function(participantEvent){callback(participantEvent.connection)})};Session.prototype.onParticipantEvicted=function(callback){this.session.addEventListener("participant-evicted",function(participantEvent){callback(participantEvent.connection)})};Session.prototype.onRoomClosed=function(callback){this.session.addEventListener("room-closed",function(roomEvent){callback(roomEvent.room)})};Session.prototype.onLostConnection=function(callback){this.session.addEventListener("lost-connection",function(roomEvent){callback(roomEvent.room)})};Session.prototype.onMediaError=function(callback){this.session.addEventListener("error-media",function(errorEvent){callback(errorEvent.error)})};return Session}();exports.Session=Session},{"./Subscriber":108,"wolfy87-eventemitter":102}],108:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var EventEmitter=require("wolfy87-eventemitter");var Subscriber=function(){function Subscriber(stream,parentId){this.ee=new EventEmitter;this.stream=stream;if(document.getElementById(parentId)!=null){this.element=document.getElementById(parentId)}}Subscriber.prototype.on=function(eventName,callback){var _this=this;this.ee.addListener(eventName,function(event){callback(event)});if(eventName=="videoElementCreated"){if(this.stream.isReady){this.ee.emitEvent("videoElementCreated",[{element:this.stream.getVideoElement()}])}else{this.stream.addEventListener("video-element-created-by-stream",function(element){console.warn("Subscriber emitting videoElementCreated");_this.id=element.id;_this.ee.emitEvent("videoElementCreated",[{element:element}])})}}};return Subscriber}();exports.Subscriber=Subscriber},{"wolfy87-eventemitter":102}],109:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Stream_1=require("./Stream");var Connection=function(){function Connection(openVidu,local,room,options){this.openVidu=openVidu;this.local=local;this.room=room;this.options=options;this.streams={};this.streamsOpts=[];if(options){this.connectionId=options.id;this.data=options.metadata;if(options.streams){for(var _i=0,_a=options.streams;_i<_a.length;_i++){var streamOptions=_a[_i];var streamOpts={id:streamOptions.id,connection:this,recvVideo:streamOptions.recvVideo==undefined?true:streamOptions.recvVideo,recvAudio:streamOptions.recvAudio==undefined?true:streamOptions.recvAudio,audio:streamOptions.audio,video:streamOptions.video,data:streamOptions.data,mediaConstraints:streamOptions.mediaConstraints,audioOnly:streamOptions.audioOnly};var stream=new Stream_1.Stream(openVidu,false,room,streamOpts);this.addStream(stream);this.streamsOpts.push(streamOpts)}}}console.log("New "+(local?"local ":"remote ")+"participant "+this.connectionId+", streams opts: ",this.streamsOpts)}Connection.prototype.addStream=function(stream){this.streams[stream.getIdInParticipant()]=stream;this.room.getStreams()[stream.getIdInParticipant()]=stream};Connection.prototype.getStreams=function(){return this.streams};Connection.prototype.dispose=function(){for(var key in this.streams){this.streams[key].dispose()}};Connection.prototype.sendIceCandidate=function(candidate){console.debug(this.local?"Local":"Remote","candidate for",this.connectionId,JSON.stringify(candidate));this.openVidu.sendRequest("onIceCandidate",{endpointName:this.connectionId,candidate:candidate.candidate,sdpMid:candidate.sdpMid,sdpMLineIndex:candidate.sdpMLineIndex},function(error,response){if(error){console.error("Error sending ICE candidate: "+JSON.stringify(error))}})};return Connection}();exports.Connection=Connection},{"./Stream":112}],110:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var SessionInternal_1=require("./SessionInternal");var Stream_1=require("./Stream");var RpcBuilder=require("kurento-jsonrpc");var OpenViduInternal=function(){function OpenViduInternal(){this.remoteStreams=[]}OpenViduInternal.prototype.initSession=function(sessionId){console.log("Session initialized!");this.session=new SessionInternal_1.SessionInternal(this,sessionId);return this.session};OpenViduInternal.prototype.initPublisherTagged=function(parentId,cameraOptions,callback){var _this=this;console.log("Publisher tagged initialized!");this.getCamera(cameraOptions);if(callback==null){this.camera.requestCameraAccess(function(error,camera){if(error){console.log("Error accessing the camera")}else{_this.camera.setVideoElement(_this.cameraReady(camera,parentId))}});return this.camera}else{this.camera.requestCameraAccess(function(error,camera){if(error){callback(error)}else{_this.camera.setVideoElement(_this.cameraReady(camera,parentId));callback(undefined)}});return this.camera}};OpenViduInternal.prototype.cameraReady=function(camera,parentId){this.camera=camera;var videoElement=this.camera.playOnlyVideo(parentId,null);this.camera.emitStreamReadyEvent();return videoElement};OpenViduInternal.prototype.initPublisher=function(cameraOptions,callback){console.log("Publisher initialized!");this.getCamera(cameraOptions);this.camera.requestCameraAccess(function(error,camera){if(error)callback(error);else callback(undefined)})};OpenViduInternal.prototype.getLocalStream=function(){return this.camera};OpenViduInternal.prototype.getRemoteStreams=function(){return this.remoteStreams};OpenViduInternal.prototype.getWsUri=function(){return this.wsUri};OpenViduInternal.prototype.setWsUri=function(wsUri){this.wsUri=wsUri};OpenViduInternal.prototype.getSecret=function(){return this.secret};OpenViduInternal.prototype.setSecret=function(secret){this.secret=secret};OpenViduInternal.prototype.getOpenViduServerURL=function(){return"https://"+this.wsUri.split("wss://")[1].split("/room")[0]};OpenViduInternal.prototype.getRoom=function(){return this.session};OpenViduInternal.prototype.connect=function(callback){this.callback=callback;this.initJsonRpcClient(this.wsUri)};OpenViduInternal.prototype.initJsonRpcClient=function(wsUri){var config={heartbeat:3e3,sendCloseMessage:false,ws:{uri:wsUri,useSockJS:false,onconnected:this.connectCallback.bind(this),ondisconnect:this.disconnectCallback.bind(this),onreconnecting:this.reconnectingCallback.bind(this),onreconnected:this.reconnectedCallback.bind(this)},rpc:{requestTimeout:15e3,participantJoined:this.onParticipantJoined.bind(this),participantPublished:this.onParticipantPublished.bind(this),participantUnpublished:this.onParticipantLeft.bind(this),participantLeft:this.onParticipantLeft.bind(this),participantEvicted:this.onParticipantEvicted.bind(this),sendMessage:this.onNewMessage.bind(this),iceCandidate:this.iceCandidateEvent.bind(this),mediaError:this.onMediaError.bind(this),custonNotification:this.customNotification.bind(this)}};this.jsonRpcClient=new RpcBuilder.clients.JsonRpcClient(config)};OpenViduInternal.prototype.customNotification=function(params){if(this.isRoomAvailable()){this.session.emitEvent("custom-message-received",[{params:params}])}};OpenViduInternal.prototype.connectCallback=function(error){if(error){this.callback(error)}else{this.callback(null)}};OpenViduInternal.prototype.isRoomAvailable=function(){if(this.session!==undefined&&this.session instanceof SessionInternal_1.SessionInternal){return true}else{console.warn("Room instance not found");return false}};OpenViduInternal.prototype.disconnectCallback=function(){console.log("Websocket connection lost");if(this.isRoomAvailable()){this.session.onLostConnection()}else{alert("Connection error. Please reload page.")}};OpenViduInternal.prototype.reconnectingCallback=function(){console.log("Websocket connection lost (reconnecting)");if(this.isRoomAvailable()){this.session.onLostConnection()}else{alert("Connection error. Please reload page.")}};OpenViduInternal.prototype.reconnectedCallback=function(){console.log("Websocket reconnected")};OpenViduInternal.prototype.onParticipantJoined=function(params){if(this.isRoomAvailable()){this.session.onParticipantJoined(params)}};OpenViduInternal.prototype.onParticipantPublished=function(params){if(this.isRoomAvailable()){this.session.onParticipantPublished(params)}};OpenViduInternal.prototype.onParticipantLeft=function(params){if(this.isRoomAvailable()){this.session.onParticipantLeft(params)}};OpenViduInternal.prototype.onParticipantEvicted=function(params){if(this.isRoomAvailable()){this.session.onParticipantEvicted(params)}};OpenViduInternal.prototype.onNewMessage=function(params){if(this.isRoomAvailable()){this.session.onNewMessage(params)}};OpenViduInternal.prototype.iceCandidateEvent=function(params){if(this.isRoomAvailable()){this.session.recvIceCandidate(params)}};OpenViduInternal.prototype.onRoomClosed=function(params){if(this.isRoomAvailable()){this.session.onRoomClosed(params)}};OpenViduInternal.prototype.onMediaError=function(params){if(this.isRoomAvailable()){this.session.onMediaError(params)}};OpenViduInternal.prototype.setRpcParams=function(params){this.rpcParams=params};OpenViduInternal.prototype.sendRequest=function(method,params,callback){if(params&&params instanceof Function){callback=params;params=undefined}params=params||{};if(this.rpcParams&&this.rpcParams!==null&&this.rpcParams!==undefined){for(var index in this.rpcParams){if(this.rpcParams.hasOwnProperty(index)){params[index]=this.rpcParams[index];console.log("RPC param added to request {"+index+": "+this.rpcParams[index]+"}")}}}console.log('Sending request: { method:"'+method+'", params: '+JSON.stringify(params)+" }");this.jsonRpcClient.send(method,params,callback)};OpenViduInternal.prototype.close=function(forced){if(this.isRoomAvailable()){this.session.leave(forced,this.jsonRpcClient)}};OpenViduInternal.prototype.disconnectParticipant=function(stream){if(this.isRoomAvailable()){this.session.disconnect(stream)}};OpenViduInternal.prototype.getCamera=function(options){if(this.camera){return this.camera}options=options||{audio:true,video:true,data:true,mediaConstraints:{audio:true,video:{width:{ideal:1280}}}};options.connection=this.session.getLocalParticipant();this.camera=new Stream_1.Stream(this,true,this.session,options);return this.camera};OpenViduInternal.prototype.sendMessage=function(room,user,message){this.sendRequest("sendMessage",{message:message,userMessage:user,roomMessage:room},function(error,response){if(error){console.error(error)}})};OpenViduInternal.prototype.sendCustomRequest=function(params,callback){this.sendRequest("customRequest",params,callback)};OpenViduInternal.prototype.toggleLocalVideoTrack=function(activate){this.getCamera().getWebRtcPeer().videoEnabled=activate};OpenViduInternal.prototype.toggleLocalAudioTrack=function(activate){this.getCamera().getWebRtcPeer().audioEnabled=activate};OpenViduInternal.prototype.publishLocalVideoAudio=function(){this.toggleLocalVideoTrack(true);this.toggleLocalAudioTrack(true)};OpenViduInternal.prototype.unpublishLocalVideoAudio=function(){this.toggleLocalVideoTrack(false);this.toggleLocalAudioTrack(false)};OpenViduInternal.prototype.generateMediaConstraints=function(quality){var mediaConstraints={audio:true,video:{}};var w,h;switch(quality){case"LOW":w=320;h=240;break;case"MEDIUM":w=640;h=480;break;case"HIGH":w=1280;h=720;break;default:w=640;h=480}mediaConstraints.video["width"]={exact:w};mediaConstraints.video["height"]={exact:h};return mediaConstraints};return OpenViduInternal}();exports.OpenViduInternal=OpenViduInternal},{"./SessionInternal":111,"./Stream":112,"kurento-jsonrpc":14}],111:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Connection_1=require("./Connection");var EventEmitter=require("wolfy87-eventemitter");var SECRET_PARAM="?secret=";var SessionInternal=function(){function SessionInternal(openVidu,sessionId){this.openVidu=openVidu;this.ee=new EventEmitter;this.streams={};this.participants={};this.participantsSpeaking=[];this.connected=false;this.sessionId=this.getUrlWithoutSecret(sessionId);this.localParticipant=new Connection_1.Connection(this.openVidu,true,this);if(!this.openVidu.getWsUri()){this.processOpenViduUrl(sessionId)}}SessionInternal.prototype.processOpenViduUrl=function(url){this.openVidu.setSecret(this.getSecretFromUrl(url));this.openVidu.setWsUri(this.getFinalUrl(url))};SessionInternal.prototype.getSecretFromUrl=function(url){var secret="";if(url.indexOf(SECRET_PARAM)!==-1){secret=url.substring(url.lastIndexOf(SECRET_PARAM)+SECRET_PARAM.length,url.length)}return secret};SessionInternal.prototype.getUrlWithoutSecret=function(url){if(url.indexOf(SECRET_PARAM)!==-1){url=url.substring(0,url.lastIndexOf(SECRET_PARAM))}return url};SessionInternal.prototype.getFinalUrl=function(url){url=this.getUrlWithoutSecret(url).substring(0,url.lastIndexOf("/"))+"/room";if(url.indexOf(".ngrok.io")!==-1){url=url.replace("ws://","wss://");var regex=/\.ngrok\.io:\d+/;url=url.replace(regex,".ngrok.io")}else if(url.indexOf("localhost")!==-1||url.indexOf("127.0.0.1")!=-1){}return url};SessionInternal.prototype.connect=function(token,callback){var _this=this;this.openVidu.connect(function(error){if(error){callback("ERROR CONNECTING TO OPENVIDU")}else{if(!token){token=_this.randomToken()}var joinParams={token:token,session:_this.sessionId,metadata:_this.options.metadata,secret:_this.openVidu.getSecret(),dataChannels:false};if(_this.localParticipant){if(Object.keys(_this.localParticipant.getStreams()).some(function(streamId){return _this.streams[streamId].isDataChannelEnabled()})){joinParams.dataChannels=true}}_this.openVidu.sendRequest("joinRoom",joinParams,function(error,response){if(error){callback(error)}else{_this.connected=true;var exParticipants=response.value;_this.localParticipant.connectionId=response.id;_this.participants[response.id]=_this.localParticipant;var roomEvent={participants:new Array,streams:new Array};var length_1=exParticipants.length;for(var i=0;i<length_1;i++){var connection=new Connection_1.Connection(_this.openVidu,false,_this,exParticipants[i]);connection.creationTime=(new Date).getTime();_this.participants[connection.connectionId]=connection;roomEvent.participants.push(connection);var streams=connection.getStreams();for(var key in streams){roomEvent.streams.push(streams[key]);if(_this.subscribeToStreams){streams[key].subscribe()}}}_this.localParticipant.data=response.metadata;_this.localParticipant.creationTime=(new Date).getTime();_this.ee.emitEvent("update-connection-object",[{connection:_this.localParticipant}]);_this.ee.emitEvent("connectionCreated",[{connection:_this.localParticipant}]);for(var _i=0,_a=roomEvent.participants;_i<_a.length;_i++){var part=_a[_i];_this.ee.emitEvent("connectionCreated",[{connection:part}])}for(var _b=0,_c=roomEvent.streams;_b<_c.length;_b++){var stream=_c[_b];_this.ee.emitEvent("streamCreated",[{stream:stream}]);_this.openVidu.getRemoteStreams().push(stream)}callback(undefined)}})}})};SessionInternal.prototype.publish=function(){this.openVidu.getCamera().publish()};SessionInternal.prototype.configure=function(options){this.options=options;this.id=options.sessionId;this.subscribeToStreams=options.subscribeToStreams==null?true:options.subscribeToStreams;this.updateSpeakerInterval=options.updateSpeakerInterval||1500;this.thresholdSpeaker=options.thresholdSpeaker||-50;this.activateUpdateMainSpeaker()};SessionInternal.prototype.getId=function(){return this.id};SessionInternal.prototype.getSessionId=function(){return this.sessionId};SessionInternal.prototype.activateUpdateMainSpeaker=function(){var _this=this;setInterval(function(){if(_this.participantsSpeaking.length>0){_this.ee.emitEvent("update-main-speaker",[{participantId:_this.participantsSpeaking[_this.participantsSpeaking.length-1]}])}},this.updateSpeakerInterval)};SessionInternal.prototype.getLocalParticipant=function(){return this.localParticipant};SessionInternal.prototype.addEventListener=function(eventName,listener){this.ee.on(eventName,listener)};SessionInternal.prototype.addOnceEventListener=function(eventName,listener){this.ee.once(eventName,listener)};SessionInternal.prototype.removeListener=function(eventName,listener){this.ee.off(eventName,listener)};SessionInternal.prototype.removeEvent=function(eventName){this.ee.removeEvent(eventName)};SessionInternal.prototype.emitEvent=function(eventName,eventsArray){this.ee.emitEvent(eventName,eventsArray)};SessionInternal.prototype.subscribe=function(stream){stream.subscribe()};SessionInternal.prototype.unsuscribe=function(stream){console.log("Unsubscribing from "+stream.getId());this.openVidu.sendRequest("unsubscribeFromVideo",{sender:stream.getId()},function(error,response){if(error){console.error(error)}else{console.info("Unsubscribed correctly from "+stream.getId())}})};SessionInternal.prototype.onParticipantPublished=function(options){options.metadata=this.participants[options.id].data;var connection=new Connection_1.Connection(this.openVidu,false,this,options);var pid=connection.connectionId;if(!(pid in this.participants)){console.info("Publisher not found in participants list by its id",pid)}else{console.log("Publisher found in participants list by its id",pid)}connection.creationTime=this.participants[pid].creationTime;this.participants[pid]=connection;this.ee.emitEvent("participant-published",[{connection:connection}]);var streams=connection.getStreams();for(var key in streams){var stream=streams[key];if(this.subscribeToStreams){stream.subscribe()}this.ee.emitEvent("streamCreated",[{stream:stream}]);this.openVidu.getRemoteStreams().push(stream)}};SessionInternal.prototype.onParticipantJoined=function(msg){var connection=new Connection_1.Connection(this.openVidu,false,this,msg);connection.creationTime=(new Date).getTime();var pid=connection.connectionId;if(!(pid in this.participants)){console.log("New participant to participants list with id",pid);this.participants[pid]=connection}else{console.info("Participant already exists in participants list with "+"the same id, old:",this.participants[pid],", joined now:",connection);connection=this.participants[pid]}this.ee.emitEvent("participant-joined",[{connection:connection}]);this.ee.emitEvent("connectionCreated",[{connection:connection}])};SessionInternal.prototype.onParticipantLeft=function(msg){var _this=this;var connection=this.participants[msg.name];if(connection!==undefined){delete this.participants[msg.name];this.ee.emitEvent("participant-left",[{connection:connection}]);var streams=connection.getStreams();for(var key in streams){this.ee.emitEvent("streamDestroyed",[{stream:streams[key],preventDefault:function(){_this.ee.removeEvent("stream-destroyed-default")}}]);this.ee.emitEvent("stream-destroyed-default",[{stream:streams[key]}]);var index=this.openVidu.getRemoteStreams().indexOf(streams[key]);this.openVidu.getRemoteStreams().splice(index,1)}connection.dispose();this.ee.emitEvent("connectionDestroyed",[{connection:connection}])}else{console.warn("Participant "+msg.name+" unknown. Participants: "+JSON.stringify(this.participants))}};SessionInternal.prototype.onParticipantEvicted=function(msg){this.ee.emitEvent("participant-evicted",[{localParticipant:this.localParticipant}])};SessionInternal.prototype.onNewMessage=function(msg){console.log("New message: "+JSON.stringify(msg));var room=msg.room;var user=msg.user;var message=msg.message;if(user!==undefined){this.ee.emitEvent("newMessage",[{room:room,user:user,message:message}])}else{console.warn("User undefined in new message:",msg)}};SessionInternal.prototype.recvIceCandidate=function(msg){var candidate={candidate:msg.candidate,sdpMid:msg.sdpMid,sdpMLineIndex:msg.sdpMLineIndex};var connection=this.participants[msg.endpointName];if(!connection){console.error("Participant not found for endpoint "+msg.endpointName+". Ice candidate will be ignored.",candidate);return}var streams=connection.getStreams();var _loop_1=function(key){var stream=streams[key];stream.getWebRtcPeer().addIceCandidate(candidate,function(error){if(error){console.error("Error adding candidate for "+key+" stream of endpoint "+msg.endpointName+": "+error)}})};for(var key in streams){_loop_1(key)}};SessionInternal.prototype.onRoomClosed=function(msg){console.log("Room closed: "+JSON.stringify(msg));var room=msg.room;if(room!==undefined){this.ee.emitEvent("room-closed",[{room:room}])}else{console.warn("Room undefined in on room closed",msg)}};SessionInternal.prototype.onLostConnection=function(){if(!this.connected){console.warn("Not connected to room: if you are not debugging, this is probably a certificate error");if(window.confirm('If you are not debugging, this is probably a certificate error at "'+this.openVidu.getOpenViduServerURL()+'"\n\nClick OK to navigate and accept it')){location.assign(this.openVidu.getOpenViduServerURL()+"/accept-certificate")}return}console.log("Lost connection in room "+this.id);var room=this.id;if(room!==undefined){this.ee.emitEvent("lost-connection",[{room:room}])}else{console.warn("Room undefined when lost connection")}};SessionInternal.prototype.onMediaError=function(params){console.error("Media error: "+JSON.stringify(params));var error=params.error;if(error){this.ee.emitEvent("error-media",[{error:error}])}else{console.warn("Received undefined media error. Params:",params)}};SessionInternal.prototype.leave=function(forced,jsonRpcClient){forced=!!forced;console.log("Leaving room (forced="+forced+")");if(this.connected&&!forced){this.openVidu.sendRequest("leaveRoom",function(error,response){if(error){console.error(error)}jsonRpcClient.close()})}else{jsonRpcClient.close()}this.connected=false;if(this.participants){for(var pid in this.participants){this.participants[pid].dispose();delete this.participants[pid]}}};SessionInternal.prototype.disconnect=function(stream){var connection=stream.getParticipant();if(!connection){console.error("Stream to disconnect has no participant",stream);return}delete this.participants[connection.connectionId];connection.dispose();if(connection===this.localParticipant){console.log("Unpublishing my media (I'm "+connection.connectionId+")");delete this.localParticipant;this.openVidu.sendRequest("unpublishVideo",function(error,response){if(error){console.error(error)}else{console.info("Media unpublished correctly")}})}else{this.unsuscribe(stream)}};SessionInternal.prototype.unpublish=function(stream){var connection=stream.getParticipant();if(!connection){console.error("Stream to disconnect has no participant",stream);return}if(connection===this.localParticipant){delete this.participants[connection.connectionId];connection.dispose();console.log("Unpublishing my media (I'm "+connection.connectionId+")");delete this.localParticipant;this.openVidu.sendRequest("unpublishVideo",function(error,response){if(error){console.error(error)}else{console.info("Media unpublished correctly")}})}};SessionInternal.prototype.getStreams=function(){return this.streams};SessionInternal.prototype.addParticipantSpeaking=function(participantId){this.participantsSpeaking.push(participantId)};SessionInternal.prototype.removeParticipantSpeaking=function(participantId){var pos=-1;for(var i=0;i<this.participantsSpeaking.length;i++){if(this.participantsSpeaking[i]==participantId){pos=i;break}}if(pos!=-1){this.participantsSpeaking.splice(pos,1)}};SessionInternal.prototype.stringClientMetadata=function(metadata){if(!(typeof metadata==="string")){return JSON.stringify(metadata)}else{return metadata}};SessionInternal.prototype.randomToken=function(){return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2)};return SessionInternal}();exports.SessionInternal=SessionInternal},{"./Connection":109,"wolfy87-eventemitter":102}],112:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var EventEmitter=require("wolfy87-eventemitter");var kurentoUtils=require("kurento-utils");var adapter=require("webrtc-adapter");if(window){window["adapter"]=adapter}function jq(id){return id.replace(/(@|:|\.|\[|\]|,)/g,"\\$1")}function show(id){document.getElementById(jq(id)).style.display="block"}function hide(id){document.getElementById(jq(id)).style.display="none"}var Stream=function(){function Stream(openVidu,local,room,options){var _this=this;this.openVidu=openVidu;this.local=local;this.room=room;this.ee=new EventEmitter;this.videoElements=[];this.elements=[];this.showMyRemote=false;this.localMirrored=false;this.chanId=0;this.dataChannelOpened=false;this.audioOnly=false;this.isReady=false;this.isVideoELementCreated=false;this.accessIsAllowed=false;this.accessIsDenied=false;if(options.id){this.id=options.id}else{this.id="webcam"}this.connection=options.connection;this.recvVideo=options.recvVideo;this.recvAudio=options.recvAudio;this.dataChannel=options.data||false;this.sendVideo=options.video;this.sendAudio=options.audio;this.mediaConstraints=options.mediaConstraints;this.audioOnly=options.audioOnly||false;this.addEventListener("src-added",function(srcEvent){_this.videoSrc=srcEvent.src;if(_this.video)_this.video.src=srcEvent.src;console.warn("Videosrc ["+srcEvent.src+"] added to stream ["+_this.getId()+"]")})}Stream.prototype.emitSrcEvent=function(wrstream){this.ee.emitEvent("src-added",[{src:URL.createObjectURL(wrstream)}])};Stream.prototype.emitStreamReadyEvent=function(){this.ee.emitEvent("stream-ready"),[{}]};Stream.prototype.getVideoSrc=function(){return this.videoSrc};Stream.prototype.removeVideo=function(parentElement){if(typeof parentElement==="string"){document.getElementById(parentElement).removeChild(this.video)}else if(parentElement instanceof Element){parentElement.removeChild(this.video)}else if(!parentElement){if(document.getElementById(this.parentId)){document.getElementById(this.parentId).removeChild(this.video)}}};Stream.prototype.getVideoElement=function(){return this.video};Stream.prototype.setVideoElement=function(video){this.video=video};Stream.prototype.getRecvVideo=function(){return this.recvVideo};Stream.prototype.getRecvAudio=function(){return this.recvAudio};Stream.prototype.subscribeToMyRemote=function(){this.showMyRemote=true};Stream.prototype.displayMyRemote=function(){return this.showMyRemote};Stream.prototype.mirrorLocalStream=function(wr){this.showMyRemote=true;this.localMirrored=true;if(wr){this.wrStream=wr;this.emitSrcEvent(this.wrStream)}};Stream.prototype.isLocalMirrored=function(){return this.localMirrored};Stream.prototype.getChannelName=function(){return this.getId()+"_"+this.chanId++};Stream.prototype.isDataChannelEnabled=function(){return this.dataChannel};Stream.prototype.isDataChannelOpened=function(){return this.dataChannelOpened};Stream.prototype.onDataChannelOpen=function(event){console.log("Data channel is opened");this.dataChannelOpened=true};Stream.prototype.onDataChannelClosed=function(event){console.log("Data channel is closed");this.dataChannelOpened=false};Stream.prototype.sendData=function(data){if(this.wp===undefined){throw new Error("WebRTC peer has not been created yet")}if(!this.dataChannelOpened){throw new Error("Data channel is not opened")}console.log("Sending through data channel: "+data);this.wp.send(data)};Stream.prototype.getWrStream=function(){return this.wrStream};Stream.prototype.getWebRtcPeer=function(){return this.wp};Stream.prototype.addEventListener=function(eventName,listener){this.ee.addListener(eventName,listener)};Stream.prototype.addOnceEventListener=function(eventName,listener){this.ee.addOnceListener(eventName,listener)};Stream.prototype.removeListener=function(eventName){this.ee.removeAllListeners(eventName)};Stream.prototype.showSpinner=function(spinnerParentId){var progress=document.createElement("div");progress.id="progress-"+this.getId();progress.style.background="center transparent url('img/spinner.gif') no-repeat";var spinnerParent=document.getElementById(spinnerParentId);if(spinnerParent){spinnerParent.appendChild(progress)}};Stream.prototype.hideSpinner=function(spinnerId){spinnerId=spinnerId===undefined?this.getId():spinnerId;hide("progress-"+spinnerId)};Stream.prototype.playOnlyVideo=function(parentElement,thumbnailId){this.video=document.createElement("video");this.video.id="native-video-"+this.getId();this.video.autoplay=true;this.video.controls=false;this.video.src=this.videoSrc;this.videoElements.push({thumb:thumbnailId,video:this.video});if(this.local){this.video.muted=true}else{this.video.title=this.getId()}if(typeof parentElement==="string"){this.parentId=parentElement;var parentElementDom=document.getElementById(parentElement);if(parentElementDom){this.video=parentElementDom.appendChild(this.video);this.ee.emitEvent("video-element-created-by-stream",[{element:this.video}]);this.isVideoELementCreated=true}}else{this.parentId=parentElement.id;this.video=parentElement.appendChild(this.video)}this.ee.emitEvent("stream-created-by-publisher");this.isReady=true;return this.video};Stream.prototype.playThumbnail=function(thumbnailId){var container=document.createElement("div");container.className="participant";container.id=this.getId();var thumbnail=document.getElementById(thumbnailId);if(thumbnail){thumbnail.appendChild(container)}this.elements.push(container);var name=document.createElement("div");container.appendChild(name);var userName=this.getId().replace("_webcam","");if(userName.length>=16){userName=userName.substring(0,16)+"..."}name.appendChild(document.createTextNode(userName));name.id="name-"+this.getId();name.className="name";name.title=this.getId();this.showSpinner(thumbnailId);return this.playOnlyVideo(container,thumbnailId)};Stream.prototype.getIdInParticipant=function(){return this.id};Stream.prototype.getParticipant=function(){return this.connection};Stream.prototype.getId=function(){if(this.connection){return this.connection.connectionId+"_"+this.id}else{return this.id+"_webcam"}};Stream.prototype.getRTCPeerConnection=function(){return this.getWebRtcPeer().peerConnection};Stream.prototype.requestCameraAccess=function(callback){var _this=this;this.connection.addStream(this);var constraints=this.mediaConstraints;this.userMediaHasVideo(function(hasVideo){if(!hasVideo){constraints.video=false;_this.sendVideo=false;_this.audioOnly=true;_this.requestCameraAccesAux(constraints,callback)}else{_this.requestCameraAccesAux(constraints,callback)}})};Stream.prototype.requestCameraAccesAux=function(constraints,callback){var _this=this;navigator.mediaDevices.getUserMedia(constraints).then(function(userStream){_this.cameraAccessSuccess(userStream,callback)}).catch(function(error){navigator.mediaDevices.getUserMedia({audio:true,video:false}).then(function(userStream){constraints.video=false;_this.sendVideo=false;_this.audioOnly=true;_this.cameraAccessSuccess(userStream,callback)}).catch(function(error){_this.accessIsDenied=true;_this.accessIsAllowed=false;_this.ee.emitEvent("access-denied-by-publisher");console.error("Access denied",error);callback(error,_this)})})};Stream.prototype.cameraAccessSuccess=function(userStream,callback){this.accessIsAllowed=true;this.accessIsDenied=false;this.ee.emitEvent("access-allowed-by-publisher");if(userStream.getAudioTracks()[0]!=null){userStream.getAudioTracks()[0].enabled=this.sendAudio}if(userStream.getVideoTracks()[0]!=null){userStream.getVideoTracks()[0].enabled=this.sendVideo}this.wrStream=userStream;this.emitSrcEvent(this.wrStream);callback(undefined,this)};Stream.prototype.userMediaHasVideo=function(callback){navigator.mediaDevices.enumerateDevices().then(function(mediaDevices){var videoInput=mediaDevices.filter(function(deviceInfo){return deviceInfo.kind==="videoinput"})[0];callback(videoInput!=null)})};Stream.prototype.publishVideoCallback=function(error,sdpOfferParam,wp){var _this=this;if(error){return console.error("(publish) SDP offer error: "+JSON.stringify(error))}console.log("Sending SDP offer to publish as "+this.getId(),sdpOfferParam);this.openVidu.sendRequest("publishVideo",{sdpOffer:sdpOfferParam,doLoopback:this.displayMyRemote()||false,audioOnly:this.audioOnly},function(error,response){if(error){console.error("Error on publishVideo: "+JSON.stringify(error))}else{_this.room.emitEvent("stream-published",[{stream:_this}]);_this.processSdpAnswer(response.sdpAnswer)}})};Stream.prototype.startVideoCallback=function(error,sdpOfferParam,wp){var _this=this;if(error){return console.error("(subscribe) SDP offer error: "+JSON.stringify(error))}console.log("Sending SDP offer to subscribe to "+this.getId(),sdpOfferParam);this.openVidu.sendRequest("receiveVideoFrom",{sender:this.getId(),sdpOffer:sdpOfferParam},function(error,response){if(error){console.error("Error on recvVideoFrom: "+JSON.stringify(error))}else{_this.processSdpAnswer(response.sdpAnswer)}})};Stream.prototype.initWebRtcPeer=function(sdpOfferCallback){var _this=this;if(this.local){var userMediaConstraints={audio:this.sendAudio,video:this.sendVideo};var options={videoStream:this.wrStream,mediaConstraints:userMediaConstraints,onicecandidate:this.connection.sendIceCandidate.bind(this.connection)};if(this.dataChannel){options.dataChannelConfig={id:this.getChannelName(),onopen:this.onDataChannelOpen,onclose:this.onDataChannelClosed};options.dataChannels=true}if(this.displayMyRemote()){this.wp=new kurentoUtils.WebRtcPeer.WebRtcPeerSendrecv(options,function(error){if(error){return console.error(error)}_this.wp.generateOffer(sdpOfferCallback.bind(_this))})}else{this.wp=new kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(options,function(error){if(error){return console.error(error)}_this.wp.generateOffer(sdpOfferCallback.bind(_this))})}}else{var offerConstraints={audio:this.recvAudio,video:!this.audioOnly};console.log("Constraints of generate SDP offer (subscribing)",offerConstraints);var options={onicecandidate:this.connection.sendIceCandidate.bind(this.connection),mediaConstraints:offerConstraints};this.wp=new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(options,function(error){if(error){return console.error(error)}_this.wp.generateOffer(sdpOfferCallback.bind(_this))})}console.log("Waiting for SDP offer to be generated ("+(this.local?"local":"remote")+" peer: "+this.getId()+")")};Stream.prototype.publish=function(){var _this=this;if(this.isReady){this.initWebRtcPeer(this.publishVideoCallback)}else{this.ee.once("stream-ready",function(streamEvent){_this.publish()})}};Stream.prototype.subscribe=function(){this.initWebRtcPeer(this.startVideoCallback)};Stream.prototype.processSdpAnswer=function(sdpAnswer){var _this=this;var answer=new RTCSessionDescription({type:"answer",sdp:sdpAnswer});console.log(this.getId()+": set peer connection with recvd SDP answer",sdpAnswer);var participantId=this.getId();var pc=this.wp.peerConnection;pc.setRemoteDescription(answer,function(){if(!_this.local||_this.displayMyRemote()){_this.wrStream=pc.getRemoteStreams()[0];console.log("Peer remote stream",_this.wrStream);if(_this.wrStream!=undefined){_this.emitSrcEvent(_this.wrStream);_this.speechEvent=kurentoUtils.WebRtcPeer.hark(_this.wrStream,{threshold:_this.room.thresholdSpeaker});_this.speechEvent.on("speaking",function(){_this.room.addParticipantSpeaking(participantId);_this.room.emitEvent("stream-speaking",[{participantId:participantId}])});_this.speechEvent.on("stopped_speaking",function(){_this.room.removeParticipantSpeaking(participantId);_this.room.emitEvent("stream-stopped-speaking",[{participantId:participantId}])})}for(var _i=0,_a=_this.videoElements;_i<_a.length;_i++){var videoElement=_a[_i];var thumbnailId=videoElement.thumb;var video=videoElement.video;video.src=URL.createObjectURL(_this.wrStream);video.onplay=function(){console.log(_this.getId()+": "+"Video playing")}}_this.room.emitEvent("stream-subscribed",[{stream:_this}])}},function(error){console.error(_this.getId()+": Error setting SDP to the peer connection: "+JSON.stringify(error))})};Stream.prototype.unpublish=function(){if(this.wp){this.wp.dispose()}else{if(this.wrStream){this.wrStream.getAudioTracks().forEach(function(track){track.stop&&track.stop()});this.wrStream.getVideoTracks().forEach(function(track){track.stop&&track.stop()})}}if(this.speechEvent){this.speechEvent.stop()}console.log(this.getId()+": Stream '"+this.id+"' unpublished")};Stream.prototype.dispose=function(){function disposeElement(element){if(element&&element.parentNode){element.parentNode.removeChild(element)}}this.elements.forEach(function(e){return disposeElement(e)});disposeElement("progress-"+this.getId());if(this.wp){this.wp.dispose()}else{if(this.wrStream){this.wrStream.getAudioTracks().forEach(function(track){track.stop&&track.stop()});this.wrStream.getVideoTracks().forEach(function(track){track.stop&&track.stop()})}}if(this.speechEvent){this.speechEvent.stop()}console.log(this.getId()+": Stream '"+this.id+"' disposed")};return Stream}();exports.Stream=Stream},{"kurento-utils":19,"webrtc-adapter":91,"wolfy87-eventemitter":102}],113:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+")");err.context=er;throw err}}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args)}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-- >0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else if(listeners){while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))return 1;else if(evlistener)return evlistener.length}return 0};EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type)};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],114:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}(function(){try{if(typeof setTimeout==="function"){cachedSetTimeout=setTimeout}else{cachedSetTimeout=defaultSetTimout}}catch(e){cachedSetTimeout=defaultSetTimout}try{if(typeof clearTimeout==="function"){cachedClearTimeout=clearTimeout}else{cachedClearTimeout=defaultClearTimeout}}catch(e){cachedClearTimeout=defaultClearTimeout}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[]};process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}]},{},[104]);